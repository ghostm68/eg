<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WordStar Nexus: Legacy Mode</title>
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

<style>
  :root {
    --bg-color: #000000;
    --text-main: #cccccc;
    --text-dim: #888888;
    --accent-red: #cc0000;
    --bar-bg: #b0b0b0;
    --bar-text: #000000;
  }

  * { box-sizing: border-box; }

  body, html {
    margin: 0;
    padding: 0;
    font-family: 'VT323', monospace;
    background-color: var(--bg-color);
    color: var(--text-main);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    font-size: 20px;
    user-select: none;
  }

  /* Scanline CRT Effect */
  .crt::before {
    content: " ";
    display: block;
    position: absolute;
    top: 0; left: 0; bottom: 0; right: 0;
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
    z-index: 999;
    background-size: 100% 2px, 3px 100%;
    pointer-events: none;
  }

  /* --- 1. TOP HEADER BAR --- */
  #header-bar {
    background-color: var(--bar-bg);
    color: var(--bar-text);
    padding: 0 10px;
    height: 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* --- 2. THE MASSIVE EDIT MENU --- */
  #edit-menu-container {
    padding: 5px 10px;
    border-bottom: 1px solid var(--text-dim);
  }

  .dos-box {
    border: 4px double var(--text-main);
    position: relative;
    padding: 10px 5px;
    margin-top: 10px;
  }

  .box-title {
    position: absolute;
    top: -12px;
    left: 50%;
    transform: translateX(-50%);
    background-color: var(--bg-color);
    padding: 0 10px;
    font-weight: bold;
    color: var(--text-main);
  }

  .menu-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    font-size: 0.85rem;
    line-height: 1.2;
  }

  .col-header {
    color: var(--accent-red);
    font-weight: bold;
    margin-bottom: 5px;
    text-decoration: underline;
    text-align: center;
  }

  .cmd-row { display: flex; white-space: pre; }
  .cmd-key { color: #fff; font-weight: bold; margin-right: 5px; }
  .cmd-desc { color: var(--text-dim); }

  /* --- 3. THE RULER --- */
  #ruler-line {
    padding: 0 10px;
    color: var(--text-dim);
    font-size: 1rem;
    white-space: pre;
    overflow: hidden;
  }

  /* --- 4. THE EDITOR --- */
  #editor {
    flex-grow: 1;
    background-color: transparent;
    color: var(--text-main);
    border: none;
    padding: 5px 10px;
    font-family: 'VT323', monospace;
    font-size: 1.2rem;
    line-height: 1.2;
    resize: none;
    outline: none;
    white-space: pre-wrap;
    cursor: text; 
    user-select: text;
    overflow-y: auto;
  }
  
  #editor::-webkit-scrollbar { width: 0px; background: transparent; }

  /* --- 5. THE F-KEY FOOTER --- */
  #f-key-bar {
    display: flex;
    background-color: var(--bar-bg);
    height: 35px;
    align-items: center;
    border-top: 1px solid #000;
  }
  
  .f-key {
    flex: 1;
    color: var(--bar-text);
    padding: 0 5px;
    font-size: 0.9rem;
    border-right: 1px solid #555;
    white-space: nowrap;
    overflow: hidden;
    cursor: pointer;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.1s;
  }
  .f-key b { font-weight: 900; margin-right: 4px; color: #fff; }
  .f-key:hover { background-color: var(--accent-red); color: white; }
  .f-key:active { background-color: #fff; color: #000; }

</style>
</head>
<body class="crt">

  <!-- HEADER -->
  <div id="header-bar">
    <span id="file-path">C:NEXUS.DOC</span>
    <span id="doc-stats">P01 L01 C01</span>
    <span id="flags">INSERT ON</span>
  </div>

  <!-- MENU BLOCK -->
  <div id="edit-menu-container">
    <div class="dos-box">
      <div class="box-title">= E D I T &nbsp; M E N U =</div>
      <div class="menu-grid">
        <div>
          <div class="col-header">CURSOR</div>
          <div class="cmd-row"><span class="cmd-key">^E</span><span class="cmd-desc">up</span></div>
          <div class="cmd-row"><span class="cmd-key">^X</span><span class="cmd-desc">down</span></div>
          <div class="cmd-row"><span class="cmd-key">^S</span><span class="cmd-desc">left</span></div>
          <div class="cmd-row"><span class="cmd-key">^D</span><span class="cmd-desc">right</span></div>
          <div class="cmd-row"><span class="cmd-key">^A</span><span class="cmd-desc">word left</span></div>
          <div class="cmd-row"><span class="cmd-key">^F</span><span class="cmd-desc">word right</span></div>
        </div>
        <div>
          <div class="col-header">SCROLL</div>
          <div class="cmd-row"><span class="cmd-key">^W</span><span class="cmd-desc">up</span></div>
          <div class="cmd-row"><span class="cmd-key">^Z</span><span class="cmd-desc">down</span></div>
        </div>
        <div>
          <div class="col-header">ERASE</div>
          <div class="cmd-row"><span class="cmd-key">^G</span><span class="cmd-desc">char</span></div>
          <div class="cmd-row"><span class="cmd-key">^T</span><span class="cmd-desc">word</span></div>
          <div class="cmd-row"><span class="cmd-key">^Y</span><span class="cmd-desc">line</span></div>
          <div class="cmd-row"><span class="cmd-key">^U</span><span class="cmd-desc">undo</span></div>
        </div>
        <div>
          <div class="col-header">OTHER</div>
          <div class="cmd-row"><span class="cmd-key">^J</span><span class="cmd-desc">help</span></div>
          <div class="cmd-row"><span class="cmd-key">^V</span><span class="cmd-desc">insert</span></div>
          <div class="cmd-row"><span class="cmd-key">^L</span><span class="cmd-desc">find</span></div>
          <div class="cmd-row"><span class="cmd-key">^I</span><span class="cmd-desc">tab</span></div>
        </div>
        <div>
          <div class="col-header">MENUS</div>
          <div class="cmd-row"><span class="cmd-key">^K</span><span class="cmd-desc">save</span></div>
          <div class="cmd-row"><span class="cmd-key">^P</span><span class="cmd-desc">print</span></div>
          <div class="cmd-row"><span class="cmd-key">^Q</span><span class="cmd-desc">quick</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- RULER -->
  <div id="ruler-line">L----!----!----!----!----!----!----!----!----!----!----!----!----R</div>

  <!-- EDITOR - NOW CONTENTEDITABLE -->
  <div id="editor" contenteditable="true" spellcheck="false">
The quick brown fox jumped over the lazy dog.

Some <strong>bold</strong> text
Some <u>underlined</u> text
Some <em>italic</em> text

(This is the Legacy Interface with working commands!)
  </div>

  <!-- FOOTER -->
  <div id="f-key-bar">
    <div class="f-key" onclick="handleCommand('help')"><b>F1</b>HELP</div>
    <div class="f-key" onclick="handleCommand('lorem')"><b>F2</b>LOREM</div>
    <div class="f-key" onclick="handleCommand('underline')"><b>F3</b>UNDLIN</div>
    <div class="f-key" onclick="handleCommand('bold')"><b>F4</b>BOLD</div>
    <div class="f-key" onclick="handleCommand('delLine')"><b>F5</b>DEL LIN</div>
    <div class="f-key" onclick="handleCommand('delWord')"><b>F6</b>DEL WRD</div>
    <div class="f-key" onclick="handleCommand('find')"><b>F7</b>FIND</div>
    <div class="f-key" onclick="handleCommand('ruler')"><b>F8</b>RULER</div>
    <div class="f-key" onclick="handleCommand('save')"><b>F9</b>SAVE</div>
    <div class="f-key" onclick="handleCommand('exit')"><b>F10</b>CLEAR</div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', (event) => {
  const editor = document.getElementById('editor');
  const docStats = document.getElementById('doc-stats');
  const flags = document.getElementById('flags');
  const rulerLine = document.getElementById('ruler-line');
  const filePath = document.getElementById('file-path');
  
  let insertMode = true;

  // --- COMMAND SYSTEM (FROM YOUR ORIGINAL) ---
  window.handleCommand = function(command) {
    switch(command) {
      case 'bold':
        document.execCommand('bold');
        break;
      case 'italic':
        document.execCommand('italic');
        break;
      case 'underline':
        document.execCommand('underline');
        break;
      case 'delLine':
        deleteLine();
        break;
      case 'delWord':
        deleteWord();
        break;
      case 'find':
        findReplace();
        break;
      case 'ruler':
        rulerLine.style.display = (rulerLine.style.display === 'none' ? 'block' : 'none');
        break;
      case 'save':
        saveDocument();
        break;
      case 'lorem':
        insertLorem();
        break;
      case 'help':
        showStats();
        break;
      case 'exit':
        if(confirm("EXIT: Clear current document buffer?")) {
          editor.innerHTML = "";
        }
        break;
      default:
        alert(`${command} command activated`);
    }
    updateUI();
  }

  // --- KEYBOARD HANDLER (FROM YOUR ORIGINAL) ---
  editor.addEventListener('keydown', function(e) {
    if (e.ctrlKey) {
      const key = e.key.toUpperCase();
      e.preventDefault();
      e.stopPropagation();
      
      // Map Ctrl keys to commands
      const keyMap = {
        'B': 'bold',
        'S': 'underline',  // WordStar used ^S for underline
        'Y': 'delLine',
        'T': 'delWord',
        'D': 'right',
        'E': 'up',
        'X': 'down',
        'S': 'left',
        'A': 'wordLeft',
        'F': 'wordRight',
        'G': 'delChar',
        'H': 'backspace',
        'I': 'tab',
        'L': 'find',
        'P': 'print',
        'K': 'save',
        'J': 'help',
        'V': 'toggleMode'
      };
      
      if (keyMap[key]) {
        if (keyMap[key] === 'right' || keyMap[key] === 'left' || keyMap[key] === 'up' || keyMap[key] === 'down') {
          // Handle cursor movement
          moveCursor(keyMap[key]);
        } else if (keyMap[key] === 'wordLeft' || keyMap[key] === 'wordRight') {
          moveWord(keyMap[key]);
        } else if (keyMap[key] === 'delChar') {
          document.execCommand('delete');
        } else if (keyMap[key] === 'backspace') {
          document.execCommand('delete', false, true); // Backspace
        } else if (keyMap[key] === 'tab') {
          document.execCommand('insertText', false, '\t');
        } else if (keyMap[key] === 'print') {
          window.print();
        } else if (keyMap[key] === 'toggleMode') {
          insertMode = !insertMode;
          updateUI();
        } else {
          handleCommand(keyMap[key]);
        }
      }
    }
    
    // Handle F-Keys
    else if (e.key.startsWith('F')) {
      e.preventDefault();
      
      const fKeyMap = {
        'F1': 'help',
        'F2': 'lorem',
        'F3': 'underline',
        'F4': 'bold',
        'F5': 'delLine',
        'F6': 'delWord',
        'F7': 'find',
        'F8': 'ruler',
        'F9': 'save',
        'F10': 'exit'
      };
      
      if (fKeyMap[e.key]) {
        handleCommand(fKeyMap[e.key]);
      }
    }
    
    setTimeout(updateUI, 0);
  });

  // --- UTILITY FUNCTIONS ---
  function updateUI() {
    const selection = window.getSelection();
    const range = selection.getRangeAt(0);
    const text = editor.innerText;
    const cursorPos = range.startOffset;
    
    const lines = text.substr(0, cursorPos).split("\n");
    const currentLine = lines.length;
    const currentCol = lines[lines.length-1].length + 1;
    const page = Math.floor(currentLine / 55) + 1;

    docStats.innerText = `P${page.toString().padStart(2,'0')} L${currentLine.toString().padStart(2,'0')} C${currentCol.toString().padStart(2,'0')}`;
    flags.innerText = insertMode ? "INSERT ON" : "OVERWRITE";
    
    // Visual feedback for mode
    editor.style.backgroundColor = insertMode ? '#000' : '#0a0a0a';
  }

  function moveCursor(direction) {
    const selection = window.getSelection();
    const range = selection.getRangeAt(0);
    
    switch(direction) {
      case 'right':
        range.setStart(range.startContainer, Math.min(range.startOffset + 1, range.endOffset));
        break;
      case 'left':
        range.setStart(range.startContainer, Math.max(range.startOffset - 1, 0));
        break;
      case 'up':
        // Simulate up arrow
        const upEvent = new KeyboardEvent('keydown', { key: 'ArrowUp' });
        editor.dispatchEvent(upEvent);
        return;
      case 'down':
        // Simulate down arrow
        const downEvent = new KeyboardEvent('keydown', { key: 'ArrowDown' });
        editor.dispatchEvent(downEvent);
        return;
    }
    
    range.collapse(true);
    selection.removeAllRanges();
    selection.addRange(range);
  }

  function moveWord(direction) {
    const selection = window.getSelection();
    const range = selection.getRangeAt(0);
    const textNode = range.startContainer;
    const text = textNode.textContent;
    let pos = range.startOffset;
    
    if (direction === 'wordLeft') {
      while (pos > 0 && /\s/.test(text[pos-1])) pos--;
      while (pos > 0 && !/\s/.test(text[pos-1])) pos--;
    } else {
      while (pos < text.length && /\s/.test(text[pos])) pos++;
      while (pos < text.length && !/\s/.test(text[pos])) pos++;
    }
    
    range.setStart(textNode, pos);
    range.collapse(true);
    selection.removeAllRanges();
    selection.addRange(range);
  }

  function deleteLine() {
    const selection = window.getSelection();
    const range = selection.getRangeAt(0);
    const textNode = range.startContainer;
    const text = textNode.textContent;
    const pos = range.startOffset;
    
    const lineStart = text.lastIndexOf('\n', pos - 1) + 1;
    const lineEnd = text.indexOf('\n', pos);
    const actualEnd = (lineEnd === -1) ? text.length : lineEnd + 1;
    
    range.setStart(textNode, lineStart);
    range.setEnd(textNode, actualEnd);
    range.deleteContents();
    
    // Place cursor at start of deleted line
    range.setStart(textNode, lineStart);
    range.collapse(true);
    selection.removeAllRanges();
    selection.addRange(range);
  }

  function deleteWord() {
    const selection = window.getSelection();
    const range = selection.getRangeAt(0);
    const textNode = range.startContainer;
    const text = textNode.textContent;
    let pos = range.startOffset;
    
    // Find end of current word
    while (pos < text.length && !/\s/.test(text[pos])) pos++;
    // Find end of whitespace
    while (pos < text.length && /\s/.test(text[pos])) pos++;
    
    range.setEnd(textNode, pos);
    range.deleteContents();
    
    // Place cursor at deletion point
    range.collapse(true);
    selection.removeAllRanges();
    selection.addRange(range);
  }

  function findReplace() {
    const find = prompt("FIND WHAT?");
    if(find) {
      const rep = prompt("REPLACE WITH?");
      if(rep !== null) {
        editor.innerHTML = editor.innerHTML.replace(new RegExp(find, 'g'), rep);
        updateUI();
      }
    }
  }

  function saveDocument() {
    const titleObj = document.getElementById('file-path');
    const oldTitle = titleObj.innerText;
    
    titleObj.innerText = "* SAVING *";
    titleObj.style.backgroundColor = "var(--accent-red)";
    titleObj.style.color = "black";

    const blob = new Blob([editor.innerHTML], {type:'text/html'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'NEXUS.DOC';
    a.click();
    
    setTimeout(() => {
      titleObj.innerText = oldTitle;
      titleObj.style.backgroundColor = "";
      titleObj.style.color = "";
    }, 1000);
  }

  function insertLorem() {
    const loremText = "\n\n(LOREM IPSUM)\nThe quick brown fox jumped over the lazy dog. Pack my box with five dozen liquor jugs. How vexingly quick daft zebras jump!\n";
    document.execCommand('insertText', false, loremText);
    updateUI();
  }

  function showStats() {
    const text = editor.innerText;
    const words = text.trim().split(/\s+/).filter(w=>w).length;
    const chars = text.length;
    const lines = text.split('\n').length;
    
    alert(`*** WORDSTAR DIAGNOSTICS ***\n\nWords: ${words}\nChars: ${chars}\nLines: ${lines}\nMode: ${insertMode ? 'INSERT' : 'OVERWRITE'}`);
  }

  // Initialize
  updateUI();
  
  // Add cursor tracking
  editor.addEventListener('click', updateUI);
  editor.addEventListener('keyup', updateUI);
  editor.addEventListener('input', updateUI);
  
  // Add blinking cursor effect
  let cursorVisible = true;
  setInterval(() => {
    editor.style.caretColor = cursorVisible ? 'var(--accent-red)' : 'transparent';
    cursorVisible = !cursorVisible;
  }, 500);
});
</script>

</body>
</html>
