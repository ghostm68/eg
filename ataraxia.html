<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1024, initial-scale=1.0">
  <title>Ataraxia</title>
  
  <!-- MapLibre GL CSS -->
  <link href='https://unpkg.com/maplibre-gl@5.0.1/dist/maplibre-gl.css' rel='stylesheet' />
  
  <!-- Deck.gl Script -->
  <script src="https://unpkg.com/deck.gl@8.9.33/dist.min.js"></script>
  
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Olivetti', 'Courier New', monospace;
      height: 100vh;
      overflow: hidden;
      background: #1a1a1a;
      color: #e0e0e0;
    }

    /* Import Fonts */
    @font-face { font-family: 'Olivetti'; src: url('https://cdn.jsdelivr.net/gh/ghostm68/inktwo/fonts/olivetti/olivetti-typewriter-regular.otf') format('opentype'); font-weight: normal; }
    @font-face { font-family: 'Olivetti'; src: url('https://cdn.jsdelivr.net/gh/ghostm68/inktwo/fonts/olivetti/olivetti-typewriter-bold.otf') format('opentype'); font-weight: bold; }

    .app-container { display: flex; flex-direction: column; height: 100vh; }
    .app-header { background: #2a2a2a; color: #e0e0e0; padding: 10px 15px; text-align: center; border-bottom: 1px solid #444; z-index: 1000; flex-shrink: 0; }
    .main-title { font-family: 'Olivetti', 'Courier New', monospace; font-size: 1.8em; margin: 0; }
    .subtitle { font-family: 'Olivetti', 'Courier New', monospace; font-size: 0.9em; opacity: 0.9; }

    /* Main Content */
    .main-content { display: flex; flex: 1; overflow: hidden; flex-direction: row-reverse; }
    .map-section { flex: 1; position: relative; border-left: 1px solid #444; }
    #map { width: 100%; height: 100%; background: #1a1a1a; }
    .maplibregl-ctrl-attrib, .maplibregl-ctrl-logo { display: none !important; }
    
    .map-controls { position: absolute; top: 10px; right: 10px; z-index: 500; display: flex; gap: 5px; }
    .map-btn { background: rgba(42, 42, 42, 0.9); border: 1px solid #ff0000; border-radius: 5px; padding: 8px 12px; cursor: pointer; font-family: 'Olivetti', 'Courier New', monospace; font-size: 0.8em; color: #e0e0e0; }

    /* Writing Section */
    .writing-section { flex: 1; display: flex; flex-direction: column; background: #2a2a2a; }

    /* STEALTH MODE HEADER: No cursor: pointer, no hover effects */
    .writing-header {
      background: #1a1a1a;
      color: #e0e0e0;
      padding: 10px 15px;
      font-family: 'Olivetti', 'Courier New', monospace;
      font-weight: bold;
      flex-shrink: 0;
      border-bottom: 1px solid #444;
      cursor: text; /* Looks like normal text */
    }

    #writing-area { flex: 1; width: 100%; border: none; padding: 15px; background: #1a1a1a; resize: none; outline: none; font-family: 'Olivetti', 'Courier New', monospace; font-size: 14px; line-height: 1.6; color: #e0e0e0; }
    .writing-tools { background: #1a1a1a; padding: 10px; display: flex; gap: 8px; flex-wrap: wrap; flex-shrink: 0; border-top: 1px solid #444; }
    .writing-tools button { padding: 8px 12px; background: #2a2a2a; border: 1px solid #ff0000; border-radius: 4px; cursor: pointer; font-family: 'Olivetti', 'Courier New', monospace; font-size: 0.8em; color: #e0e0e0; flex: 1; min-width: 120px; }

    /* Modals */
    #location-inspiration, #settings-panel { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px; background: #2a2a2a; border: 2px solid #ff0000; border-radius: 8px; padding: 20px; z-index: 1001; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); display: none; }
    #settings-panel { max-height: 80vh; overflow-y: auto; }
    .settings-group { margin-bottom: 15px; }
    .settings-group label { display: block; margin-bottom: 5px; color: #e0e0e0; font-family: 'Olivetti', 'Courier New', monospace; }
    .settings-group select, .settings-group input { width: 100%; padding: 8px; border: 1px solid #444; border-radius: 4px; background: #1a1a1a; color: #e0e0e0; font-family: 'Olivetti', 'Courier New', monospace; }
    input[type="range"] { accent-color: #ff0000; }
    .close-btn, #use-inspiration { background: #ff0000; color: #1a1a1a; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-top: 10px; font-family: 'Olivetti', 'Courier New', monospace; font-weight: bold; width: 100%; }

    /* Slide Menu & Deck.gl Styles */
    .slide-menu { position: fixed; top: 0; right: -100%; width: 100%; height: 100vh; z-index: 9999; transition: right 0.6s cubic-bezier(0.16, 1, 0.3, 1); background: #000; overflow: hidden; }
    .slide-menu.active { right: 0; }
    #deck-map-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    
    .menu-overlay { position: relative; z-index: 2; width: 100%; height: 100%; background: linear-gradient(90deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.5) 40%, rgba(0,0,0,0) 100%); color: white; pointer-events: none; }
    .menu-inner-text { pointer-events: auto; padding: 80px 60px; max-width: 600px; }
    .menu-inner-text h2 { font-size: 2.5rem; margin-bottom: 10px; color: #ff0000; font-family: 'Olivetti', 'Courier New', monospace; }
    
    .menu-close-btn { position: absolute; top: 30px; right: 40px; font-size: 3rem; background: none; border: none; color: #ff0000; cursor: pointer; pointer-events: auto; opacity: 0.8; font-family: 'Olivetti', 'Courier New', monospace; transition: opacity 0.2s; }
    .menu-close-btn:hover { opacity: 1; text-shadow: 0 0 10px #ff0000; }

    /* Custom Slider Toggle */
    .slide-toggle { display: flex; align-items: center; cursor: pointer; pointer-events: auto; font-family: 'Olivetti', 'Courier New', monospace; }
    .slide-toggle input { display: none; }
    .slider { width: 50px; height: 26px; background-color: #333; border-radius: 34px; position: relative; transition: .4s; margin-right: 15px; border: 1px solid #555; }
    .slider:before { content: ""; position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: #888; border-radius: 50%; transition: .4s; }
    input:checked + .slider { background-color: #ff0000; border-color: #ff0000; }
    input:checked + .slider:before { transform: translateX(24px); background-color: white; }

    @media (max-width: 768px) {
      .main-content { flex-direction: column; }
      .writing-section { order: 1; flex: 0.6; }
      .map-section { order: 2; flex: 0.4; }
    }
    .location-pin { background: rgba(42, 42, 42, 0.9); color: #e0e0e0; padding: 5px 10px; border-radius: 15px; font-family: 'Olivetti', 'Courier New', monospace; font-size: 12px; border: 2px solid #ff0000; }
    
    /* Override for the font-size value span */
    #font-size-value { color: #ff0000; }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="app-header">
      <div class="main-title">Ataraxia</div>
      <div class="subtitle">World Building Sanctuary</div>
    </div>

    <div class="main-content">
      <div class="map-section">
        <div id="map"></div>
        <div class="map-controls">
          <button class="map-btn" id="settings-btn">Settings</button>
          <button class="map-btn" id="inspiration-btn">Get Inspired</button>
        </div>
      </div>

      <div class="writing-section">
        <!-- STEALTH HEADER: Looks inert, is actually the trigger -->
        <div class="writing-header">
          üìù Your World Awaits...
        </div>
        <textarea id="writing-area" placeholder="Begin your world-building journey here...&#10;&#10;Click 'Get Inspired' for location prompts, or create your own stories."></textarea>
        <div class="writing-tools">
          <button id="generate-poem">Generate Poem</button>
          <button id="save-location">Pin to Map</button>
          <button id="clear-text">Clear</button>
          <button id="export-text">Export Text</button>
        </div>
      </div>
    </div>

    <!-- Modals -->
    <div id="location-inspiration">
      <h3 style="color: #e0e0e0; font-family: 'Olivetti', 'Courier New', monospace;">üìç Location Inspiration</h3>
      <p id="location-info"></p>
      <button id="use-inspiration">Use in Writing</button>
      <button class="close-btn" id="close-inspiration">Close</button>
    </div>

    <div id="settings-panel">
      <h3 style="color: #e0e0e0; font-family: 'Olivetti', 'Courier New', monospace;">Ataraxia Settings</h3>
      <div class="settings-group">
        <label for="map-theme">Map Theme:</label>
        <select id="map-theme">
          <option value="dark" selected>Dark</option>
          <option value="light">Light</option>
          <option value="satellite">Satellite</option>
          <option value="terrain">Terrain</option>
        </select>
      </div>
      <div class="settings-group">
        <label for="font-family">Font:</label>
        <select id="font-family">
          <option value="olivetti-typewriter-regular.otf" selected>Olivetti Typewriter</option>
          <option value="olivetti-typewriter-bold.otf">Olivetti Typewriter Bold</option>
        </select>
      </div>
      <div class="settings-group">
        <label for="font-size">Font Size: <span id="font-size-value" style="color: #00aaff;">14px</span></label>
        <input type="range" id="font-size" min="12" max="24" value="14">
      </div>
      <button class="close-btn" id="close-settings">Apply & Close</button>
    </div>
  </div>

  <!-- SLIDE OUT MENU (The Sprawl / Vancouver) -->
  <div id="world-menu" class="slide-menu">
    <div id="deck-map-container"></div>
    <div class="menu-overlay">
        <button class="menu-close-btn" id="close-slide-menu">&times;</button>
        
        <div class="menu-inner-text">
            <h2>The Sprawl</h2>
            <p style="font-size: 1.1em; line-height: 1.6;">
                Vancouver City. <br>
                <span style="font-size:0.8em; opacity:0.7;">Navigate: Left Click to Pan, Right Click to Rotate, Scroll to Zoom. mouseless; 
To Tilt & Rotate: Hold Shift and press the Arrow Keys.Shift + Up = Tilt the buildings flat/up.Shift + Left/Right = Spin the city.
To Zoom: Just press + or - on the keyboard...</span>
            </p>
            
            <!-- MAP CONTROLS -->
            <div style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">
                <!-- Toggle Map -->
                <label class="slide-toggle">
                    <input type="checkbox" id="deck-map-toggle" checked>
                    <span class="slider"></span>
                    <span class="label-text">Visualization Active</span>
                </label>

                <!-- Height Slider -->
                <div class="settings-group" style="margin-top: 20px;">
                    <label>Building Height Value</label>
                    <input type="range" id="height-slider" min="0" max="100" value="4" step="1">
                </div>

                <!-- Opacity Slider -->
                <div class="settings-group">
                    <label>Opacity</label>
                    <input type="range" id="opacity-slider" min="0.1" max="1" value="0.8" step="0.1">
                </div>
            </div>
        </div>
    </div>
  </div>

  <script src='https://unpkg.com/maplibre-gl@5.0.1/dist/maplibre-gl.js'></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // --- ORIGINAL APP LOGIC ---
      const freeMapStyles = {
        dark: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
        light: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
        satellite: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',
        terrain: 'https://tiles.openfreemap.org/styles/liberty'
      };

      const map = new maplibregl.Map({
        container: 'map',
        style: freeMapStyles.dark, 
        center: [-96, 37.8], 
        zoom: 4,
        attributionControl: false 
      });
      map.addControl(new maplibregl.NavigationControl(), 'top-right');

      const writingArea = document.getElementById('writing-area');
      const settingsPanel = document.getElementById('settings-panel');
      const locationInspiration = document.getElementById('location-inspiration');
      const locationInfo = document.getElementById('location-info');
      
      document.getElementById('settings-btn').addEventListener('click', () => { settingsPanel.style.display = 'block'; });
      document.getElementById('inspiration-btn').addEventListener('click', () => { 
          const prompts = ["Describe a hidden civilization", "What magical creatures live here?", "Who built the ruins beneath the city?"];
          const prompt = prompts[Math.floor(Math.random() * prompts.length)];
          locationInfo.innerHTML = `<strong>A mysterious landscape</strong><br><br><em>Writing Prompt:</em><br>${prompt}`;
          locationInspiration.style.display = 'block'; 
      });
      document.getElementById('close-settings').addEventListener('click', () => { settingsPanel.style.display = 'none'; applySettings(); });
      document.getElementById('close-inspiration').addEventListener('click', () => { locationInspiration.style.display = 'none'; });
      document.getElementById('use-inspiration').addEventListener('click', () => { writingArea.value += '\n\n' + locationInfo.textContent; locationInspiration.style.display = 'none'; });

      document.getElementById('generate-poem').addEventListener('click', () => {
        const poems = ["The mountains stand in silent grace...", "Where ocean meets the waiting shore..."];
        writingArea.value += '\n\n' + poems[Math.floor(Math.random() * poems.length)];
      });

      document.getElementById('save-location').addEventListener('click', () => {
        const center = map.getCenter();
        if (writingArea.value.trim()) {
          const el = document.createElement('div'); el.className = 'location-pin'; el.innerHTML = 'üìå'; el.style.width = '30px'; el.style.height = '30px'; el.style.display = 'flex'; el.style.alignItems = 'center'; el.style.justifyContent = 'center'; el.style.fontSize = '20px';
          new maplibregl.Marker(el).setLngLat([center.lng, center.lat]).setPopup(new maplibregl.Popup({ offset: 25 }).setHTML(`<strong>Saved Note:</strong><br>${writingArea.value.substring(0, 100)}...`)).addTo(map);
          alert('Note pinned to map!');
        } else { alert('Please write something first!'); }
      });

      document.getElementById('clear-text').addEventListener('click', () => { if (confirm('Clear all text?')) writingArea.value = ''; });
      document.getElementById('export-text').addEventListener('click', () => {
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([writingArea.value], { type: 'text/plain' })); a.download = 'ataraxia-notes.txt'; a.click();
      });

      const fontSizeSlider = document.getElementById('font-size');
      fontSizeSlider.addEventListener('input', () => { document.getElementById('font-size-value').textContent = fontSizeSlider.value + 'px'; });
      document.getElementById('font-family').addEventListener('change', (e) => applyFont(e.target.value));

      function applySettings() {
        const theme = document.getElementById('map-theme').value;
        if (freeMapStyles[theme]) map.setStyle(freeMapStyles[theme]);
        writingArea.style.fontSize = fontSizeSlider.value + 'px';
      }
      function applyFont(fontFile) {
        let styleElement = document.getElementById('dynamic-font') || document.createElement('style');
        styleElement.id = 'dynamic-font'; document.head.appendChild(styleElement);
        styleElement.textContent = `@font-face { font-family: 'SelectedFont'; src: url('https://cdn.jsdelivr.net/gh/ghostm68/inktwo/fonts/olivetti/${fontFile}') format('opentype'); }`;
        writingArea.style.fontFamily = 'SelectedFont, "Courier New", monospace';
      }
      applyFont('olivetti-typewriter-regular.otf');

      window.addEventListener('click', (e) => {
        if (e.target === settingsPanel) settingsPanel.style.display = 'none';
        if (e.target === locationInspiration) locationInspiration.style.display = 'none';
      });


      // --- DECK.GL "THE SPRAWL" LOGIC ---
      let deckInstance = null;
      let mapInitialized = false;
      let vancouverData = null; // Cache the data
      const slideMenu = document.getElementById('world-menu');
      const closeSlideMenuBtn = document.getElementById('close-slide-menu');
      const deckToggle = document.getElementById('deck-map-toggle');
      const writingHeader = document.querySelector('.writing-header');
      const heightSlider = document.getElementById('height-slider');
      const opacitySlider = document.getElementById('opacity-slider');

      // STEALTH TRIGGER
      if (writingHeader) {
          writingHeader.addEventListener('click', toggleMenu);
      }

      closeSlideMenuBtn.addEventListener('click', toggleMenu);

      // Event listeners for sliders - immediate update on input
      if (heightSlider) heightSlider.addEventListener('input', updateDeckLayer);
      if (opacitySlider) opacitySlider.addEventListener('input', updateDeckLayer);
      if (deckToggle) deckToggle.addEventListener('change', updateDeckLayer);

      function toggleMenu() {
          slideMenu.classList.toggle('active');
          if (slideMenu.classList.contains('active') && !mapInitialized) {
              initDeckMap();
              mapInitialized = true;
          }
      }

      function initDeckMap() {
          const {DeckGL, PolygonLayer} = deck;

          // Initial layer load with data caching
          const initialLayer = new PolygonLayer({
              id: 'city-sprawl',
              data: 'https://raw.githubusercontent.com/visgl/deck.gl-data/master/examples/geojson/vancouver-blocks.json',
              onDataLoad: (data) => { vancouverData = data; }, // Cache for updates
              getPolygon: d => d.geometry.coordinates,
              getElevation: d => d.properties.valuePerSqm * 0.1, // Scale down raw values
              getFillColor: [42, 42, 42],
              getLineColor: [0, 170, 255, 150],
              getLineWidth: 1,
              extruded: true,
              wireframe: true,
              elevationScale: parseFloat(heightSlider.value) || 4,
              opacity: parseFloat(opacitySlider.value) || 0.8,
              visible: deckToggle.checked,
              pickable: true,
              autoHighlight: true,
              highlightColor: [0, 255, 200, 100]
          });

          deckInstance = new DeckGL({
              container: 'deck-map-container',
              map: window.maplibregl,
              mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
              initialViewState: {
                  longitude: -123.13,
                  latitude: 49.254,
                  zoom: 11,
                  pitch: 45,
                  bearing: 0
              },
              controller: true,
              layers: [initialLayer]
          });
      }

      function updateDeckLayer() {
          if (!deckInstance) return;
          
          const {PolygonLayer} = deck;
          const isVisible = deckToggle.checked;
          const heightScale = parseFloat(heightSlider.value) || 4;
          const opacityVal = parseFloat(opacitySlider.value) || 0.8;

          // Create new layer with updated props - same ID triggers diff update
          const updatedLayer = new PolygonLayer({
              id: 'city-sprawl',
              data: vancouverData || 'https://raw.githubusercontent.com/visgl/deck.gl-data/master/examples/geojson/vancouver-blocks.json',
              getPolygon: d => d.geometry.coordinates,
              getElevation: d => d.properties.valuePerSqm * 0.1,
              getFillColor: [42, 42, 42],
              getLineColor: [0, 170, 255, 150],
              getLineWidth: 1,
              extruded: true,
              wireframe: true,
              elevationScale: heightScale,
              opacity: opacityVal,
              visible: isVisible,
              pickable: true,
              autoHighlight: true,
              highlightColor: [0, 255, 200, 100]
          });

          deckInstance.setProps({layers: [updatedLayer]});
      }
  </script>
</body>
</html>
