<!--[if IE 6]>
<html id="ie6" lang="en-US">
<![endif]-->
<!--[if IE 7]>
<html id="ie7" lang="en-US">
<![endif]-->
<!--[if IE 8]>
<html id="ie8" lang="en-US">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8) ]><!-->
<!DOCTYPE html>
<html lang="en" class="ðŸ‘—" data-theme="light">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
	
<link rel="icon" type="image/svg+xml" href="https://cdn.jsdelivr.net/gh/ghostm68/inktwo@main/svg/inky.svg">
<link rel="apple-touch-icon" type="image/png" href="https://github.com/ghostm68/pantheon/raw/main/inkrealm.info.2025.png" />
<meta itemprop="name" content="wordstar nexus/conceptweave"/>	
<meta property="og:url" content="https://www.wordstar.nexus/conceptweave"/>	

<script>
  function updateBodyMobileClass() {
    const isMobile = window.matchMedia("(max-width: 768px)").matches;
    document.body.classList.toggle("is-mobile", isMobile);
  }
  document.addEventListener("DOMContentLoaded", updateBodyMobileClass);
  window.addEventListener("resize", updateBodyMobileClass);
</script>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>2741 Selectric v4.14</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Nova+Mono&family=Special+Elite&display=swap" rel="stylesheet">

<style>
    :root { --red: #ff0000; --black: #050505; --dark-grey: #121212; --white: #d1d1d1; }
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    
    body { 
      background: var(--black); color: var(--white); font-family: 'Nova Mono', monospace; 
      margin: 0; overflow: hidden; height: 100vh; width: 100vw;
    }

    #splash-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: var(--black); z-index: 2000;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      cursor: pointer; border: 4px double var(--red);
    }

    body::after {
      content: " "; display: block; position: fixed; top: 0; left: 0; bottom: 0; right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%);
      z-index: 999; background-size: 100% 3px; pointer-events: none; opacity: 0.4;
    }

    .app-grid { display: none; grid-template-columns: 280px 1fr; grid-template-rows: 50px 1fr 320px 30px; height: 100vh; }
    header { grid-column: span 2; border-bottom: 1px solid var(--red); background: #000; z-index: 50; }
    .sidebar { background: #080808; border-right: 1px solid #222; overflow-y: auto; padding: 20px; }
    #viewport { background: #000; position: relative; border-bottom: 1px solid var(--red); overflow: hidden; }
    .bottom-shelf { grid-row: 3; grid-column: span 2; display: grid; grid-template-columns: 1fr 350px; height: 320px; overflow: hidden; }
    .editor-section { background: var(--dark-grey); display: flex; flex-direction: column; overflow: hidden; border-top: 1px solid var(--red); }
    #editor { flex-grow: 1; padding: 25px; font-family: 'Special Elite', serif; font-size: 1.2rem; line-height: 1.6; outline: none; overflow-y: auto; color: var(--white); caret-color: var(--red); background: var(--dark-grey); }

    .comms-console { background: #000; border-left: 1px solid var(--red); display: flex; flex-direction: column; overflow: hidden; }
    #chat-container { flex-grow: 1; overflow-y: auto; padding: 10px; font-size: 10px; scroll-behavior: smooth; }
    .chat-bubble { margin-bottom: 10px; padding: 8px; border: 1px solid #222; }
    .user-message { border-left: 3px solid #555; color: #888; }
    .bot-message { border-left: 3px solid var(--red); color: var(--white); background: #0a0000; }
    .chat-input-area { display: flex; border-top: 1px solid #222; padding: 5px; }
    #chat-input { background: #000; color: var(--red); border: 1px solid #333; flex-grow: 1; padding: 5px; font-size: 10px; outline: none; }

    .node-center { fill: var(--red); filter: drop-shadow(0 0 5px var(--red)); }
    .node-orbit { fill: #000; stroke: var(--red); stroke-width: 1px; }
    .label { fill: #fff; font-size: 9px; text-transform: uppercase; pointer-events: none; opacity: 0.7; }
    footer { grid-column: span 2; background: #000; border-top: 1px solid #222; font-size: 8px; color: #444; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; height: 30px; }

    @media (max-width: 768px) {
      .app-grid { grid-template-columns: 1fr; grid-template-rows: 50px auto 350px 300px 200px 40px; height: auto; overflow-y: auto; }
      header { position: sticky; top: 0; }
      .sidebar { grid-row: 2; max-height: 150px; }
      #viewport { grid-row: 3; height: 350px; }
      .bottom-shelf { grid-row: 4 / 6; grid-template-columns: 1fr; grid-template-rows: 300px 200px; height: auto; }
      .comms-console { height: 200px; border-left: none; border-top: 1px solid var(--red); }
    }
    .teletype-text::after { content: "|"; animation: blink 1s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
</style>
</head>
<body>

<div id="splash-screen">
    <h1 class="text-red-600 font-bold text-4xl mb-4 tracking-tighter italic">INKREALM_2741</h1>
    <p class="text-zinc-500 animate-pulse text-xs tracking-widest uppercase">Click to Initialize Hardware</p>
</div>

<div class="app-grid">
  <header class="flex items-center justify-between px-4">
    <div class="flex items-center gap-3">
        <div id="power-light" class="w-2 h-2 bg-zinc-900 rounded-full"></div>
        <h1 class="text-white font-bold tracking-tighter text-xs uppercase">SELECTRIC_2741_v4.14</h1>
        <button id="power-toggle" class="text-[9px] border border-zinc-800 px-2 py-1 text-zinc-500" onclick="togglePower()">PWR: OFF</button>
    </div>
    <div class="flex gap-2">
        <button onclick="clearChat()" class="text-[9px] border border-zinc-800 px-2 py-1">CLR_COMMS</button>
        <button onclick="exportDraft()" class="text-[9px] border border-zinc-800 px-2 py-1 text-red-600 font-bold">EXTRACT</button>
    </div>
  </header>

  <aside class="sidebar">
    <div class="text-[10px] text-zinc-700 mb-2 uppercase italic tracking-widest">Inquiry_Path</div>
    <div id="path-log" class="mb-8"></div>
    <div class="text-[10px] text-red-900 mb-2 uppercase font-bold tracking-widest">Fractal_Nodes</div>
    <div id="word-menu"></div>
  </aside>

  <main id="viewport">
    <svg id="canvas" class="w-full h-full"></svg>
  </main>

  <div class="bottom-shelf">
    <section class="editor-section">
      <div class="bg-red-600 text-white px-4 py-1 flex justify-between font-serif text-[10px]">
          <div class="teletype-text" id="teletype">>> INITIALIZING...</div>
          <div id="word-count">0W</div>
      </div>
      <div id="editor" contenteditable="true" spellcheck="false"></div>
    </section>

    <aside class="comms-console">
        <div class="bg-zinc-900 text-[9px] p-2 text-zinc-500 uppercase flex justify-between border-b border-red-900">
            <span>Comms_Link_Active</span>
            <span id="witch-status" class="text-red-700 font-bold">Protected</span>
        </div>
        <div id="chat-container">
            <div class="chat-bubble bot-message">2741 Interface Active. Request story data.</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Type command..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" class="bg-red-800 px-2 text-[9px] ml-1">SEND</button>
        </div>
    </aside>
  </div>

  <footer>
    <div>TERMINAL_v4.14 // SHADOW_STABLE</div>
    <div class="flex gap-4 uppercase"><span>InkRealm Construct</span><span>|</span><span id="footer-status">WITCH_PROTOCOL_ACTIVE</span></div>
  </footer>
</div>

<script>
    // --- 1. INITIALIZATION & DATA ---
    const statusMessages = [
        ">> 2741_LINK_ESTABLISHED",
        ">> SELECTRIC_ELEMENT_ROTATING",
        ">> DATA_STREAM_VIA_ATS/360",
        ">> TERMINAL_LOCK_ENGAGED",
        ">> NOIR_PROTOCOL_v4.14"
    ];
    let messageIndex = 0, charIndex = 0, isDeleting = false;
    let audioCtx, humOsc, gainNode, filter, isPowered = false;
    let typingActivity = 0;

    const lexicon = { 
        name: "World", 
        children: [
            { name: "Violence", children: [{name: "Laceration"}, {name: "Contusion"}] },
            { name: "Atmosphere", children: [{name: "Neon"}, {name: "Steam"}] },
            { name: "Mind", children: [{name: "Amnesia"}, {name: "Paranoia"}] },
            { name: "Evidence", children: [{name: "Ledger"}, {name: "Cigarette"}] }
        ]
    };
    let currentNode = JSON.parse(JSON.stringify(lexicon));
    let history = [];

    // --- 2. D3 SETUP (ZOOM & SIMULATION) ---
    const svg = d3.select("#canvas");
    let width = window.innerWidth <= 768 ? window.innerWidth : window.innerWidth - 280;
    let height = window.innerWidth <= 768 ? 350 : window.innerHeight - 400;

    // Create groups for Zoom/Pan to act upon
    const linkGroup = svg.append("g").attr("class", "links");
    const nodeGroup = svg.append("g").attr("class", "nodes");

    const simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(d => d.name).distance(100))
        .force("charge", d3.forceManyBody().strength(-600))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("x", d3.forceX(width / 2).strength(0.1))
        .force("y", d3.forceY(height / 2).strength(0.1))
        .force("collide", d3.forceCollide(35));

    const zoom = d3.zoom()
        .scaleExtent([0.5, 3])
        .on("zoom", (event) => {
            linkGroup.attr("transform", event.transform);
            nodeGroup.attr("transform", event.transform);
        });
    svg.call(zoom);

    // --- 3. CORE UPDATE ENGINE ---
    function update() {
        const nodes = currentNode.children || [];
        const links = nodes.map(d => ({ source: currentNode.name, target: d.name }));
        const displayNodes = [{ name: currentNode.name, isParent: true }, ...nodes];

        // UI Updates
        document.getElementById('path-log').innerHTML = history.map((h, i) => 
            `<div class="log-item" onclick="jumpTo(${i})">> ${h.name}</div>`).join('');
        document.getElementById('word-menu').innerHTML = nodes.map(n => 
            `<div class="log-item" onclick="handleNodeClick('${n.name}')">${n.name}</div>`).join('');

        // D3 Link Render
        const link = linkGroup.selectAll(".link")
            .data(links, d => d.target)
            .join("line")
            .attr("class", "link")
            .attr("stroke", "#222");

        // D3 Node Render
        const node = nodeGroup.selectAll(".node-container")
            .data(displayNodes, d => d.name)
            .join("g")
            .attr("class", "node-container")
            .on("click", (e, d) => handleNodeClick(d.name))
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        node.selectAll("circle").data(d => [d]).join("circle")
            .attr("r", d => d.isParent ? 12 : 7)
            .attr("class", d => d.isParent ? "node-center" : "node-orbit");

        node.selectAll("text").data(d => [d]).join("text")
            .attr("class", "label").attr("dy", 26).attr("text-anchor", "middle")
            .text(d => d.name);

        simulation.nodes(displayNodes);
        simulation.force("link").links(links);
        simulation.alpha(1).restart();

        simulation.on("tick", () => {
            link.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
            
            node.attr("transform", d => {
                // HARD BOUNDING BOX LOGIC
                const radius = 25;
                d.x = Math.max(radius, Math.min(width - radius, d.x));
                d.y = Math.max(radius, Math.min(height - radius, d.y));
                return `translate(${d.x},${d.y})`;
            });
        });
    }

    async function handleNodeClick(name) {
        insertText(name); 
        if(name === currentNode.name) return;
        const target = currentNode.children?.find(c => c.name === name);
        if(target && target.children) { 
            history.push(currentNode); 
            currentNode = target; 
            update(); 
        } else { 
            await excavate(name); 
        }
    }

    async function excavate(word) {
        try {
            const res = await fetch(`https://text.pollinations.ai/Visceral noir synonyms for ${word}. Commas only.`);
            const data = await res.text();
            const aiWords = data.split(',').map(w => ({ name: w.trim().replace('.', '') }));
            let targetNode = currentNode.children.find(n => n.name === word);
            if(targetNode) { 
                targetNode.children = aiWords; 
                history.push(currentNode); 
                currentNode = targetNode; 
                update(); 
            }
        } catch(e) { console.warn("Signal Interference"); }
    }

    // --- 4. UI, AUDIO & CHAT LOGIC ---
    function typeStatus() {
        const target = document.getElementById('teletype');
        if(!target) return;
        const currentMsg = statusMessages[messageIndex];
        target.innerText = isDeleting ? currentMsg.substring(0, charIndex - 1) : currentMsg.substring(0, charIndex + 1);
        charIndex = isDeleting ? charIndex - 1 : charIndex + 1;
        let speed = isDeleting ? 40 : 80;
        if (!isDeleting && charIndex === currentMsg.length) { speed = 3000; isDeleting = true; }
        else if (isDeleting && charIndex === 3) { isDeleting = false; messageIndex = (messageIndex + 1) % statusMessages.length; speed = 500; }
        setTimeout(typeStatus, speed);
    }

    function initAudio() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        humOsc = audioCtx.createOscillator(); gainNode = audioCtx.createGain(); filter = audioCtx.createBiquadFilter();
        humOsc.type = 'sawtooth'; humOsc.frequency.setValueAtTime(55, audioCtx.currentTime);
        filter.type = 'lowpass'; filter.frequency.setValueAtTime(120, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
        humOsc.connect(filter); filter.connect(gainNode); gainNode.connect(audioCtx.destination); humOsc.start();
    }

    function togglePower() {
        if (!audioCtx) initAudio();
        const btn = document.getElementById('power-toggle'), light = document.getElementById('power-light');
        if (!isPowered) {
            isPowered = true; btn.innerText = "PWR: ON"; btn.style.color = "var(--red)"; light.classList.add('bg-red-600', 'animate-pulse');
            gainNode.gain.setTargetAtTime(0.04, audioCtx.currentTime, 0.5);
        } else {
            isPowered = false; btn.innerText = "PWR: OFF"; btn.style.color = "#555"; light.classList.remove('bg-red-600', 'animate-pulse');
            gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.2);
        }
    }

    async function sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (!message) return;
        const container = document.getElementById('chat-container');
        container.innerHTML += `<div class="chat-bubble user-message">>> ${message}</div>`;
        input.value = '';
        const typing = document.createElement('div');
        typing.className = 'chat-bubble bot-message';
        typing.textContent = '...Analyzing Signal...';
        container.appendChild(typing);
        container.scrollTop = container.scrollHeight;
        try {
            const response = await fetch(`https://text.pollinations.ai/In a short noir style, answer: ${message}`);
            const data = await response.text();
            typing.remove();
            container.innerHTML += `<div class="chat-bubble bot-message">${data.trim()}</div>`;
        } catch (e) { typing.textContent = "Signal Interference: Connection Lost."; }
        container.scrollTop = container.scrollHeight;
    }

    function insertText(w) { 
        document.getElementById('editor').innerHTML += ` <span style="color:red">${w}</span> `; 
        typingActivity = 15; 
        saveAll(); 
    }

    function saveAll() {
        localStorage.setItem('noir_editor_2741_v414', document.getElementById('editor').innerHTML);
        const txt = document.getElementById('editor').innerText.trim();
        document.getElementById('word-count').innerText = (txt.length > 0 ? txt.split(/\s+/).length : 0) + "W";
    }

    function loadAll() {
        const saved = localStorage.getItem('noir_editor_2741_v414');
        if(saved && saved.trim().length > 50) { document.getElementById('editor').innerHTML = saved; }
        else { 
            document.getElementById('editor').innerHTML = 
                "_2741_PROTOCOL:<br>" +
                "i. POWER ON to sync the Selectric core.<br>" +
                "ii. CLICK nodes to rotate the element.<br>" +
                "iii. RED nodes trigger ATS/360 semantic branches.<br>" +
                "iv. TYPE to pulse the voltage monitor.<br>" +
                "v. EXPORT to extract the final dossier.<br><br>" +
                "------------------------------------------<br><br>" +
                "The 2741 hummed in its desk, the element poised like a hammer. The detective's cigarette was working harder than his liver, and the neon rain was turning the sidewalk into a smear of spilled ink...";
        }
        saveAll();
    }

    function animateWitch() {
        const status = document.getElementById('witch-status');
        const footer = document.getElementById('footer-status');
        const texts = ['Protected', 'Scanning', 'Warding', 'Secure', 'Charged'];
        let index = 0;
        setInterval(() => {
            if(status) status.textContent = texts[index];
            if(footer) footer.textContent = `WITCH_PROTOCOL_${texts[index].toUpperCase()}`;
            index = (index + 1) % texts.length;
        }, 3000);
    }

    // --- 5. BOOT PROCESS & HANDLERS ---
    document.getElementById('splash-screen').addEventListener('click', function() {
        this.style.opacity = '0';
        this.style.transition = 'opacity 0.5s';
        document.querySelector('.app-grid').style.display = 'grid';
        setTimeout(() => { this.style.display = 'none'; }, 500);
        update(); 
    });

    function jumpTo(index) { currentNode = history[index]; history = history.slice(0, index); update(); }
    function goHome() { history = []; currentNode = JSON.parse(JSON.stringify(lexicon)); update(); }
    function clearChat() { if (confirm("Wipe history?")) document.getElementById('chat-container').innerHTML = `<div class="chat-bubble bot-message">Reset.</div>`; }
    function exportDraft() { const blob = new Blob([document.getElementById('editor').innerText], {type: 'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = '2741-manuscript.txt'; a.click(); }

    document.getElementById('editor').addEventListener('input', saveAll);

    window.onload = () => { loadAll(); typeStatus(); animateWitch(); };

    function dragstarted(e, d) { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
    function dragged(e, d) { d.fx = e.x; d.fy = e.y; }
    function dragended(e, d) { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }
</script>
</body>
</html>
