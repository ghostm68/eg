<!DOCTYPE html>
<html>
<head>
  <title>ConceptWeave: Noir Edition</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nova+Mono&family=Special+Elite&display=swap" rel="stylesheet">
  <style>
    :root {
      --noir-red: #cc0000;
      --noir-black: #050505;
      --noir-deep: #000000;
      --noir-grey: #1a1a1a;
      --noir-white: #e5e5e5;
    }
    
    body { 
      background: var(--noir-black); 
      color: var(--noir-white); 
      font-family: 'Nova Mono', monospace; 
      margin: 0; overflow: hidden; 
    }

    /* Layout Grid */
    .app-container {
      display: grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: 60px 1fr 320px 30px;
      height: 100vh;
    }

    header { grid-column: span 2; border-bottom: 2px solid var(--noir-red); background: #000; z-index: 10; }
    .sidebar { background: var(--noir-grey); border-right: 1px solid #333; overflow-y: auto; }
    #graph-viewport { background: radial-gradient(circle, #1a1a1a 0%, #050505 100%); border-bottom: 1px solid #222; position: relative; }
    
    /* Typewriter Header Animation */
    .typewriter-head {
      font-family: 'Special Elite', serif;
      font-size: 14px;
      color: var(--noir-red);
      overflow: hidden;
      border-right: 2px solid var(--noir-red);
      white-space: nowrap;
      margin: 0;
      width: 0;
      animation: typing 3s steps(30, end) infinite alternate, blink .7s infinite;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    @keyframes typing { from { width: 0 } to { width: 220px } }
    @keyframes blink { from, to { border-color: transparent } 50% { border-color: var(--noir-red) } }

    /* The Editor & Tension Monitor Area */
    .bottom-shelf {
      grid-column: span 2;
      display: grid;
      grid-template-columns: 1fr 300px;
      background: #000;
      border-top: 1px solid var(--noir-red);
    }

    .editor-box { padding: 0; background: #fff; position: relative; }
    #editor {
      width: 100%; height: 100%; padding: 30px;
      font-family: 'Special Elite', serif; font-size: 1.2rem; line-height: 1.6;
      color: #111; outline: none; overflow-y: auto;
    }

    /* Tension Monitor (Floating SVG Area) */
    .monitor-panel {
      background: #080808;
      border-left: 1px solid #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }

    .monitor-svg {
      width: 100%; height: 80px;
      stroke: var(--noir-red);
      stroke-width: 1;
      fill: none;
    }

    /* Node & Link Styling */
    .link { stroke: #333; stroke-opacity: 0.6; }
    .node-main { fill: var(--noir-red); stroke: #fff; stroke-width: 2px; }
    .node-leaf { fill: #000; stroke: var(--noir-red); stroke-width: 1.5px; }
    .node-text { fill: #888; font-size: 10px; text-transform: uppercase; }

    footer { grid-column: span 2; background: #000; border-top: 1px solid #111; font-size: 10px; color: #444; }

    .btn-noir { border: 1px solid #444; color: #888; padding: 4px 10px; font-size: 10px; transition: 0.2s; }
    .btn-noir:hover { border-color: var(--noir-red); color: white; }
  </style>
</head>
<body>

<div class="app-container">
  <!-- TOP NAV -->
  <header class="flex items-center justify-between px-6">
    <div class="flex items-center gap-4">
        <h1 class="font-bold tracking-tighter text-lg">CONCEPT<span class="text-red-700">WEAVE</span></h1>
        <span class="text-[10px] text-zinc-600">// FRACTAL_OS_v4</span>
    </div>
    <div class="flex gap-4">
        <button onclick="goHome()" class="btn-noir">REBOOT HIERARCHY</button>
        <button onclick="exportDraft()" class="btn-noir">EXTRACT DRAFT</button>
    </div>
  </header>

  <!-- SIDEBAR -->
  <aside class="sidebar p-4">
    <div class="text-[10px] text-red-800 mb-4 uppercase tracking-widest">Index_Menu</div>
    <div id="word-menu" class="flex flex-col gap-1"></div>
  </aside>

  <!-- GRAPH AREA -->
  <main id="graph-viewport">
    <svg id="canvas" class="w-full h-full"></svg>
  </main>

  <!-- BOTTOM SHELF: Editor & Monitor -->
  <div class="bottom-shelf">
    <section class="editor-box">
        <div class="bg-zinc-100 border-b border-zinc-300 px-6 py-2 flex items-center">
            <h2 class="typewriter-head">TRANSMITTING_STORY_DATA...</h2>
        </div>
        <div id="editor" contenteditable="true">The detective's cigarette was the only thing working harder than his liver...</div>
    </section>

    <aside class="monitor-panel">
        <div class="text-[9px] text-zinc-600 uppercase mb-2 tracking-tighter">Atmosphere_Pulse</div>
        <svg class="monitor-svg" id="pulse-monitor">
            <polyline id="pulse-line" points="0,40"></polyline>
        </svg>
        <div class="mt-4 text-[10px] text-red-900 animate-pulse">‚óè SIGNAL_STABLE</div>
    </aside>
  </div>

  <!-- FOOTER -->
  <footer class="flex items-center justify-between px-6">
    <div>NOIR_DEVICES_INDUSTRIES</div>
    <div class="flex gap-4 uppercase italic">
        <span>Concept by InkRealm</span>
        <span>|</span>
        <span class="text-zinc-300">Enhanced by Gemini AI</span>
    </div>
  </footer>
</div>

<script>
    // --- Lexicon Hierarchy ---
    const lexicon = {
        name: "World",
        children: [
            { name: "Violence", children: [{name: "Perforation"}, {name: "Laceration"}, {name: "Blunt"}] },
            { name: "The Street", children: [{name: "Asphalt"}, {name: "Neon"}, {name: "Steam"}] },
            { name: "Anatomy", children: [{name: "Sinew"}, {name: "Marrow"}, {name: "Viscera"}] },
            { name: "Shadows", children: [{name: "Silhouette"}, {name: "Obscurity"}, {name: "Penumbra"}] }
        ]
    };

    let currentNode = lexicon;
    let history = [];

    const svg = d3.select("#canvas");
    const width = window.innerWidth - 280;
    const height = window.innerHeight - 380 - 30;

    const simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(d => d.name).distance(120))
        .force("charge", d3.forceManyBody().strength(-500))
        .force("center", d3.forceCenter(width / 2, height / 2));

    function draw() {
        const nodes = currentNode.children || [];
        const links = nodes.map(d => ({ source: currentNode.name, target: d.name }));
        const displayNodes = [{ name: currentNode.name, isParent: true }, ...nodes];

        // Sidebar Update
        const menu = document.getElementById('word-menu');
        menu.innerHTML = nodes.map(n => `<div class="cursor-pointer hover:text-red-600 py-1 text-sm border-b border-zinc-800" onclick="handleNodeClick('${n.name}')">${n.name}</div>`).join('');
        if(history.length > 0) menu.innerHTML += `<div class="mt-4 text-red-900 cursor-pointer text-xs" onclick="goBack()">[BACK]</div>`;

        // D3 Render
        const link = svg.selectAll(".link").data(links, d => d.target).join("line").attr("class", "link");
        const node = svg.selectAll(".node-group").data(displayNodes, d => d.name).join("g").attr("class", "node-group")
            .on("click", (e, d) => handleNodeClick(d.name))
            .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended));

        node.selectAll("circle").data(d => [d]).join("circle")
            .attr("r", d => d.isParent ? 12 : 6)
            .attr("class", d => d.isParent ? "node-main" : "node-leaf");

        node.selectAll("text").data(d => [d]).join("text")
            .attr("class", "node-text")
            .attr("dy", 24).attr("text-anchor", "middle")
            .text(d => d.name);

        simulation.nodes(displayNodes);
        simulation.force("link").links(links);
        simulation.alpha(1).restart();

        simulation.on("tick", () => {
            link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });
    }

    async function handleNodeClick(name) {
        if(name === currentNode.name) return;
        const target = currentNode.children?.find(c => c.name === name);
        if(target && target.children) {
            history.push(currentNode);
            currentNode = target;
            draw();
        } else {
            insertWord(name);
            await excavate(name);
        }
    }

    async function excavate(word) {
        const prompt = `Provide 4 noir synonyms for "${word}" separated by commas.`;
        try {
            const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}`);
            const data = await res.text();
            const aiNodes = data.split(',').map(d => ({ name: d.trim() }));
            
            let target = currentNode.children.find(n => n.name === word);
            if(target) {
                target.children = aiNodes;
                history.push(currentNode);
                currentNode = target;
                draw();
            }
        } catch(e) { console.log("AI Offline"); }
    }

    function insertWord(w) { document.getElementById('editor').innerHTML += `<span style="color:red">${w}</span> `; }
    function goBack() { if(history.length > 0) { currentNode = history.pop(); draw(); } }
    function goHome() { history = []; currentNode = lexicon; draw(); }
    function exportDraft() { 
        const blob = new Blob([document.getElementById('editor').innerText], {type: 'text/plain'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'noir-log.txt'; a.click();
    }

    // --- Tension Monitor (The Floating SVG Animation) ---
    const pulseLine = document.getElementById('pulse-line');
    let pulseData = [];
    setInterval(() => {
        const y = 40 + (Math.random() - 0.5) * 40;
        pulseData.push(y);
        if(pulseData.length > 50) pulseData.shift();
        const points = pulseData.map((d, i) => `${i * 6},${d}`).join(' ');
        pulseLine.setAttribute('points', points);
    }, 100);

    function dragstarted(e, d) { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
    function dragged(e, d) { d.fx = e.x; d.fy = e.y; }
    function dragended(e, d) { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }

    draw();
</script>
</body>
</html>
