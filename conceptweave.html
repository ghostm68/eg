<!DOCTYPE html>
<html>
<head>
  <title>ConceptWeave Fractal Noir Pro</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nova+Mono&family=Special+Elite&display=swap" rel="stylesheet">
  <style>
    :root {
      --noir-red: #ff0000;
      --noir-black: #000000;
      --noir-deep-grey: #0d0d0d;
      --noir-grey: #1a1a1a;
      --noir-light: #e5e5e5;
    }
    
    body { 
      background: var(--noir-black); 
      color: var(--noir-light); 
      font-family: 'Nova Mono', monospace; 
      overflow: hidden; 
      height: 100vh;
    }

    /* Layout */
    .app-grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      grid-template-rows: 60px 1fr 280px 30px;
      height: 100vh;
    }

    header { grid-column: span 2; border-bottom: 1px solid var(--noir-red); background: #000; z-index: 50; }
    .sidebar { background: var(--noir-deep-grey); border-right: 1px solid #222; overflow-y: auto; }
    #view-port { background: radial-gradient(circle at center, #111 0%, #000 100%); position: relative; }
    footer { grid-column: span 2; background: #050505; border-top: 1px solid #1a1a1a; font-size: 10px; color: #444; }

    /* Word Menu Styling */
    .menu-section { padding: 15px; border-bottom: 1px solid #1a1a1a; }
    .menu-header { color: var(--noir-red); font-size: 10px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; }
    .menu-item { 
      padding: 6px 10px; 
      cursor: pointer; 
      font-size: 13px; 
      border-left: 2px solid transparent;
      transition: all 0.2s;
    }
    .menu-item:hover { 
      background: #151515; 
      border-left: 2px solid var(--noir-red); 
      color: #fff;
    }

    /* Editor */
    #editor {
      background: #fdfdfd;
      color: #111;
      font-family: 'Special Elite', serif;
      font-size: 1.2rem;
      padding: 40px;
      outline: none;
      overflow-y: auto;
      height: 100%;
      box-shadow: inset 0 5px 15px rgba(0,0,0,0.1);
    }

    /* D3 Elements */
    .link { stroke: var(--noir-red); stroke-opacity: 0.15; stroke-width: 1px; }
    .node-circle { cursor: pointer; transition: 0.4s; }
    .node-label { fill: #888; font-size: 10px; pointer-events: none; text-transform: uppercase; }
    .active-label { fill: white; font-weight: bold; }

    /* UI Controls */
    .btn-noir { border: 1px solid #333; color: #888; padding: 4px 12px; font-size: 11px; transition: 0.3s; }
    .btn-noir:hover { border-color: var(--noir-red); color: white; }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-thumb { background: var(--noir-red); }
  </style>
</head>
<body>

<div class="app-grid">
  <!-- HEADER -->
  <header class="flex items-center justify-between px-6">
    <div class="flex items-center gap-6">
        <h1 class="text-white font-bold tracking-tighter text-xl">CONCEPT<span class="text-red-600">WEAVE</span></h1>
        <div id="path" class="text-xs text-gray-500 uppercase tracking-widest">/ Lexicon</div>
    </div>
    <div class="flex gap-4">
        <button onclick="exportDraft()" class="btn-noir">EXPORT DRAFT</button>
        <button onclick="goHome()" class="btn-noir">RESET ROOT</button>
    </div>
  </header>

  <!-- SIDEBAR: WORD MENU -->
  <aside class="sidebar">
    <div class="menu-section">
        <div class="menu-header">Quick Search</div>
        <input type="text" id="search" placeholder="Type a concept..." class="w-full bg-black border border-zinc-800 p-2 text-xs text-white outline-none focus:border-red-600">
    </div>
    <div id="word-menu-content">
        <!-- Fractal levels populated here -->
    </div>
  </aside>

  <!-- MAIN VIEWPORT -->
  <main id="view-port">
    <div id="ai-status" class="absolute top-4 left-4 text-[10px] text-red-600 opacity-0 transition-opacity">AI EXCAVATING...</div>
    <svg id="canvas" class="w-full h-full"></svg>
  </main>

  <!-- EDITOR AREA -->
  <section class="editor-container border-t-2 border-red-600">
    <div id="editor" contenteditable="true">The rain didn't wash away the neon, it just made the blood look like spilled paint...</div>
  </section>

  <!-- FOOTER -->
  <footer class="flex items-center justify-between px-6">
    <div>VERSION 4.0 // FRACTAL NOIR SYSTEM</div>
    <div class="flex gap-4 italic uppercase">
        <span>Concept by InkRealm</span>
        <span class="text-zinc-500">|</span>
        <span>Enhanced by Gemini AI</span>
        <span class="text-zinc-500">|</span>
        <span>For Selective Creative Endeavors</span>
    </div>
  </footer>
</div>

<script>
    // --- MASSIVE HIERARCHY (The "Borderline Too Much" Start) ---
    const lexicon = {
        name: "World",
        children: [
            { name: "Matter", children: [
                { name: "Metals", children: [{name: "Mercury"}, {name: "Lead"}, {name: "Iron"}] },
                { name: "Liquids", children: [{name: "Varnish"}, {name: "Serum"}, {name: "Brine"}] },
                { name: "Textures", children: [{name: "Viscous"}, {name: "Abrasive"}, {name: "Ethereal"}] }
            ]},
            { name: "The Body", children: [
                { name: "Anatomy", children: [{name: "Sinew"}, {name: "Marrow"}, {name: "Cortex"}] },
                { name: "Condition", children: [{name: "Lethargic"}, {name: "Feverish"}, {name: "Robust"}] },
                { name: "Senses", children: [{name: "Olfactory"}, {name: "Tactile"}, {name: "Visceral"}] }
            ]},
            { name: "Nature", children: [
                { name: "Sky", children: [{name: "Nimbus"}, {name: "Azure"}, {name: "Twilight"}] },
                { name: "Depths", children: [{name: "Chasm"}, {name: "Fissure"}, {name: "Abyss"}] },
                { name: "Growth", children: [{name: "Gnarly"}, {name: "Verdant"}, {name: "Desiccated"}] }
            ]},
            { name: "The Mind", children: [
                { name: "Darkness", children: [{name: "Paranoia"}, {name: "Obsession"}, {name: "Remorse"}] },
                { name: "Light", children: [{name: "Clarity"}, {name: "Intuition"}, {name: "Nostalgia"}] }
            ]},
            { name: "Urban Noir", children: [
                { name: "Architecture", children: [{name: "Fire-escape"}, {name: "Tenement"}, {name: "Gargoyle"}] },
                { name: "Street", children: [{name: "Pavement"}, {name: "Shadow"}, {name: "Asphalt"}] }
            ]}
        ]
    };

    let currentNode = lexicon;
    let history = [];
    const svg = d3.select("#canvas");
    const width = window.innerWidth - 320;
    const height = window.innerHeight - 340 - 30;

    const simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(d => d.name).distance(140))
        .force("charge", d3.forceManyBody().strength(-600))
        .force("center", d3.forceCenter(width / 2, height / 2));

    function draw() {
        const nodes = currentNode.children || [];
        const links = nodes.map(d => ({ source: currentNode.name, target: d.name }));
        const displayNodes = [{ name: currentNode.name, isParent: true }, ...nodes];

        document.getElementById('path').innerText = "/ " + [...history, currentNode].map(h => h.name).join(" / ");

        // Update Sidebar Menu
        const menu = document.getElementById('word-menu-content');
        menu.innerHTML = `<div class="menu-section">
            <div class="menu-header">Sub-Categories</div>
            ${nodes.map(n => `<div class="menu-item" onclick="handleNodeClick('${n.name}')">${n.name}</div>`).join('')}
            ${history.length > 0 ? `<div class="menu-item text-red-800 mt-4" onclick="goBack()">â†‘ Go Back</div>` : ''}
        </div>`;

        // D3 Render
        const link = svg.selectAll(".link").data(links, d => d.target).join("line").attr("class", "link");

        const node = svg.selectAll(".node-group").data(displayNodes, d => d.name).join("g").attr("class", "node-group")
            .on("click", (e, d) => handleNodeClick(d.name))
            .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended));

        node.selectAll("circle").data(d => [d]).join("circle")
            .attr("r", d => d.isParent ? 12 : 6)
            .attr("class", "node-circle")
            .style("fill", d => d.isParent ? "var(--noir-red)" : "#111")
            .style("stroke", d => d.isParent ? "white" : "var(--noir-red)");

        node.selectAll("text").data(d => [d]).join("text")
            .attr("class", d => d.isParent ? "node-label active-label" : "node-label")
            .attr("dy", 24)
            .attr("text-anchor", "middle")
            .text(d => d.name);

        simulation.nodes(displayNodes);
        simulation.force("link").links(links);
        simulation.alpha(1).restart();

        simulation.on("tick", () => {
            link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
            node.attr("transform", d => `translate(${d.x},${d.y})`);
        });
    }

    async function handleNodeClick(name) {
        if (name === currentNode.name) return;
        const target = currentNode.children?.find(c => c.name === name);
        
        if (target && target.children) {
            history.push(currentNode);
            currentNode = target;
            draw();
        } else {
            // It's a "Leaf" - Generate AI Sensory Branch
            document.getElementById('ai-status').style.opacity = 1;
            insertWord(name);
            await excavateAI(name);
            document.getElementById('ai-status').style.opacity = 0;
        }
    }

    async function excavateAI(word) {
        try {
            const prompt = `Provide exactly 4 unique, single-word creative synonyms or visceral sensory words related to "${word}" in a noir style. Separated by commas.`;
            const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}`);
            const text = await response.text();
            
            const aiWords = text.split(',').map(w => ({ name: w.trim().replace('.', '') }));
            
            // Transform the current leaf into a parent
            let targetNode;
            if (currentNode.children) {
                targetNode = currentNode.children.find(n => n.name === word);
            }

            if (targetNode) {
                targetNode.children = aiWords;
                history.push(currentNode);
                currentNode = targetNode;
                draw();
            }
        } catch (e) { console.error("AI Silence..."); }
    }

    function insertWord(word) {
        const editor = document.getElementById('editor');
        editor.innerHTML += ` <span style="color:red">${word}</span>&nbsp;`;
    }

    function goBack() { if (history.length > 0) { currentNode = history.pop(); draw(); } }
    function goHome() { history = []; currentNode = lexicon; draw(); }

    function exportDraft() {
        const text = document.getElementById('editor').innerText;
        const blob = new Blob([text], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'noir-draft.txt';
        a.click();
    }

    // Search function to jump categories
    document.getElementById('search').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            const val = this.value;
            if (val) {
                handleNodeClick(val); // This will trigger AI excavation for the search term
                this.value = '';
            }
        }
    });

    function dragstarted(event, d) { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
    function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
    function dragended(event, d) { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }

    draw();
</script>
</body>
</html>
