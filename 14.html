<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/ghostm68/inktwo/main/Images/favicon.ico" />
    <title>Creative Writing Machine</title>
    <style>
        body {
            background: #0a0a0a;
            color: #f0f0f0;
            font-family: 'Georgia', serif;
            margin: 0;
            padding: 0.8rem;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.6rem;
            max-width: 1800px;
            margin: 0 auto;
            min-height: 85vh;
        }
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                gap: 0.6rem;
            }
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 0.3rem;
            text-align: center;
        }
        .subtitle {
            font-style: italic;
            color: #aaa;
            margin-bottom: 0.8rem;
            text-align: center;
            font-size: 0.85rem;
        }
        
        /* All panels share same base style */
        .panel {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 0.8rem;
            display: flex;
            flex-direction: column;
        }
        .panel h2 {
            margin-top: 0;
            font-size: 1.1rem;
            color: #eee;
            border-bottom: 1px solid #333;
            padding-bottom: 0.4rem;
            margin-bottom: 0.6rem;
        }
        
        /* Notepad Panel */
        #notepad-section {
            min-height: 450px;
        }
        .font-selector {
            margin-bottom: 0.6rem;
        }
        .font-selector label {
            display: block;
            margin-bottom: 0.2rem;
            color: #aaa;
            font-size: 0.75rem;
        }
        .font-selector select {
            width: 100%;
            padding: 0.3rem;
            background: #0a0a0a;
            color: #eee;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        #notepad {
            flex: 1;
            width: 100%;
            background: #0a0a0a;
            color: #f0f0f0;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 0.6rem;
            font-size: 0.85rem;
            line-height: 1.4;
            resize: none;
            font-family: 'DejaVu Sans Mono', monospace;
            min-height: 280px;
        }
        .notepad-controls {
            margin-top: 0.6rem;
            display: flex;
            gap: 0.4rem;
        }
        .notepad-controls button {
            flex: 1;
            padding: 0.4rem;
            font-size: 0.75rem;
        }
        
        /* AI Controls Panel */
        #ai-controls {
            min-height: 450px;
        }
        .api-key-section {
            background: #0a0a0a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 0.6rem;
            margin-bottom: 0.6rem;
        }
        .api-key-section h3 {
            margin-top: 0;
            font-size: 0.85rem;
            color: #eee;
        }
        #apiKey {
            width: 100%;
            padding: 0.3rem;
            background: #1a1a1a;
            color: #eee;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-bottom: 0.2rem;
        }
        .api-help {
            font-size: 0.65rem;
            color: #666;
        }
        
        /* Image Upload Section */
        .image-upload-section {
            background: #0a0a0a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 0.6rem;
            margin-bottom: 0.6rem;
        }
        .image-upload-section h3 {
            margin-top: 0;
            font-size: 0.85rem;
            color: #eee;
            margin-bottom: 0.4rem;
        }
        .upload-area {
            border: 2px dashed #444;
            border-radius: 4px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #1a1a1a;
        }
        .upload-area:hover {
            border-color: #666;
            background: #222;
        }
        .upload-area p {
            margin: 0;
            font-size: 0.8rem;
            color: #aaa;
        }
        #imagePreview {
            margin-top: 0.6rem;
            display: none;
        }
        #imagePreview img {
            max-width: 100%;
            max-height: 120px;
            border-radius: 4px;
            border: 1px solid #444;
        }
        .remove-image {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            border-radius: 3px;
            cursor: pointer;
            margin-top: 0.3rem;
        }
        
        .prompt-section {
            margin-bottom: 0.6rem;
            flex: 1;
        }
        .prompt-section label {
            display: block;
            margin-bottom: 0.2rem;
            color: #aaa;
            font-size: 0.75rem;
        }
        #prompt {
            width: 100%;
            flex: 1;
            min-height: 120px;
            background: #0a0a0a;
            color: #f0f0f0;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.8rem;
            line-height: 1.3;
            resize: vertical;
            font-family: inherit;
        }
        .controls-group {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.6rem;
            align-items: end;
            margin: 0.6rem 0;
        }
      .creativity-control label {
    display: block;
    margin-bottom: 0.2rem;
    color: #aaa;
    font-size: 0.75rem;
}
input[type="range"] {
    width: 100%;
    margin: 0.2rem 0;
    -webkit-appearance: none;
    background: transparent;
}

/* Track (background) - ADD THIS SECTION */
input[type="range"]::-webkit-slider-runnable-track {
    width: 100%;
    height: 6px;
    background: #444444;  /* Dark grey track */
    border-radius: 3px;
    border: 1px solid #333;
}

input[type="range"]::-moz-range-track {
    width: 100%;
    height: 6px;
    background: #444444;  /* Dark grey track */
    border-radius: 3px;
    border: 1px solid #333;
}

/* Thumb (slider handle) */
input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 20px;
    width: 20px;
    background: #ff4444;  /* Red thumb */
    border-radius: 50%;
    border: 2px solid #ff8888;
    box-shadow: 0 0 5px rgba(255, 68, 68, 0.5);
    margin-top: -7px;
    cursor: pointer;
    transition: background 0.2s;
}

input[type="range"]::-moz-range-thumb {
    height: 20px;
    width: 20px;
    background: #ff4444;  /* Red thumb */
    border-radius: 50%;
    border: 2px solid #ff8888;
    box-shadow: 0 0 5px rgba(255, 68, 68, 0.5);
    cursor: pointer;
    transition: background 0.2s;
}

/* Hover effect for red slider */
input[type="range"]::-webkit-slider-thumb:hover {
    background: #ff6666;
}

input[type="range"]::-moz-range-thumb:hover {
    background: #ff6666;
}
#generateButton {
    padding: 0.5rem 0.8rem;
    background: transparent;
    color: #eee;
    border: 1px solid #555;
    cursor: pointer;
    font-size: 0.85rem;
    height: fit-content;
}

/* Output Panel */
#output-section {
    min-height: 450px;
}
        .story-output {
            flex: 1;
            background: #0a0a0a;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 0.8rem;
            white-space: pre-wrap;
            line-height: 1.4;
            font-size: 0.85rem;
            overflow-y: auto;
            min-height: 320px;
        }
        .output-controls {
            margin-top: 0.6rem;
        }
        
        /* Common button styles */
        button {
            background: transparent;
            color: #eee;
            border: 1px solid #555;
            cursor: pointer;
            font-family: 'Georgia', serif;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #222;
            border-color: #777;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .dejavu-sans-mono { font-family: 'DejaVu Sans Mono', monospace; }
        .dejavu-sans { font-family: 'DejaVu Sans', sans-serif; }
        .dejavu-serif { font-family: 'DejaVu Serif', serif; }
        
        .api-status {
            margin-top: 0.8rem;
            font-size: 0.75rem;
            color: #666;
            text-align: center;
        }
        
        .upload-icon {
            font-size: 1.5rem;
            margin-bottom: 0.3rem;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>CREATIVE WRITING Machine</h1>
    <p class="subtitle">AI-powered storytelling with Ministral 14B Vision ‚Ä¢ Upload images for inspiration</p>

    <div class="container">
        <!-- Column 1: Notepad -->
        <div id="notepad-section" class="panel">
            <h2>Notepad</h2>
            
            <div class="font-selector">
                <label for="fontSelect">Font Style:</label>
                <select id="fontSelect">
                    <option value="dejavu-sans-mono" selected>DejaVu Sans Mono</option>
                    <option value="dejavu-sans">DejaVu Sans</option>
                    <option value="dejavu-serif">Dejavu Serif</option>
                </select>
            </div>

            <textarea id="notepad" placeholder="Write your story ideas, edit AI-generated content, or keep notes here..."></textarea>

            <div class="notepad-controls">
                <button id="exportButton">Export as TXT</button>
                <button id="clearButton">Clear Notepad</button>
            </div>
        </div>

        <!-- Column 2: AI Controls -->
        <div id="ai-controls" class="panel">
            <h2>AI Controls</h2>
            
            <div class="api-key-section">
                <h3>NVIDIA API Key:</h3>
                <input type="password" id="apiKey" placeholder="Enter your nvapi-... key">
                <div class="api-help">
                    Get free key at: build.nvidia.com
                </div>
            </div>

            <!-- Image Upload Section -->
            <div class="image-upload-section">
                <h3>Upload Img  (Optional):</h3>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <p>Drag & drop an image or click to browse</p>
                    <p style="font-size: 0.7rem; color: #666; margin-top: 0.3rem;">PNG, JPG, WebP (Max 5MB)</p>
                </div>
                <input type="file" id="imageUpload" accept="image/png, image/jpeg, image/webp" style="display: none;">
                <div id="imagePreview"></div>
            </div>

            <div class="prompt-section">
                <label for="prompt">Writing Prompt:</label>
                <textarea id="prompt" placeholder="Describe what you want to write about... or ask about your uploaded image"></textarea>
            </div>

            <div class="controls-group">
                <div class="creativity-control">
                    <label for="creativity">Creativity: <span id="creativityValue">0.7</span></label>
                    <input type="range" id="creativity" min="0.1" max="1.0" step="0.1" value="0.7">
                </div>
                <button id="generateButton">Generate</button>
            </div>
        </div>

        <!-- Column 3: Generated Output -->
        <div id="output-section" class="panel">
            <h2>Generated Text</h2>
            <div class="story-output" id="output">
Your AI-generated text will appear here...

Start by entering your API key and a prompt in the middle panel.
Upload an image for visual inspiration!
            </div>
            <div class="output-controls">
                <button id="copyButton" disabled>Import it to Notepad</button>
            </div>
        </div>
    </div>

    <div class="api-status">
        Powered by Mistral Ministral-14B-Instruct-2512 Vision Model ‚Ä¢ Image-to-Text AI
    </div>

    <script>
        // Font handling
        document.getElementById('fontSelect').addEventListener('change', function() {
            const notepad = document.getElementById('notepad');
            notepad.className = this.value;
        });

        // Creativity slider
        document.getElementById('creativity').addEventListener('input', function() {
            document.getElementById('creativityValue').textContent = this.value;
        });

        // Export functionality
        document.getElementById('exportButton').addEventListener('click', function() {
            const content = document.getElementById('notepad').value;
            if (!content.trim()) {
                alert('Notepad is empty!');
                return;
            }
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'creative-writing.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Clear notepad
        document.getElementById('clearButton').addEventListener('click', function() {
            if (confirm('Clear the entire notepad?')) {
                document.getElementById('notepad').value = '';
            }
        });

        // Copy generated story to notepad
        document.getElementById('copyButton').addEventListener('click', function() {
            const output = document.getElementById('output').textContent;
            const notepad = document.getElementById('notepad');
            if (notepad.value) {
                notepad.value += '\n\n' + output;
            } else {
                notepad.value = output;
            }
        });

        // Image upload functionality
        const uploadArea = document.getElementById('uploadArea');
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        let uploadedImage = null;

        // Click to upload
        uploadArea.addEventListener('click', () => {
            imageUpload.click();
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#666';
            uploadArea.style.background = '#222';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#444';
            uploadArea.style.background = '#1a1a1a';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#444';
            uploadArea.style.background = '#1a1a1a';
            
            if (e.dataTransfer.files.length) {
                const file = e.dataTransfer.files[0];
                if (file.type.startsWith('image/')) {
                    handleImageUpload(file);
                } else {
                    alert('Please upload an image file (PNG, JPG, WebP)');
                }
            }
        });

        // File input change
        imageUpload.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleImageUpload(e.target.files[0]);
            }
        });

        // Handle image upload and preview
        function handleImageUpload(file) {
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size should be less than 5MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImage = e.target.result;
                
                // Show preview
                imagePreview.innerHTML = `
                    <img src="${uploadedImage}" alt="Preview">
                    <button class="remove-image" onclick="removeUploadedImage()">Remove Image</button>
                `;
                imagePreview.style.display = 'block';
                
                // Update upload area text
                uploadArea.innerHTML = `
                    <div class="upload-icon">‚úÖ</div>
                    <p>Image uploaded: ${file.name}</p>
                    <p style="font-size: 0.7rem; color: #666; margin-top: 0.3rem;">Click to change</p>
                `;
            };
            reader.readAsDataURL(file);
        }

        // Remove uploaded image
        window.removeUploadedImage = function() {
            uploadedImage = null;
            imagePreview.innerHTML = '';
            imagePreview.style.display = 'none';
            imageUpload.value = '';
            
            // Reset upload area
            uploadArea.innerHTML = `
                <div class="upload-icon">üìÅ</div>
                <p>Drag & drop an image or click to browse</p>
                <p style="font-size: 0.7rem; color: #666; margin-top: 0.3rem;">PNG, JPG, WebP (Max 5MB)</p>
            `;
        };

        // Convert image to base64 (remove data URL prefix)
        function getImageBase64(dataUrl) {
            // Remove the "data:image/xxx;base64," part
            return dataUrl.split(',')[1];
        }

        // Main generation function - UPDATED FOR MINISTRAL WITH IMAGE SUPPORT
        document.getElementById('generateButton').addEventListener('click', async function() {
            const apiKey = document.getElementById('apiKey').value;
            const prompt = document.getElementById('prompt').value;
            const creativity = parseFloat(document.getElementById('creativity').value);
            const output = document.getElementById('output');
            const generateBtn = document.getElementById('generateButton');
            const copyBtn = document.getElementById('copyButton');

            if (!apiKey) {
                output.textContent = '‚ùå Please enter your NVIDIA API Key';
                return;
            }

            if (!prompt && !uploadedImage) {
                output.textContent = '‚ùå Please enter a writing prompt or upload an image';
                return;
            }

            // Show loading state
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            
            if (uploadedImage) {
                output.textContent = '‚è≥ AI is analyzing your image and crafting content...';
            } else {
                output.textContent = '‚è≥ AI is crafting your story...';
            }
            
            copyBtn.disabled = true;

            try {
                // Using CORS proxy to avoid browser restrictions
                const proxyUrl = 'https://lively-limitless.inkrealm.workers.dev/?url=' + encodeURIComponent('https://integrate.api.nvidia.com/v1/chat/completions');
                
                // Prepare messages based on whether we have an image
                let messages = [];
                
                if (uploadedImage) {
                    // Format for image + text input
                    const imageBase64 = getImageBase64(uploadedImage);
                    
                    const contentArray = [];
                    
                    // Add text prompt if provided
                    if (prompt.trim()) {
                        contentArray.push({ "type": "text", "text": prompt });
                    } else {
                        // Default prompt if only image is provided
                        contentArray.push({ "type": "text", "text": "Describe this image and write a creative story inspired by it." });
                    }
                    
                    // Add the image
                    contentArray.push({
                        "type": "image_url",
                        "image_url": {
                            "url": `data:image/jpeg;base64,${imageBase64}`
                        }
                    });
                    
                    messages = [
                        {
                            "role": "system", 
                            "content": "You are a creative writing assistant specializing in vivid, engaging storytelling. When given an image, analyze it carefully and write creative content inspired by it. Focus on rich descriptions, compelling characters, and imaginative plots."
                        },
                        {
                            "role": "user",
                            "content": contentArray
                        }
                    ];
                } else {
                    // Text-only input
                    messages = [
                        {
                            "role": "system", 
                            "content": "You are a creative writing assistant specializing in vivid, engaging storytelling. Write with rich descriptions, compelling characters, and imaginative plots. Focus on showing rather than telling."
                        },
                        {
                            "role": "user", 
                            "content": prompt
                        }
                    ];
                }

                const requestBody = {
                    model: "mistralai/ministral-14b-instruct-2512", // Updated to Ministral model
                    messages: messages,
                    temperature: creativity,
                    top_p: 0.9,
                    max_tokens: 1024,
                    stream: false
                };

                console.log('Sending request to Ministral model:', requestBody);

                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                // Check if response is JSON
                const responseText = await response.text();
                console.log('Raw response:', responseText);

                if (!response.ok) {
                    throw new Error(`API error: ${response.status} - ${responseText}`);
                }

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`Invalid JSON response: ${responseText.substring(0, 100)}...`);
                }
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    output.textContent = data.choices[0].message.content;
                    copyBtn.disabled = false;
                    
                    // Update subtitle based on content type
                    const subtitle = document.querySelector('.subtitle');
                    if (uploadedImage) {
                        subtitle.textContent = 'AI-powered storytelling with Ministral 14B Vision ‚Ä¢ Image analyzed successfully!';
                    }
                } else if (data.error) {
                    throw new Error(data.error.message || 'API returned an error');
                } else {
                    throw new Error('Unexpected response format from AI');
                }

            } catch (error) {
                output.textContent = '‚ùå Error: ' + error.message;
                console.error('Error:', error);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate';
                
                // Reset subtitle after error
                if (uploadedImage) {
                    const subtitle = document.querySelector('.subtitle');
                    subtitle.textContent = 'AI-powered storytelling with Ministral 14B Vision ‚Ä¢ Upload images for inspiration';
                }
            }
        });

        // Allow Enter key to trigger generation (Ctrl+Enter)
        document.getElementById('prompt').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                document.getElementById('generateButton').click();
            }
        });

        // Auto-save API key to localStorage
        document.getElementById('apiKey').addEventListener('change', function(e) {
            if (e.target.value) {
                localStorage.setItem('nvidia_api_key', e.target.value);
            }
        });

        // Load saved API key
        const savedKey = localStorage.getItem('nvidia_api_key');
        if (savedKey) {
            document.getElementById('apiKey').value = savedKey;
        }
    </script>
</body>
</html>
