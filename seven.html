<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Wordstar Nexus Seven - The Redux." />
<title>WordStar Nexus Seven</title>
<!-- Using VT323 for that instant DOS feel without needing local files -->
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

<style>
  :root {
    --bg-color: #050505;
    --text-color: #b0b0b0;
    --accent-red: #cc0000;
    --dim-grey: #333;
    --crt-scanline: rgba(0, 0, 0, 0.5);
  }

  /* Custom Scrollbar */
  ::-webkit-scrollbar { width: 12px; }
  ::-webkit-scrollbar-track { background: #111; border-left: 1px solid #333; }
  ::-webkit-scrollbar-thumb { background: var(--dim-grey); border: 1px solid #000; }
  ::-webkit-scrollbar-thumb:hover { background: var(--accent-red); }

  body, html {
    margin: 0;
    padding: 0;
    font-family: 'VT323', 'Courier New', monospace; /* DOS Font Fallback */
    background-color: var(--bg-color);
    color: var(--text-color);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Prevent body scroll, handle inside elements */
  }

  /* CRT Scanline Overlay */
  .crt::before {
    content: " ";
    display: block;
    position: absolute;
    top: 0; left: 0; bottom: 0; right: 0;
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
    z-index: 999;
    background-size: 100% 2px, 3px 100%;
    pointer-events: none;
  }

  /* Menu Bar (Top) */
  #top-menu-bar {
    background-color: #111;
    padding: 2px 10px;
    display: flex;
    justify-content: flex-start;
    border-bottom: 2px solid var(--accent-red);
    font-size: 1.2rem;
    user-select: none;
  }
  .menu-item {
    margin-right: 20px;
    cursor: pointer;
    text-transform: uppercase;
  }
  .menu-item:hover { background-color: var(--accent-red); color: #000; }
  .shortcut { color: var(--accent-red); margin-right: 2px; }
  .menu-item:hover .shortcut { color: #000; }

  /* Editor Area */
  #editor-container {
    flex-grow: 1;
    position: relative;
    display: flex;
    flex-direction: column;
    background-color: #0a0a0a;
  }

  #ruler {
    display: flex;
    background: #111;
    color: #555;
    font-size: 1rem;
    padding: 2px 0;
    border-bottom: 1px dashed #333;
  }

  textarea#editor {
    flex-grow: 1;
    background-color: transparent;
    color: #e0e0e0;
    border: none;
    padding: 20px;
    font-size: 1.4rem; /* Larger for VT323 */
    line-height: 1.4;
    font-family: 'VT323', monospace;
    resize: none;
    outline: none;
    white-space: pre-wrap;
  }
  
  /* The "Page" look in Reading Mode */
  textarea#editor.reading-mode {
    max-width: 800px;
    margin: 0 auto;
    border-left: 1px solid #333;
    border-right: 1px solid #333;
    background-color: #0e0e0e;
  }

  /* Bottom Panel (Dashboard) */
  #dashboard {
    height: 250px; /* Fixed height for tools */
    display: flex;
    border-top: 4px solid var(--accent-red);
    background-color: #111;
  }

  .dashboard-panel {
    flex: 1;
    padding: 10px;
    border-right: 1px solid #333;
    overflow: hidden;
    position: relative;
  }

  /* Status Bar */
  #status-bar {
    background-color: var(--accent-red);
    color: black;
    padding: 2px 10px;
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    font-size: 1.1rem;
    text-transform: uppercase;
  }

  /* Map Styling */
  #map {
    width: 100%;
    height: 100%;
    /* Desaturate map to fit Red/Black theme */
    filter: grayscale(100%) contrast(1.2) brightness(0.8);
    transition: filter 0.3s;
  }
  #map:hover { filter: grayscale(0%); } /* Color on hover */

  /* Pantheon Gif */
  .pantheon-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #000;
  }
  .pantheon-container img {
    height: 120px;
    filter: sepia(100%) hue-rotate(-50deg) saturate(300%); /* Make it Red/Amber */
    opacity: 0.8;
  }

  /* Helper Classes */
  .hidden { display: none !important; }

  /* Dropdown Menus */
  .dropdown-menu {
    position: absolute;
    background-color: #111;
    border: 1px solid var(--accent-red);
    z-index: 1000;
    box-shadow: 4px 4px 0px rgba(0,0,0,0.8);
  }
  .dropdown-item {
    padding: 5px 15px;
    cursor: pointer;
    color: #ccc;
    font-family: 'VT323', monospace;
    font-size: 1.2rem;
  }
  .dropdown-item:hover {
    background-color: var(--accent-red);
    color: black;
  }

</style>
</head>
<body class="crt">

    <!-- Top App Menu -->
    <div id="top-menu-bar">
        <div class="menu-item tab">File</div>
        <div class="menu-item tab">Edit</div>
        <div class="menu-item tab">Format</div>
        <div class="menu-item tab">View</div>
        <div class="menu-item tab">Tools</div>
        <div class="menu-item tab">Help</div>
    </div>

    <!-- Main Editor -->
    <div id="editor-container">
        <div id="ruler" class="hidden"></div> <!-- Hidden by default, toggled via ^R -->
        <textarea id="editor" spellcheck="false" placeholder="NEXUS SEVEN... SYSTEM READY.">Slide this frame out, to fit as needed. Version-control-3, 2nd environment. (Some features are still under construction) Welcome to WordStar Nexus Seven! A writing space. Enjoy the feel of the classic word processing preferred by William F Buckley jr. now with modern web technologies. (^=ctrl...the map is tracking the international space station in real time...)</textarea>
    </div>

    <!-- Status Bar -->
    <div id="status-bar">
        <span id="file-name">UNTITLED.WS7</span>
        <span id="cursor-position">L:01 C:01</span>
        <span id="iss-telemetry">ISS: ACQUIRING SIGNAL...</span>
        <span id="insert-mode">INSERT</span>
    </div>

    <!-- Dashboard (Map & Info) -->
    <div id="dashboard">
        <!-- Quick Command Reference (Classic WordStar style) -->
        <div class="dashboard-panel" style="flex: 0 0 200px; font-size: 0.9rem;">
            <div style="color: var(--accent-red); margin-bottom: 5px; border-bottom: 1px solid #333;">COMMANDS</div>
            <div><span class="shortcut">^S</span> Save File</div>
            <div><span class="shortcut">^B</span> Bold Text</div>
            <div><span class="shortcut">^I</span> Italic</div>
            <div><span class="shortcut">^K</span> Block Menu</div>
            <div><span class="shortcut">^Q</span> Quick Menu</div>
            <div><span class="shortcut">^R</span> Toggle Ruler</div>
            <div><span class="shortcut">^M</span> Read Mode</div>
        </div>

        <!-- ISS Map -->
        <div class="dashboard-panel" style="flex: 2;">
             <div id="map"></div>
             <div style="position: absolute; top: 5px; right: 5px; background: black; color: red; padding: 2px; font-size: 0.8rem; z-index: 1000;">
                 <span id="lat">0.00</span>, <span id="lon">0.00</span> | <span id="day-night">...</span>
             </div>
        </div>

        <!-- Pantheon/Logo Area -->
        <div class="dashboard-panel pantheon-container" style="flex: 0 0 200px;">
            <img src="https://raw.githubusercontent.com/ghostm68/pantheon/main/quirky.gif" alt="Pantheon">
            <div style="margin-top: 10px; font-size: 0.8rem; color: #555;">SYSTEM: ONLINE</div>
        </div>
    </div>

<!-- SCRIPTS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>

<script>
/** 
 * EDITOR LOGIC 
 */
const editor = document.getElementById('editor');
const ruler = document.getElementById('ruler');
const cursorDisplay = document.getElementById('cursor-position');

// Initialize Ruler
for (let i = 1; i <= 80; i++) {
    const mark = document.createElement('span');
    mark.style.flex = '0 0 1.25%'; // Approx width
    mark.style.textAlign = 'center';
    mark.textContent = (i % 10 === 0) ? (i/10) : (i % 5 === 0 ? '+' : '-');
    ruler.appendChild(mark);
}

// Update Cursor Position
const updateStatus = () => {
    const text = editor.value;
    const cursorPos = editor.selectionStart;
    const lines = text.substr(0, cursorPos).split("\n");
    const currentLine = lines.length;
    const currentPos = lines[lines.length - 1].length + 1;
    cursorDisplay.textContent = `L:${currentLine.toString().padStart(2,'0')} C:${currentPos.toString().padStart(2,'0')}`;
};

editor.addEventListener('input', updateStatus);
editor.addEventListener('click', updateStatus);
editor.addEventListener('keyup', updateStatus);

// Formatting Commands
const format = (cmd, value=null) => document.execCommand(cmd, false, value);

// Keybinding Handler (The Nexus "Chord" System)
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey) {
        const key = e.key.toLowerCase();
        
        // Prevent default browser actions for these keys
        if (['s','b','i','u','r','m','p'].includes(key)) {
            e.preventDefault();
        }

        switch(key) {
            case 'b': format('bold'); break;
            case 'i': format('italic'); break;
            case 'u': format('underline'); break;
            case 's': saveDocument(); break;
            case 'r': ruler.classList.toggle('hidden'); break;
            case 'm': 
                editor.classList.toggle('reading-mode'); 
                alert("TOGGLING READING MODE");
                break;
            case 'l': generateLoremIpsum(); break;
        }
    }
});

function saveDocument() {
    const blob = new Blob([editor.value], {type: 'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'nexus_log.txt';
    a.click();
}

function generateLoremIpsum() {
    const text = "\n[TRANSMISSION START]\nMore people die every year as a result of the war against drugs than die from what we call, generically, overdosing...\n[TRANSMISSION END]\n";
    editor.setRangeText(text, editor.selectionStart, editor.selectionEnd, 'end');
}

/**
 * MENU SYSTEM
 */
const tabs = document.querySelectorAll('.tab');
tabs.forEach(tab => {
    tab.addEventListener('click', function(e) {
        // Simple alert for now, you can hook your previous complex menu logic here
        const menuName = this.textContent;
        // alert(`ACCESSING ${menuName} SUBROUTINE...`);
        // Note: To re-implement the full dropdowns, paste your previous showMenu() function here
    });
});

/**
 * ISS TRACKER & MAP LOGIC
 */
const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([0, 0], 2);

// Dark Matter Map Tiles
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
	subdomains: 'abcd',
	maxZoom: 19
}).addTo(map);

// Custom ISS Icon
const issIcon = L.icon({
    iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/d/d0/International_Space_Station.svg',
    iconSize: [40, 24],
    iconAnchor: [20, 12],
    className: 'iss-icon-filter' // We could add CSS filter to icon too
});

const issMarker = L.marker([0, 0], {icon: issIcon}).addTo(map);
const issTrail = L.polyline([], {color: '#cc0000', weight: 1, opacity: 0.7}).addTo(map);

async function updateISS() {
    try {
        const response = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
        const data = await response.json();
        const { latitude, longitude, altitude, velocity } = data;

        issMarker.setLatLng([latitude, longitude]);
        issTrail.addLatLng([latitude, longitude]);
        map.panTo([latitude, longitude]);

        // Update DOM
        document.getElementById('lat').textContent = latitude.toFixed(2);
        document.getElementById('lon').textContent = longitude.toFixed(2);
        document.getElementById('iss-telemetry').textContent = `ISS: ALT ${altitude.toFixed(0)}KM // VEL ${velocity.toFixed(0)}KPH`;
        
        // SunCalc
        const times = SunCalc.getTimes(new Date(), latitude, longitude);
        const isDay = new Date() > times.sunrise && new Date() < times.sunset;
        document.getElementById('day-night').textContent = isDay ? "DAYLIGHT" : "ECLIPSE";
        document.getElementById('day-night').style.color = isDay ? "#fff" : "#555";

    } catch (e) {
        console.log("Telemetry Signal Lost");
    }
}

// Update loop
setInterval(updateISS, 2000);
updateISS();

</script>
</body>
</html>
