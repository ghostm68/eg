<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Wordstar Nexus Seven - The Redux." />
<title>WordStar Nexus Seven</title>
<!-- VT323 for the retro terminal look -->
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

<style>
  :root {
    --bg-color: #050505;
    --text-color: #b0b0b0;
    --accent-red: #cc0000;
    --dim-grey: #333;
    --menu-bg: #111;
  }

  /* Custom Scrollbar */
  ::-webkit-scrollbar { width: 12px; }
  ::-webkit-scrollbar-track { background: #111; border-left: 1px solid #333; }
  ::-webkit-scrollbar-thumb { background: var(--dim-grey); border: 1px solid #000; }
  ::-webkit-scrollbar-thumb:hover { background: var(--accent-red); }

  body, html {
    margin: 0;
    padding: 0;
    font-family: 'VT323', 'Courier New', monospace;
    background-color: var(--bg-color);
    color: var(--text-color);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden; 
  }

  /* CRT Scanline Overlay */
  .crt::before {
    content: " ";
    display: block;
    position: absolute;
    top: 0; left: 0; bottom: 0; right: 0;
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
    z-index: 999;
    background-size: 100% 2px, 3px 100%;
    pointer-events: none;
  }

  /* Menu Bar (Top) */
  #top-menu-bar {
    background-color: var(--menu-bg);
    padding: 0 10px;
    display: flex;
    justify-content: flex-start;
    border-bottom: 2px solid var(--accent-red);
    font-size: 1.3rem;
    user-select: none;
    height: 35px;
    align-items: center;
  }
  
  .menu-item {
    margin-right: 20px;
    cursor: pointer;
    text-transform: uppercase;
    padding: 5px 10px;
    position: relative; /* For positioning dropdowns if needed */
  }
  
  .menu-item:hover { 
    background-color: var(--accent-red); 
    color: #000; 
  }

  /* Dropdown Menus */
  .dropdown-menu {
    position: absolute;
    background-color: #000;
    border: 1px solid var(--accent-red);
    z-index: 1000;
    box-shadow: 5px 5px 10px rgba(0,0,0,0.8);
    min-width: 150px;
    display: flex;
    flex-direction: column;
  }

  .dropdown-option {
    padding: 8px 15px;
    cursor: pointer;
    color: #ccc;
    font-family: 'VT323', monospace;
    font-size: 1.2rem;
    border-bottom: 1px solid #222;
  }

  .dropdown-option:hover {
    background-color: var(--accent-red);
    color: black;
  }

  /* Editor Area */
  #editor-container {
    flex-grow: 1;
    position: relative;
    display: flex;
    flex-direction: column;
    background-color: #0a0a0a;
  }

  #ruler {
    display: flex;
    background: #111;
    color: #555;
    font-size: 1rem;
    padding: 2px 0;
    border-bottom: 1px dashed #333;
  }

  textarea#editor {
    flex-grow: 1;
    background-color: transparent;
    color: #e0e0e0;
    border: none;
    padding: 20px;
    font-size: 1.4rem; 
    line-height: 1.4;
    font-family: 'VT323', monospace;
    resize: none;
    outline: none;
    white-space: pre-wrap;
  }
  
  /* Reading Mode Style */
  textarea#editor.reading-mode {
    max-width: 800px;
    margin: 0 auto;
    border-left: 1px solid #333;
    border-right: 1px solid #333;
    background-color: #0e0e0e;
  }

  /* Dashboard (Bottom) */
  #dashboard {
    height: 250px; 
    display: flex;
    border-top: 4px solid var(--accent-red);
    background-color: #111;
  }

  .dashboard-panel {
    flex: 1;
    padding: 10px;
    border-right: 1px solid #333;
    overflow: hidden;
    position: relative;
  }

  /* Status Bar */
  #status-bar {
    background-color: var(--accent-red);
    color: black;
    padding: 2px 10px;
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    font-size: 1.1rem;
    text-transform: uppercase;
  }

  /* Map Styling */
  #map {
    width: 100%;
    height: 100%;
    filter: grayscale(100%) contrast(1.2) brightness(0.8);
    transition: filter 0.3s;
  }
  #map:hover { filter: grayscale(0%); }

  .pantheon-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #000;
  }
  .pantheon-container img {
    height: 120px;
    filter: sepia(100%) hue-rotate(-50deg) saturate(300%);
    opacity: 0.8;
  }

  .hidden { display: none !important; }

</style>
</head>
<body class="crt">

    <!-- Top App Menu -->
    <div id="top-menu-bar">
        <div class="menu-item tab" data-menu="file">File</div>
        <div class="menu-item tab" data-menu="edit">Edit</div>
        <div class="menu-item tab" data-menu="format">Format</div>
        <div class="menu-item tab" data-menu="view">View</div>
        <div class="menu-item tab" data-menu="tools">Tools</div>
        <div class="menu-item tab" data-menu="help">Help</div>
    </div>

    <!-- Main Editor -->
    <div id="editor-container">
        <div id="ruler" class="hidden"></div> 
        <textarea id="editor" spellcheck="false" placeholder="NEXUS SEVEN... SYSTEM READY.">Slide this frame out, to fit as needed. Version-control-3, 2nd environment. (Some features are still under construction) Welcome to WordStar Nexus Seven! A writing space. Enjoy the feel of the classic word processing preferred by William F Buckley jr. now with modern web technologies. (^=ctrl...the map is tracking the international space station in real time...)</textarea>
    </div>

    <!-- Status Bar -->
    <div id="status-bar">
        <span id="file-name">UNTITLED.WS7</span>
        <span id="cursor-position">L:01 C:01</span>
        <span id="iss-telemetry">ISS: ACQUIRING SIGNAL...</span>
        <span id="insert-mode">INSERT</span>
    </div>

    <!-- Dashboard -->
    <div id="dashboard">
        <div class="dashboard-panel" style="flex: 0 0 200px; font-size: 0.9rem;">
            <div style="color: var(--accent-red); margin-bottom: 5px; border-bottom: 1px solid #333;">COMMANDS</div>
            <div><span style="color:red">^S</span> Save File</div>
            <div><span style="color:red">^B</span> Bold Text</div>
            <div><span style="color:red">^I</span> Italic</div>
            <div><span style="color:red">^Q</span> Quick Menu</div>
            <div><span style="color:red">^R</span> Toggle Ruler</div>
            <div><span style="color:red">^M</span> Read Mode</div>
        </div>

        <div class="dashboard-panel" style="flex: 2;">
             <div id="map"></div>
             <div style="position: absolute; top: 5px; right: 5px; background: black; color: red; padding: 2px; font-size: 0.8rem; z-index: 1000;">
                 <span id="lat">0.00</span>, <span id="lon">0.00</span> | <span id="day-night">...</span>
             </div>
        </div>

        <div class="dashboard-panel pantheon-container" style="flex: 0 0 200px;">
            <img src="https://raw.githubusercontent.com/ghostm68/pantheon/main/quirky.gif" alt="Pantheon">
            <div style="margin-top: 10px; font-size: 0.8rem; color: #555;">SYSTEM: ONLINE</div>
        </div>
    </div>

<!-- SCRIPTS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>

<script>
/** 
 * EDITOR LOGIC 
 */
const editor = document.getElementById('editor');
const ruler = document.getElementById('ruler');
const cursorDisplay = document.getElementById('cursor-position');

// Initialize Ruler
for (let i = 1; i <= 80; i++) {
    const mark = document.createElement('span');
    mark.style.flex = '0 0 1.25%'; 
    mark.style.textAlign = 'center';
    mark.textContent = (i % 10 === 0) ? (i/10) : (i % 5 === 0 ? '+' : '-');
    ruler.appendChild(mark);
}

// Update Cursor Stats
const updateStatus = () => {
    const text = editor.value;
    const cursorPos = editor.selectionStart;
    const lines = text.substr(0, cursorPos).split("\n");
    const currentLine = lines.length;
    const currentPos = lines[lines.length - 1].length + 1;
    cursorDisplay.textContent = `L:${currentLine.toString().padStart(2,'0')} C:${currentPos.toString().padStart(2,'0')}`;
};
editor.addEventListener('input', updateStatus);
editor.addEventListener('click', updateStatus);
editor.addEventListener('keyup', updateStatus);

// Core Functions
const format = (cmd, value=null) => document.execCommand(cmd, false, value);

function saveDocument() {
    const blob = new Blob([editor.value], {type: 'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'nexus_log.txt';
    a.click();
}

function toggleReadingMode() {
    editor.classList.toggle('reading-mode');
}

function generateLoremIpsum() {
    const text = "More people die every year as a result of the war against drugs than die from what we call, generically, overdosing...";
    editor.setRangeText(text, editor.selectionStart, editor.selectionEnd, 'end');
}

/**
 * MENU SYSTEM (Restored & Updated)
 */
const tabs = document.querySelectorAll('.tab');

tabs.forEach(tab => {
    tab.addEventListener('click', function(e) {
        e.stopPropagation(); // Prevent closing immediately
        const menuName = this.dataset.menu;
        showMenu(menuName, this);
    });
});

function showMenu(menuName, targetElement) {
    // 1. Remove existing menus
    closeAllMenus();

    // 2. Define Menu Items
    let items = [];
    switch(menuName) {
        case 'file':
            items = [
                { name: 'New', action: () => { if(confirm('Clear?')) editor.value = ''; } },
                { name: 'Open', action: () => { alert('Open Dialog (Simulated)'); } },
                { name: 'Save (^S)', action: saveDocument },
                { name: 'Print', action: () => window.print() },
                { name: 'Exit', action: () => window.close() }
            ];
            break;
        case 'edit':
            items = [
                { name: 'Cut', action: () => document.execCommand('cut') },
                { name: 'Copy', action: () => document.execCommand('copy') },
                { name: 'Paste', action: () => navigator.clipboard.readText().then(t => editor.setRangeText(t)) },
                { name: 'Select All', action: () => editor.select() }
            ];
            break;
        case 'format':
            items = [
                { name: 'Bold (^B)', action: () => format('bold') },
                { name: 'Italic (^I)', action: () => format('italic') },
                { name: 'Underline (^U)', action: () => format('underline') }
            ];
            break;
        case 'view':
            items = [
                { name: 'Toggle Ruler (^R)', action: () => ruler.classList.toggle('hidden') },
                { name: 'Reading Mode (^M)', action: toggleReadingMode },
                { name: 'Status Bar', action: () => document.getElementById('status-bar').classList.toggle('hidden') }
            ];
            break;
        case 'tools':
            items = [
                { name: 'Word Count', action: () => alert('Words: ' + editor.value.trim().split(/\s+/).length) },
                { name: 'Lorem Ipsum (^L)', action: generateLoremIpsum }
            ];
            break;
        case 'help':
            items = [
                { name: 'About Nexus', action: () => alert('WordStar Nexus Seven\nVersion 3.0 (Redux)') }
            ];
            break;
    }

    // 3. Create DOM Elements
    const menuDiv = document.createElement('div');
    menuDiv.className = 'dropdown-menu';
    
    // Position it just below the clicked tab
    const rect = targetElement.getBoundingClientRect();
    menuDiv.style.left = rect.left + 'px';
    menuDiv.style.top = (rect.bottom + 2) + 'px';

    items.forEach(item => {
        const option = document.createElement('div');
        option.className = 'dropdown-option';
        option.textContent = item.name;
        option.onclick = (e) => {
            e.stopPropagation();
            item.action();
            closeAllMenus();
        };
        menuDiv.appendChild(option);
    });

    document.body.appendChild(menuDiv);

    // 4. Add listener to close menu when clicking outside
    document.addEventListener('click', closeAllMenus, { once: true });
}

function closeAllMenus() {
    const existing = document.querySelectorAll('.dropdown-menu');
    existing.forEach(el => el.remove());
}


/**
 * ISS TRACKER & MAP
 */
const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([0, 0], 2);

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
	subdomains: 'abcd',
	maxZoom: 19
}).addTo(map);

const issIcon = L.icon({
    iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/d/d0/International_Space_Station.svg',
    iconSize: [40, 24],
    iconAnchor: [20, 12]
});

const issMarker = L.marker([0, 0], {icon: issIcon}).addTo(map);
const issTrail = L.polyline([], {color: '#cc0000', weight: 1, opacity: 0.7}).addTo(map);

async function updateISS() {
    try {
        const response = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
        const data = await response.json();
        const { latitude, longitude, altitude, velocity } = data;

        issMarker.setLatLng([latitude, longitude]);
        issTrail.addLatLng([latitude, longitude]);
        map.panTo([latitude, longitude]);

        document.getElementById('lat').textContent = latitude.toFixed(2);
        document.getElementById('lon').textContent = longitude.toFixed(2);
        document.getElementById('iss-telemetry').textContent = `ISS: ALT ${altitude.toFixed(0)}KM // VEL ${velocity.toFixed(0)}KPH`;
        
        const times = SunCalc.getTimes(new Date(), latitude, longitude);
        const isDay = new Date() > times.sunrise && new Date() < times.sunset;
        document.getElementById('day-night').textContent = isDay ? "DAYLIGHT" : "ECLIPSE";
        document.getElementById('day-night').style.color = isDay ? "#fff" : "#555";

    } catch (e) {
        // Silent fail for offline dev
    }
}
setInterval(updateISS, 3000);
updateISS();

</script>
</body>
</html>
