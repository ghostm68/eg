<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QUANTUM WORDSTAR 2077</title>
 <script type="text/javascript" src="https://unpkg.com/quantum-circuit"></script> 
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#050000;
  --paper:#ffcccc;
  --dim:#884444;
  --iron:#4a2a2a;
  --blood:#ff0000;
  --shadow:#1a0000;
  --crt-glow:rgba(255,0,0,.15);
}
body{margin:0;height:100vh;display:flex;flex-direction:column;font-family:'VT323',monospace;font-size:24px;background:var(--bg);color:var(--paper);overflow:hidden;user-select:none;text-shadow:0 0 2px var(--dim),0 0 5px var(--crt-glow);}
body::after{content:"";position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent 0 2px,rgba(0,0,0,.5) 3px 4px),repeating-linear-gradient(90deg,var(--crt-glow),transparent 2px,rgba(0,0,0,.1) 4px);pointer-events:none;z-index:100;mix-blend-mode:multiply;}
#header-band{flex:0 0 30px;background:var(--iron);color:var(--bg);display:flex;justify-content:space-between;align-items:center;padding:0 12px;text-transform:uppercase;font-weight:bold;letter-spacing:1px;border-bottom:2px solid var(--blood);z-index:10;}
#edit-block{flex:0 0 auto;padding:8px 12px;border-bottom:1px solid var(--dim);background:var(--bg);}
.dos-box{border:2px solid var(--dim);position:relative;padding:10px 8px;margin:0;}
.dos-box legend{position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:var(--bg);padding:0 6px;color:var(--blood);font-weight:bold;}
.menu-grid{display:flex;gap:20px;justify-content:center;font-size:1rem;}
.cmd{cursor:pointer;transition:color .2s;}
.cmd:hover{color:var(--blood);text-shadow:0 0 8px var(--blood);}
.cmd span{font-weight:bold;color:var(--blood);margin-right:4px;}
#ruler{flex:0 0 20px;padding:0 12px;color:var(--dim);white-space:pre;overflow:hidden;border-bottom:1px solid var(--iron);transition:border-bottom-color .15s;}
#viewport{flex:1 1 auto;padding:15px 12px;font-size:24px;line-height:1.4;overflow-y:auto;outline:none;cursor:text;animation:textFlicker .1s infinite;}
@keyframes textFlicker{0%,100%{opacity:.99;}50%{opacity:.97;}}
#viewport:focus-within{animation:jitter .12s infinite;}
@keyframes jitter{0%,100%{transform:translateY(.05px);}50%{transform:translateY(-.05px);}}
#viewport b{color:var(--blood);font-weight:normal;text-shadow:0 0 4px var(--blood);}
#viewport u{text-decoration:none;border-bottom:2px solid var(--blood);}
#f-key-strip{flex:0 0 40px;display:flex;background:var(--shadow);border-top:1px solid var(--blood);border-bottom:1px solid var(--blood);z-index:10;}
.f-key{flex:1;display:flex;align-items:center;justify-content:center;border-right:1px solid var(--iron);cursor:pointer;transition:.1s;font-size:18px;}
.f-key:hover{background:var(--iron);color:var(--paper);}
.f-key:active{background:var(--blood);color:var(--bg);}
.f-key b{margin-right:5px;color:var(--paper);}
#info-line{flex:0 0 24px;background:var(--iron);color:var(--bg);text-align:right;padding:0 12px;font-size:.8rem;display:flex;align-items:center;justify-content:flex-end;gap:15px;}
#info-line span{color:var(--paper);font-weight:bold;}
.online{background:var(--blood);color:var(--bg);padding:0 4px;}
small{font-size:11px;color:var(--dim);}
</style>
</head>
<body>
<div id="header-band">
  <span>C:\QUANTUM.DOC</span>
  <span id="status-readout">P 01 L 01 C 01</span>
  <span id="mode-indicator">INSERT | LOCAL</span>
</div>

<div id="edit-block">
  <fieldset class="dos-box">
    <legend>≡ Q U A N T U M   M E N U ≡</legend>
    <div class="menu-grid">
      <div class="cmd" data-fkey="F1"><span>F1</span>GENERATE</div>
      <div class="cmd" data-fkey="F2"><span>F2</span>COLLAPSE</div>
      <div class="cmd" data-fkey="F3"><span>F3</span>SAVE</div>
      <div class="cmd" data-fkey="F4"><span>F4</span>PRINT</div>
    </div>
  </fieldset>
</div>

<div id="ruler">L────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────R</div>

<div id="viewport" contenteditable="true" spellcheck="false">Initializing Quantum Core...<br>Ready for Input.</div>

<div id="f-key-strip">
  <div class="f-key" data-fkey="F1"><b>F1</b>Gen<br><small>GENERATE</small></div>
  <div class="f-key" data-fkey="F2"><b>F2</b>WvFn<br><small>COLLAPSE</small></div>
  <div class="f-key" data-fkey="F3"><b>F3</b>Save<br><small>DISK</small></div>
  <div class="f-key" data-fkey="F4"><b>F4</b>Prnt<br><small>PRINT</small></div>
  <div class="f-key" data-fkey="F5"><b>F5</b>Purge<br><small>CLEAR</small></div>
  <div class="f-key" data-fkey="F6"><b>F6</b>Bold<br><small>BOLD</small></div>
  <div class="f-key" data-fkey="F7"><b>F7</b>Undr<br><small>UNDER</small></div>
  <div class="f-key" data-fkey="F8"><b>F8</b>Find<br><small>SEARCH</small></div>
  <div class="f-key" data-fkey="F9"><b>F9</b>Help<br><small>HELP</small></div>
  <div class="f-key" data-fkey="F10"><b>F10</b>Exit<br><small>REBOOT</small></div>
</div>

<div id="info-line">
  Quantum DisplayWriter 370 | Memory: 640 K | Entropy: <span id="entropy-source">INITIALIZING...</span>
</div>

<script type="module">
import * as qr from 'https://unpkg.com/quantum-circuit@0.9.246/lib/quantum-circuit.min.mjs';

/* ----------  state  ---------- */
const VIEWPORT = document.getElementById('viewport');
const STATUS = document.getElementById('status-readout');
const MODE = document.getElementById('mode-indicator');
const ENTROPY = document.getElementById('entropy-source');
const RULER = document.getElementById('ruler');
const HORSE = 'https://raw.githubusercontent.com/ghostm68/eg/refs/heads/main/horse.txt';

let liveLex = null, insertMode = true;
const FB = {
  nouns: ["nebula","echo","whisper","chronometer","void","nexus","fragment","signal","horizon","monolith","algorithm","spectre","isotope","vortex","cipher","drone","glitch","network","phantom","mainframe","reactor","synapse","artifact","shard","memory","paradox","entropy","vector","protocol","silence","shadow","circuit"],
  verbs: ["fractured","hummed","collapsed","drifted","ignited","observed","shattered","pulsed","dissolved","encoded","transmitted","erased","aligned","resonated","orbited","scanned","corrupted","merged","decoded","manifested","echoed","vibrated","locked","severed","mapped","synced","traced","hunted","breached","calibrated","awoke","slept"],
  adjs: ["silent","obsidian","infinite","hollow","electric","forgotten","crimson","static","digital","frozen","luminous","fractal","haunted","cybernetic","terminal","kinetic","dormant","volatile","synthetic","solar","magnetic","spectral","unseen","ancient","liquid","binary","nuclear","astral","chrome","velvet","fading","hidden"]
};

/* ----------  quantum functions  ---------- */
function quantumChoice(list) {
  const qc = new qr.QuantumCircuit(5);
  for (let i = 0; i < 5; i++) qc.addGate('h', i, i);
  qc.run();
  const p = qc.getState().map(s => s.magnitude ** 2);
  let r = Math.random(), i = 0;
  for (; i < p.length; i++) {
    r -= p[i];
    if (r <= 0) break;
  }
  return list[i % list.length];
}

function generate() {
  const nouns = liveLex || FB.nouns;
  const verbs = FB.verbs;
  const adjs = FB.adjs;
  const txt = ` The <b>${quantumChoice(adjs)}</b> ${quantumChoice(nouns)} <u>${quantumChoice(verbs)}</u>.`;
  document.execCommand('insertHTML', false, txt);
}

function collapse() {
  const hex = [...Array(6)].map(() => Math.floor(Math.random() * 255).toString(16).padStart(2, '0')).join(':');
  document.execCommand('insertHTML', false, `<br><span style="background:var(--blood);color:var(--bg)">[ENTROPY:${hex.toUpperCase()}]</span><br>`);
}

function rulerBlink() {
  RULER.style.borderBottomColor = 'var(--blood)';
  setTimeout(() => RULER.style.borderBottomColor = '', 150);
}

/* ----------  editing functions  ---------- */
function cmd(c) {
  const s = window.getSelection();
  if (!s.rangeCount) return;
  switch(c) {
    case 'left': case 'right': case 'up': case 'down': case 'wordLeft': case 'wordRight':
      s.modify('move', 
        c.includes('Left') || c === 'left' || c === 'up' ? 'backward' : 'forward', 
        c.includes('word') ? 'word' : (c.includes('Left') || c === 'left' || c === 'right') ? 'character' : 'line'
      );
      break;
    case 'delChar': 
      document.execCommand('delete'); 
      break;
    case 'delLine':
      s.modify('move', 'backward', 'lineboundary');
      s.modify('extend', 'forward', 'lineboundary');
      document.execCommand('delete');
      break;
    case 'bold': case 'underline': 
      document.execCommand(c); 
      break;
  }
}

function save80() {
  const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>quantum-backup</title><style>body{background:#000;color:#fcc;font:22px/1.4 VT323,monospace;white-space:pre-wrap;}</style></head><body>${VIEWPORT.innerHTML}</body></html>`;
  const blob = new Blob([html], {type: 'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'quantum-backup.html';
  a.click();
}

function updateUI() {
  const sel = window.getSelection();
  if (!sel.rangeCount) return;
  const range = sel.getRangeAt(0);
  const pre = range.cloneRange();
  pre.selectNodeContents(VIEWPORT);
  pre.setEnd(range.endContainer, range.endOffset);
  const txt = pre.toString();
  const lines = txt.split('\n');
  const L = lines.length;
  const C = lines[L - 1].length + 1;
  const P = Math.floor(L / 50) + 1;
  
  STATUS.textContent = `P ${String(P).padStart(2, '0')} L ${String(L).padStart(2, '0')} C ${String(C).padStart(2, '0')}`;
  MODE.textContent = `${insertMode ? 'INSERT' : 'OVERSTRIKE'} | ${liveLex ? 'ONLINE' : 'LOCAL'}`;
  MODE.classList.toggle('online', liveLex);
}

function beep() {
  try {
    const c = new (window.AudioContext || window.webkitAudioContext)();
    const o = c.createOscillator();
    o.type = 'square';
    o.frequency.value = 880;
    o.connect(c.destination);
    o.start();
    o.stop(c.currentTime + 0.06);
  } catch (e) {
    console.log('Audio not supported');
  }
}

/* ----------  F-key handler  ---------- */
function triggerFKey(k) {
  switch(k) {
    case 'F1': generate(); break;
    case 'F2': collapse(); break;
    case 'F3': save80(); break;
    case 'F4': window.print(); break;
    case 'F5': 
      if (confirm('PURGE BUFFER?')) VIEWPORT.innerHTML = ''; 
      break;
    case 'F6': cmd('bold'); break;
    case 'F7': cmd('underline'); break;
    case 'F8': {
      const s = prompt('SEARCH:');
      if (s) window.find(s);
      break;
    }
    case 'F9': 
      alert('F1-F10  |  Ctrl+1-0 (laptop)  |  Ctrl+S/E/D/X move  |  Ctrl+Y kill line');
      break;
    case 'F10': location.reload(); break;
  }
  VIEWPORT.focus();
  updateUI();
}

/* ----------  boot  ---------- */
(async () => {
  VIEWPORT.focus();
  ENTROPY.textContent = 'CONNECTING...';
  
  try {
    const txt = await (await fetch(HORSE)).text();
    const words = [...new Set(txt.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/).filter(w => w.length > 4))];
    if (words.length < 10) throw new Error('short');
    liveLex = words;
    ENTROPY.innerHTML = '<span class="online">HORSE.TXT</span>';
    MODE.classList.add('online');
    rulerBlink();
    beep();
  } catch {
    ENTROPY.textContent = 'INTERNAL BUFFER';
  }
  
  updateUI();
})();

/* ----------  event listeners  ---------- */
// Add click listeners to all F-key buttons
document.querySelectorAll('.cmd, .f-key').forEach(button => {
  button.addEventListener('click', (e) => {
    const fkey = e.currentTarget.getAttribute('data-fkey');
    if (fkey) triggerFKey(fkey);
  });
});

// Keyboard listener
document.addEventListener('keydown', e => {
  let handled = false;
  
  // F1-F10
  if (e.key.match(/^F([1-9]|10)$/)) {
    e.preventDefault();
    triggerFKey(e.key);
    handled = true;
  }
  
  // Ctrl 1-0 (laptop fallback)
  if (e.ctrlKey && e.key.match(/^[1-9]$/)) {
    e.preventDefault();
    triggerFKey('F' + e.key);
    handled = true;
  }
  
  // WordStar diamond
  if (e.ctrlKey) {
    const m = {
      S: 'left', D: 'right', E: 'up', X: 'down',
      A: 'wordLeft', F: 'wordRight', G: 'delChar',
      Y: 'delLine', B: 'bold', U: 'underline'
    };
    if (m[e.key.toUpperCase()]) {
      e.preventDefault();
      cmd(m[e.key.toUpperCase()]);
      handled = true;
    }
  }
  
  if (handled) {
    e.stopPropagation();
    setTimeout(updateUI, 0);
  }
}, { capture: true });

// Export to global scope for inline onclick (backup)
window.triggerFKey = triggerFKey;
</script>
</body>
</html>
