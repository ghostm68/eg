<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#050000">
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22  viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’¾</text></svg>"> 
<title>display writer ii</title>
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#050000;
  --paper:#ffcccc;
  --dim:#884444;
  --iron:#4a2a2a;
  --blood:#ff0000;
  --shadow:#1a0000;
  --crt-glow:rgba(255,0,0,.15);
  --ai-purple:var(--blood);
  --ai-blue:var(--paper);
  --ai-dark:var(--bg);
}

* {
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

body{
  margin:0;
  /* Use dvh for mobile browsers to account for address bars */
  height:100vh;
  height:100dvh;
  display:flex;
  flex-direction:column;
  font-family:'VT323',monospace;
  font-size:24px;
  background:var(--bg);
  color:var(--paper);
  overflow:hidden;
  text-shadow:0 0 2px var(--dim),0 0 5px var(--crt-glow);
  position:relative;
}

/* CRT Scanline Effect */
body::after{
  content:"";
  position:absolute;
  inset:0;
  background:repeating-linear-gradient(0deg,transparent 0 2px,rgba(0,0,0,.5) 3px 4px),repeating-linear-gradient(90deg,var(--crt-glow),transparent 2px,rgba(0,0,0,.1) 4px);
  pointer-events:none;
  z-index:100;
  mix-blend-mode:multiply;
}

#header-band{
  flex:0 0 30px;
  background:var(--iron);
  color:var(--bg);
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:0 12px;
  text-transform:uppercase;
  font-weight:bold;
  letter-spacing:1px;
  border-bottom:2px solid var(--blood);
  z-index:10;
  font-size: 1rem;
}

#edit-block{
  flex:0 0 auto;
  padding:8px 12px;
  border-bottom:1px solid var(--dim);
  background:var(--bg);
}

.dos-box{
  border:2px solid var(--dim);
  position:relative;
  padding:10px 8px;
  margin:0;
}

.dos-box legend{
  position:absolute;
  top:-12px;
  left:50%;
  transform:translateX(-50%);
  background:var(--bg);
  padding:0 6px;
  color:var(--blood);
  font-weight:bold;
  white-space: nowrap;
}

.menu-grid{
  display:flex;
  gap:20px;
  justify-content:center;
  font-size:1rem;
  flex-wrap:wrap;
}

.cmd{
  cursor:pointer;
  transition:color .2s;
  padding:5px;
}

.cmd:hover{
  color:var(--blood);
  text-shadow:0 0 8px var(--blood);
}

.cmd span{
  font-weight:bold;
  color:var(--blood);
  margin-right:4px;
}

#ruler{
  flex:0 0 20px;
  padding:0 12px;
  color:var(--dim);
  white-space:pre;
  overflow:hidden;
  border-bottom:1px solid var(--iron);
  transition:border-bottom-color .15s;
}

#viewport{
  flex:1 1 auto;
  padding:15px 12px;
  font-size:24px;
  line-height:1.4;
  overflow-y:auto;
  outline:none;
  cursor:text;
  animation:textFlicker .1s infinite;
  /* Ensure browser knows this is text */
  -webkit-user-select:text;
  user-select:text;
}

@keyframes textFlicker{
  0%,100%{opacity:.99;}
  50%{opacity:.97;}
}

#viewport:focus{
  background: rgba(20,0,0,0.2);
}

/* 
   FIX FOR BOLD: Include strong tag
   FIX FOR UNDERLINE: Include ins tag and u
*/
#viewport b, #viewport strong {
  color:var(--blood);
  font-weight:normal; /* VT323 creates bold via color/glow usually, but we keep weight normal to maintain grid */
  text-shadow:0 0 4px var(--blood);
}

#viewport u, #viewport ins {
  text-decoration:none;
  border-bottom:2px solid var(--blood);
}

#f-key-strip{
  flex:0 0 50px;
  display:flex;
  background:var(--shadow);
  border-top:1px solid var(--blood);
  border-bottom:1px solid var(--blood);
  z-index:10;
  /* Mobile Scroll Fix */
  overflow-x: auto; 
  overflow-y: hidden;
  scrollbar-width: none; /* Firefox */
}
#f-key-strip::-webkit-scrollbar { display: none; }

.f-key{
  flex:1 0 auto; /* Allow shrinking/growing but keep width sensible */
  min-width: 80px;
  display:flex;
  flex-direction: column;
  align-items:center;
  justify-content:center;
  border-right:1px solid var(--iron);
  cursor:pointer;
  transition:.1s;
  font-size:18px;
  padding: 0 5px;
  line-height: 1;
}

.f-key:hover{
  background:var(--iron);
  color:var(--paper);
}

.f-key:active{
  background:var(--blood);
  color:var(--bg);
}

.f-key b{
  color:var(--paper);
  margin-bottom: 2px;
}

#info-line{
  flex:0 0 24px;
  background:var(--iron);
  color:var(--bg);
  text-align:right;
  padding:0 12px;
  font-size:.8rem;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:15px;
  white-space: nowrap;
  overflow: hidden;
}

#info-line span{
  color:var(--paper);
  font-weight:bold;
}

.online{
  background:var(--blood);
  color:var(--bg);
  padding:0 4px;
}

small{
  font-size:12px;
  color:var(--dim);
  text-transform: uppercase;
}

/* AI MODAL STYLES */
#mode-indicator{
  cursor:pointer;
  transition:all 0.2s;
  padding:2px 5px;
}

#mode-indicator:hover{
  text-shadow:0 0 8px var(--blood);
  color:var(--paper);
}

#ai-overlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.8);
  z-index:1000;
  backdrop-filter:blur(3px);
}

#ai-modal{
  display:none;
  position:fixed;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  width:90%;
  max-width:600px;
  max-height:85vh;
  background:var(--ai-dark);
  border:2px solid var(--ai-purple);
  z-index:1001;
  box-shadow:0 0 30px rgba(255,0,0,0.5);
  font-family:'VT323',monospace;
  overflow-y:auto;
  display: flex;
  flex-direction: column;
}

.ai-header{
  background:linear-gradient(90deg, var(--blood), var(--paper));
  color:var(--bg); 
  padding:12px 15px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:1.2rem;
  border-bottom:1px solid var(--ai-purple);
}

.ai-body{
  padding:20px;
  color:var(--paper);
  font-size:1.1rem;
  overflow-y: auto;
}

.ai-input-group{ margin-bottom:20px; }
.ai-input-group label{ display:block; margin-bottom:8px; color:var(--paper); }

.ai-input-group input,
.ai-input-group select,
.ai-input-group textarea{
  width:100%;
  padding:10px;
  background:rgba(80,0,0,0.7);
  border:1px solid var(--ai-purple);
  color:var(--paper);
  font-family:'VT323',monospace;
  font-size:1.1rem;
  box-sizing:border-box;
  border-radius: 0;
}

#aiPrompt{ min-height:100px; resize:vertical; }

#aiOutput{
  min-height:100px;
  background:rgba(40,0,0,0.7);
  border:1px solid var(--ai-purple);
  padding:15px;
  margin-top:15px;
  white-space:pre-wrap;
  font-size:1rem;
}

.ai-btn{
  background:linear-gradient(90deg, var(--ai-purple), var(--ai-blue));
  color:var(--bg);
  border:none;
  padding:10px 25px;
  font-family:'VT323',monospace;
  font-size:1.2rem;
  cursor:pointer;
  margin:5px;
}

.ai-btn:disabled{ opacity:0.5; }

/* --------------------------------- */
/* MOBILE SPECIFIC MEDIA QUERIES     */
/* --------------------------------- */

@media (max-width: 768px) {
  body { font-size: 20px; }
  #viewport { font-size: 20px; padding: 10px; }
  
  /* Compact Menu Grid */
  .menu-grid { gap: 10px; justify-content: space-between; }
  .cmd { font-size: 0.9rem; padding: 2px 5px; flex: 1 0 40%; text-align: center; border: 1px solid var(--dim); }
  
  /* Hide Ruler on small screens to save space */
  #ruler { display: none; }
  
  /* Smaller Info Line */
  #info-line { font-size: 12px; gap: 8px; }
  
  /* F-Keys become a swipeable bottom bar */
  #f-key-strip { 
    height: 60px; 
    padding-bottom: env(safe-area-inset-bottom);
  }
  .f-key { min-width: 70px; font-size: 16px; }
  
  .dos-box legend { font-size: 0.9rem; }
}

@media (max-width: 480px) {
  /* Ultra compact for phones */
  #header-band span:first-child { 
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  /* Hide the memory stats on tiny screens */
  #info-line { justify-content: space-between; }
}
</style>
</head>
<body>

<!-- AI Modal Overlay -->
<div id="ai-overlay" style="display:none;"></div>
<div id="ai-modal" style="display:none;">
    <div class="ai-header">
        <span>ðŸ¤– NEMOTRON AI</span>
        <button id="closeAiBtn" style="background:transparent; border:none; color:var(--bg); font-size:1.5em; cursor:pointer;">&times;</button>
    </div>
    <div class="ai-body">
        <div class="ai-input-group">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <label style="margin-bottom:0;">NVIDIA API Key:</label>
                <a href="https://build.nvidia.com" target="_blank" style="color:var(--paper); border-bottom:1px dotted var(--paper);">[GET KEY]</a>
            </div>
            <input type="password" id="nvidiaKey" placeholder="nvapi-..." autocomplete="off">
        </div>

        <div class="ai-input-group">
            <label>Prompt:</label>
            <textarea id="aiPrompt" placeholder="Describe a quantum city..."></textarea>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button id="cancelAiBtn" class="ai-btn">Cancel</button>
            <button id="genBtn" class="ai-btn" style="background:linear-gradient(90deg, var(--blood), var(--paper));">Generate</button>
        </div>

        <div class="ai-input-group">
            <label>Output:</label>
            <div id="aiOutput">Waiting for input...</div>
        </div>
        <div id="aiStatus" style="font-size:0.9rem; color:var(--dim); margin-top:10px;">Status: Ready</div>
    </div>
</div>

<!-- Main UI -->
<div id="header-band">
  <span>C:\QUANTUM.DOC</span>
  <span id="status-readout">L:01 C:01</span>
  <span id="mode-indicator">INSERT | LOCAL</span>
</div>

<div id="edit-block">
  <fieldset class="dos-box">
    <legend>â‰¡ MENU â‰¡</legend>
    <div class="menu-grid">
      <div class="cmd prevent-focus" data-fkey="F1"><span>F1</span>GEN</div>
      <div class="cmd prevent-focus" data-fkey="F2"><span>F2</span>HEX</div>
      <div class="cmd prevent-focus" data-fkey="F3"><span>F3</span>SAVE</div>
      <div class="cmd prevent-focus" data-fkey="F4"><span>F4</span>PRNT</div>
    </div>
  </fieldset>
</div>

<div id="ruler">Lâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€R</div>

<div id="viewport" contenteditable="true" spellcheck="false">Initializing Quantum Core...<br>Ready for Input.<br><br>Click "INSERT | LOCAL" for AI.<br>Try selecting text and clicking F6 (Bold).</div>

<div id="f-key-strip">
  <div class="f-key prevent-focus" data-fkey="F1"><b>F1</b><small>GEN</small></div>
  <div class="f-key prevent-focus" data-fkey="F2"><b>F2</b><small>HEX</small></div>
  <div class="f-key prevent-focus" data-fkey="F3"><b>F3</b><small>DISK</small></div>
  <div class="f-key prevent-focus" data-fkey="F4"><b>F4</b><small>PRNT</small></div>
  <div class="f-key prevent-focus" data-fkey="F5"><b>F5</b><small>CLR</small></div>
  <div class="f-key prevent-focus" data-fkey="F6"><b>F6</b><small>BOLD</small></div>
  <div class="f-key prevent-focus" data-fkey="F7"><b>F7</b><small>UNDR</small></div>
  <div class="f-key prevent-focus" data-fkey="F8"><b>F8</b><small>FIND</small></div>
  <div class="f-key prevent-focus" data-fkey="F9"><b>F9</b><small>HELP</small></div>
  <div class="f-key prevent-focus" data-fkey="F10"><b>F10</b><small>BOOT</small></div>
</div>

<div id="info-line">
  DisplayWriter 370 | Mem: 640K | <span id="entropy-source">INIT...</span>
</div>

<script>
/* ----------  CORE SETUP & AUDIO ---------- */
const VIEWPORT = document.getElementById('viewport');
const STATUS = document.getElementById('status-readout');
const MODE = document.getElementById('mode-indicator');
const ENTROPY = document.getElementById('entropy-source');
const RULER = document.getElementById('ruler');
let audioCtx = null;
let liveLex = null;
let insertMode = true;

function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
}

function beep(freq = 880, type = 'square', dur = 0.05) {
  if (!audioCtx) initAudio();
  if (audioCtx && audioCtx.state === 'running') {
    try {
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.value = freq;
      o.connect(g);
      g.connect(audioCtx.destination);
      o.start();
      g.gain.setValueAtTime(0.1, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + dur);
      o.stop(audioCtx.currentTime + dur);
    } catch(e){}
  }
}

/* ----------  CRITICAL FIX: PREVENT FOCUS LOSS ---------- */
// This is the most important fix for Bold/Underline.
// By default, clicking a button takes focus away from the viewport (text editor).
// We use 'mousedown' (and touchstart) to preventDefault, keeping focus on the text.
document.querySelectorAll('.prevent-focus').forEach(el => {
    el.addEventListener('mousedown', (e) => {
        e.preventDefault(); // Stop focus from leaving the editor
        const fkey = el.getAttribute('data-fkey');
        if(fkey) triggerFKey(fkey);
    });
    
    // Mobile equivalent
    el.addEventListener('touchstart', (e) => {
        e.preventDefault(); 
        const fkey = el.getAttribute('data-fkey');
        if(fkey) triggerFKey(fkey);
    });
});

/* ----------  COMMAND LOGIC ---------- */
function cmd(command) {
  // Execute standard contenteditable commands
  // Note: execCommand is deprecated but still the only reliable way 
  // to handle bold/underline without a massive custom engine.
  document.execCommand(command, false, null);
  VIEWPORT.focus(); // Ensure focus remains
  updateUI();
}

function triggerFKey(k) {
  beep(880, 'square');
  
  switch(k) {
    case 'F1': generate(); break;
    case 'F2': collapse(); break;
    case 'F3': save80(); break;
    case 'F4': window.print(); break;
    case 'F5': if(confirm('CLEAR BUFFER?')) VIEWPORT.innerHTML = ''; break;
    case 'F6': cmd('bold'); break;      // Functionality verified via preventDefault fix
    case 'F7': cmd('underline'); break; // Functionality verified via preventDefault fix
    case 'F8': {
      const s = prompt('SEARCH:');
      if (s) window.find(s);
      break;
    }
    case 'F9': alert('F1: Generate Text\nF2: Insert Entropy\nF3: Save HTML\nF6: Bold (Select text first)\nF7: Underline\n\nAI: Click Top Right Corner'); break;
    case 'F10': location.reload(); break;
  }
}

/* ----------  TEXT GENERATION ---------- */
const FB = {
  nouns: ["nebula","echo","whisper","void","nexus","fragment","signal","horizon","monolith","algorithm","spectre","glitch"],
  verbs: ["fractured","hummed","collapsed","ignited","shattered","pulsed","dissolved","encoded","transmitted","erased"],
  adjs: ["silent","obsidian","infinite","hollow","electric","forgotten","crimson","static","digital","frozen"]
};

function generate() {
  const nouns = liveLex || FB.nouns;
  const n = nouns[Math.floor(Math.random() * nouns.length)];
  const v = FB.verbs[Math.floor(Math.random() * FB.verbs.length)];
  const a = FB.adjs[Math.floor(Math.random() * FB.adjs.length)];
  
  // Insert at cursor position
  document.execCommand('insertHTML', false, ` The <b>${a}</b> ${n} <u>${v}</u>. `);
  VIEWPORT.focus();
}

function collapse() {
  const hex = [...Array(6)].map(() => Math.floor(Math.random() * 255).toString(16).padStart(2,'0')).join(':');
  document.execCommand('insertHTML', false, `<br><span style="background:var(--blood);color:var(--bg)">[ENTROPY:${hex.toUpperCase()}]</span><br>`);
}

function save80() {
  const html = `<!DOCTYPE html><html><body style="background:#000;color:#fcc;font-family:monospace;white-space:pre-wrap;">${VIEWPORT.innerHTML}</body></html>`;
  const blob = new Blob([html], {type: 'text/html'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'quantum_save.html';
  a.click();
}

/* ----------  UI UPDATES ---------- */
function updateUI() {
    // Simple line/char counter
    const text = VIEWPORT.innerText || "";
    const lines = text.split('\n').length;
    const chars = text.length;
    STATUS.textContent = `L:${String(lines).padStart(2,'0')} C:${String(chars).padStart(4,'0')}`;
}

// Monitor typing
VIEWPORT.addEventListener('keyup', updateUI);
VIEWPORT.addEventListener('click', updateUI);
VIEWPORT.addEventListener('input', updateUI);

/* ----------  AI MODAL LOGIC ---------- */
const aiModal = document.getElementById('ai-modal');
const aiOverlay = document.getElementById('ai-overlay');

function openAI() {
    beep(1200, 'sine');
    aiModal.style.display = 'flex';
    aiOverlay.style.display = 'block';
    
    const savedKey = localStorage.getItem('quantum_nvidia_key');
    if(savedKey) document.getElementById('nvidiaKey').value = savedKey;
}

function closeAI() {
    aiModal.style.display = 'none';
    aiOverlay.style.display = 'none';
}

document.getElementById('mode-indicator').addEventListener('click', openAI);
document.getElementById('closeAiBtn').addEventListener('click', closeAI);
document.getElementById('cancelAiBtn').addEventListener('click', closeAI);
document.getElementById('ai-overlay').addEventListener('click', closeAI);

document.getElementById('genBtn').addEventListener('click', async () => {
    const key = document.getElementById('nvidiaKey').value.trim();
    const prompt = document.getElementById('aiPrompt').value.trim();
    const out = document.getElementById('aiOutput');
    const status = document.getElementById('aiStatus');
    
    if(!key) { out.textContent = "Error: Missing API Key"; return; }
    if(!prompt) { out.textContent = "Error: Missing Prompt"; return; }
    
    localStorage.setItem('quantum_nvidia_key', key);
    out.textContent = "Transmitting to Neural Core...";
    status.textContent = "Status: Sending...";
    
    try {
        const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent('https://integrate.api.nvidia.com/v1/chat/completions');
        
        const response = await fetch(proxyUrl, {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: "nvidia/nvidia-nemotron-nano-9b-v2",
                messages: [{role: "user", content: "Write a short creative paragraph: " + prompt}],
                temperature: 0.7,
                max_tokens: 200 
            })
        });

        if(!response.ok) throw new Error("API Connection Failed");
        const data = await response.json();
        const text = data.choices[0].message.content;
        
        out.textContent = text;
        status.textContent = "Status: Success";
        
        // Insert into doc
        document.execCommand('insertHTML', false, `<br><br><b>[AI_INJECT]</b> ${text}<br>`);
        
    } catch (e) {
        out.textContent = "Error: " + e.message;
        status.textContent = "Status: Failed";
    }
});

/* ----------  BOOT SEQUENCE ---------- */
(async () => {
    VIEWPORT.focus();
    initAudio();
    
    // Simulate loading external dictionary
    try {
        const r = await fetch('https://raw.githubusercontent.com/ghostm68/eg/refs/heads/main/horse.txt');
        if(r.ok) {
            const txt = await r.text();
            liveLex = [...new Set(txt.toLowerCase().match(/\b[a-z]{5,}\b/g))];
            ENTROPY.innerHTML = '<span class="online">ONLINE</span>';
            MODE.classList.add('online');
        } else { throw new Error(); }
    } catch(e) {
        ENTROPY.textContent = 'OFFLINE';
    }
})();

// Keyboard Shortcuts
document.addEventListener('keydown', (e) => {
    initAudio();
    
    // F-Keys
    if(e.key.match(/^F([1-9]|10)$/)) {
        e.preventDefault();
        triggerFKey(e.key);
    }
    
    // Ctrl+B / Ctrl+U overrides (Standard behavior is fine, but this ensures our sound effects play)
    if((e.ctrlKey || e.metaKey) && (e.key === 'b' || e.key === 'u')) {
        beep(880, 'square');
        // Let browser handle the actual bolding/underlining natively
    }
});

</script>
</body>
</html>
