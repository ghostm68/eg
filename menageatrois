<!--[if IE 6]>
<html id="ie6" lang="en-US">
<![endif]-->
<!--[if !(IE 6) | !(IE 7) | !(IE 8) ]><!-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MÉNAGE À TROIS // wordstar.nexus/menageatrois</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Nova+Mono&family=Special+Elite&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

<style>
    :root {
        --red: #ff0000;
        --black: #050505;
        --dark-grey: #121212;
        --mid-grey: #1a1a1a;
        --white: #d1d1d1;
    }
    
    body { 
        background: var(--black); 
        color: var(--white); 
        font-family: 'Nova Mono', monospace; 
        margin: 0;
        height: 100vh;
        overflow: hidden;
    }

    body::after {
        content: " ";
        display: block;
        position: fixed;
        top: 0; left: 0; bottom: 0; right: 0;
        background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
        z-index: 999;
        background-size: 100% 4px;
        pointer-events: none;
        opacity: 0.15;
    }

    .app-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        grid-template-rows: 50px 80px 1fr 320px 30px;
        height: 100vh;
        gap: 1px;
        background: var(--red);
    }

    header {
        grid-column: span 3;
        background: var(--black);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
    }

    .control-bar {
        grid-column: span 3;
        background: var(--dark-grey);
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 0 20px;
    }

    .panel {
        background: var(--black);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .panel-header {
        background: var(--mid-grey);
        padding: 6px 15px;
        border-bottom: 1px solid var(--red);
        font-size: 10px;
        font-weight: bold;
        color: var(--red);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
    }

    .thinking-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 2px;
        background: var(--red);
        width: 0%;
        display: none;
    }

    .is-thinking .thinking-bar {
        display: block;
        animation: manifest 1.5s infinite linear;
    }

    @keyframes manifest {
        0% { width: 0%; left: 0; opacity: 0.2; }
        50% { width: 100%; left: 0; opacity: 1; }
        100% { width: 0%; left: 100%; opacity: 0.2; }
    }

    .import-btn {
        font-size: 8px;
        color: var(--white);
        border: 1px solid #444;
        padding: 2px 6px;
        text-transform: uppercase;
        background: #000;
        z-index: 10;
    }

    .import-btn:hover { background: var(--red); color: white; }

    .output-area {
        flex: 1;
        overflow-y: scroll;
        padding: 15px;
        font-family: 'Courier Prime', monospace;
        font-size: 12px;
        line-height: 1.5;
        background: #080808;
        color: #aaa;
    }

    .output-area::-webkit-scrollbar, #notepad::-webkit-scrollbar { width: 16px; }
    .output-area::-webkit-scrollbar-track { background: #050505; }
    .output-area::-webkit-scrollbar-thumb { background: #222; border: 1px solid #444; }
    .output-area::-webkit-scrollbar-button:single-button {
        background-color: #111;
        display: block;
        height: 16px;
        background-repeat: no-repeat;
        background-position: center;
    }
    /* Arrows */
    .output-area::-webkit-scrollbar-button:vertical:decrement {
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' fill='red'><polygon points='50,20 80,80 20,80'/></svg>");
    }
    .output-area::-webkit-scrollbar-button:vertical:increment {
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' fill='red'><polygon points='50,80 80,20 20,20'/></svg>");
    }

    .notepad-section {
        grid-column: span 3;
        background: var(--dark-grey);
        display: flex;
        flex-direction: column;
        border-top: 2px solid var(--red);
        overflow: hidden;
    }

    #notepad {
        flex: 1;
        padding: 30px;
        font-family: 'Special Elite', serif;
        font-size: 1.2rem;
        line-height: 1.6;
        outline: none;
        overflow-y: auto;
        background: #0d0d0d;
        color: #e0e0e0;
    }

    input, textarea, button {
        background: transparent;
        border: 1px solid #333;
        color: #fff;
        font-family: inherit;
        font-size: 11px;
        padding: 8px;
    }

    #userInput {
        flex-grow: 1;
        height: 50px;
        background: #000;
        border-color: #444;
        resize: none;
    }

    @media (max-width: 768px) {
        body { overflow: visible !important; height: auto !important; }
        .app-grid {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto auto auto auto auto auto 30px;
            height: auto;
        }
        header, .control-bar, footer, .notepad-section { grid-column: 1; }
        .panel { height: 400px; border-bottom: 1px solid var(--red); }
        #notepad { height: 450px; }
    }
</style>
</head>
<body>

<div class="app-grid">
    <header>
        <div class="flex items-center gap-3">
            <div class="w-2 h-2 bg-red-600 rounded-full shadow-[0_0_5px_red]"></div>
            <h1 class="text-xs font-bold uppercase tracking-tighter italic">MÉNAGE À TROIS // v1.7</h1>
        </div>
        <div class="flex gap-4 items-center">
            <input type="password" id="apiKey" placeholder="OpenRouter Key..." class="w-48 text-[9px]">
            <button onclick="exportNotepad()" class="text-[9px] px-3 font-bold text-red-600 border-red-900 uppercase">Extract Manuscript</button>
        </div>
    </header>

    <div class="control-bar">
        <textarea id="userInput" placeholder="Staggered signal request..." onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); summonCouncil(); }"></textarea>
        <button onclick="summonCouncil()" id="summonBtn" class="px-6 font-bold text-red-600 border-red-900 uppercase">Summon</button>
    </div>

    <!-- I: GEMMA 3 [REINSTATED] -->
    <div class="panel" id="panel-1">
        <div class="panel-header">
            <span>I. GEMMA 3 [THE_STRUCTURALIST]</span>
            <button class="import-btn" onclick="importToNotepad('output-1')">Import</button>
            <div class="thinking-bar"></div>
        </div>
        <div class="output-area" id="output-1"></div>
    </div>

    <!-- II: DOLPHIN VENICE [CORE FAVORITE] -->
    <div class="panel" id="panel-2" style="border-left: 1px solid var(--red); border-right: 1px solid var(--red);">
        <div class="panel-header">
            <span>II. DOLPHIN VENICE [THE_HARLOT]</span>
            <button class="import-btn" onclick="importToNotepad('output-2')">Import</button>
            <div class="thinking-bar"></div>
        </div>
        <div class="output-area" id="output-2"></div>
    </div>

    <!-- III: CHIMERA [THE GHOST] -->
    <div class="panel" id="panel-3">
        <div class="panel-header">
            <span>III. TNG CHIMERA [THE_GHOST]</span>
            <button class="import-btn" onclick="importToNotepad('output-3')">Import</button>
            <div class="thinking-bar"></div>
        </div>
        <div class="output-area" id="output-3"></div>
    </div>

    <section class="notepad-section">
        <div class="bg-red-800 text-white px-4 py-1 flex justify-between font-bold text-[9px] uppercase tracking-tighter">
            <div>>> Synthesis_Chamber_Active</div>
            <div id="word-count">0 WORDS</div>
        </div>
        <div id="notepad" contenteditable="true" spellcheck="false"></div>
    </section>

    <footer class="col-span-3 flex justify-between px-4 items-center text-[8px] text-zinc-700 uppercase">
        <div>MÉNAGE À TROIS // v1.7 // Temporal Stagger Logic</div>
        <div id="global-status">Ready</div>
    </footer>
</div>

<script>
    const MODELS = {
        gemma: "google/gemma-3-27b-it:free",
        venice: "cognitivecomputations/dolphin-mistral-24b-venice-edition:free",
        chimera: "tngtech/tng-r1t-chimera:free"
    };

    // Sequential helper to avoid rate-limiting
    const sleep = ms => new Promise(res => setTimeout(res, ms));

    async function summonCouncil() {
        const query = document.getElementById('userInput').value.trim();
        const key = document.getElementById('apiKey').value.trim();
        if (!query || !key) return alert("Key and Query required.");

        document.querySelectorAll('.output-area').forEach(el => el.innerHTML = "");
        document.getElementById('global-status').innerText = "STAGGERED_SUMMON_ACTIVE...";

        // TEMPORAL STAGGER LOGIC: Firing one by one with delays
        fetchModel(MODELS.gemma, query, 'output-1', 'panel-1');
        await sleep(1000); // 1-second stagger
        fetchModel(MODELS.venice, query, 'output-2', 'panel-2');
        await sleep(1000); // 1-second stagger
        fetchModel(MODELS.chimera, query, 'output-3', 'panel-3');

        document.getElementById('global-status').innerText = "SIGNAL_STABILIZED";
    }

    async function fetchModel(modelId, prompt, outputId, panelId) {
        const key = document.getElementById('apiKey').value.trim();
        const outputEl = document.getElementById(outputId);
        const panelEl = document.getElementById(panelId);
        
        panelEl.classList.add('is-thinking');

        try {
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${key}` },
                body: JSON.stringify({ model: modelId, messages: [{ role: "user", content: prompt }] })
            });

            const data = await response.json();
            if (data.choices && data.choices[0]) {
                const text = data.choices[0].message.content;
                outputEl.innerHTML = text.replace(/\n/g, '<br>');
            } else if (data.error) {
                outputEl.innerHTML = `<span style="color:var(--red)">SIGNAL_LOST: ${data.error.message}</span>`;
            }
        } catch (e) {
            outputEl.innerText = "CRITICAL_ERROR: " + e.message;
        } finally {
            panelEl.classList.remove('is-thinking');
        }
    }

    function importToNotepad(outputId) {
        const notepad = document.getElementById('notepad');
        const sourceText = document.getElementById(outputId).innerHTML;
        if (!sourceText || sourceText.trim() === "") return;
        const sourceName = document.querySelector(`#${outputId.replace('output', 'panel')} .panel-header span`).innerText;
        const divider = `<div style="color:var(--red); border-bottom:1px solid var(--red); margin:20px 0; font-size:10px;">>> FROM_${sourceName}</div>`;
        notepad.innerHTML += divider + sourceText;
        updateStats();
        saveNotepad();
    }

    function updateStats() {
        const text = notepad.innerText;
        const count = text.trim() ? text.trim().split(/\s+/).length : 0;
        document.getElementById('word-count').innerText = `${count} WORDS`;
    }

    function saveNotepad() {
        localStorage.setItem('menage_v1.7_notepad', notepad.innerHTML);
    }

    const notepad = document.getElementById('notepad');
    notepad.addEventListener('input', () => { updateStats(); saveNotepad(); });

    window.onload = () => {
        const saved = localStorage.getItem('menage_v1.7_notepad');
        if (saved) notepad.innerHTML = saved;
        const savedKey = localStorage.getItem('triplicate_key');
        if (savedKey) document.getElementById('apiKey').value = savedKey;
        updateStats();
    };

    document.getElementById('apiKey').addEventListener('change', (e) => {
        localStorage.setItem('triplicate_key', e.target.value);
    });

    function exportNotepad() {
        const text = notepad.innerText;
        const blob = new Blob([text], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `menage_manuscript_${Date.now()}.txt`;
        a.click();
    }
</script>
</body>
</html>
