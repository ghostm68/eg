<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI RIDER - A Horse Struck Down By Lightning</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.puter.com/v2/"></script>
 <style>
    /* Theme Setup: Wordstar Red / Black / White / Grey */
    body { 
      font-family: 'Courier New', monospace; 
      background-color: #000000; /* Pitch Black */
      color: #e0e0e0; /* Off-White/Light Grey for text */
    }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar { 
      width: 8px; 
    }
    
    .custom-scrollbar::-webkit-scrollbar-track { 
      background: #111111; /* Dark Grey Track */
      border-left: 1px solid #333333; /* Mechanical border */
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb { 
      background-color: #666666; /* Industrial Grey Handle */
      border: 1px solid #000000; 
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { 
      background-color: #ff0000; /* Bright Red on Interaction */
    }

    /* Selection Highlighting */
    ::selection { 
      background: #ff0000; /* Red Background */
      color: #ffffff;      /* White Text */
    }
    
    /* Form Elements */
    select, textarea, input { 
      color-scheme: dark; 
      background-color: #1a1a1a;
      color: #fff;
      border-color: #333;
    }

    /* Animation for loading/processing */
    @keyframes pulse-red {
      0%, 100% { opacity: 1; color: #ff0000; }
      50% { opacity: 0.5; color: #800000; }
    }
    
    .animate-pulse-red {
      animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
</style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            theme: {
              dark: '#1a120b',
              panel: '#271c19',
              tan: '#d6c0b3',
              gold: '#fbbf24',
              brown: '#78350f',
              border: '#4a3b32'
            }
          }
        }
      }
    }
  </script>
</head>
<body class="p-4 h-screen flex flex-col items-center justify-center bg-[#050505] text-[#cccccc]">
  <div class="w-full max-w-3xl relative z-10">
    
    <!-- AI Assistant Card -->
    <div class="bg-[#0a0a0a] border border-[#333] rounded-lg p-4 shadow-2xl shadow-black/80">
      
      <!-- HEADER -->
      <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 border-b border-[#333] pb-4">
        <h3 class="text-xl font-bold text-[#ff3333] tracking-widest flex items-center gap-2 font-mono">
            <span>‚ö°</span> AI RIDER
        </h3>
        
        <!-- TRIGGER BUTTON FOR NVIDIA -->
        <button onclick="openNvidiaModal()" class="text-[10px] border border-dashed border-[#666] text-[#666] px-3 py-2 hover:border-[#ff3333] hover:text-[#ff3333] transition-colors font-mono uppercase tracking-widest cursor-pointer">
            [ + OPEN DEEP ANALYSIS NODE ]
        </button>

        <span id="statusBadge" class="text-[10px] text-gray-500 uppercase tracking-widest border border-[#333] px-2 py-1 rounded font-mono">
          Initializing...
        </span>
      </div>
      
      <!-- STANDARD MODEL SELECTION (PUTER) -->
      <div class="mb-4">
        <label class="block text-[10px] uppercase tracking-widest text-[#ff3333] mb-2 opacity-80 font-mono">Standard Transmission Channel:</label>
        <select id="model" class="w-full p-2 bg-[#121212] border border-[#333] rounded text-xs text-[#cccccc] focus:border-[#ff3333] focus:outline-none transition-all cursor-pointer font-mono">
            <optgroup label="üèÜ TOP PICKS">
                <option value="deepseek-chat" selected>DeepSeek Chat V3 (Best Free) üèÜ</option>
                <option value="openrouter/anthropic/claude-sonnet-4-20250514">Claude Sonnet 4 (Best Overall) üëë</option>
            </optgroup>
            <optgroup label="üü¢ RELIABLE">
                <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Fast)</option>
                <option value="google/gemma-2-9b-it:free">Gemma 2 9B (Free)</option>
            </optgroup>
            <optgroup label="üîµ PREMIUM (OpenRouter)">
                <option value="openrouter/openai/gpt-4o">GPT-4o</option>
                <option value="openrouter/anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
            </optgroup>
        </select>
      </div>

      <!-- Context Toggle -->
      <div class="mb-4 bg-[#121212] p-2 rounded border border-[#333]">
        <div class="flex justify-between items-center mb-2">
            <label class="block text-[10px] uppercase tracking-widest text-[#ff3333] opacity-80 font-mono">Context Scope:</label>
            <p id="contextInfo" class="text-[10px] text-gray-500 italic font-mono">Linking to wordstar.nexus...</p>
        </div>
        <div class="flex gap-2">
          <button class="context-btn flex-1 bg-[#660000] text-white border border-[#ff3333] px-3 py-1 text-xs font-bold transition uppercase tracking-wider font-mono" data-context="novel">Full Novel</button>
          <button class="context-btn flex-1 bg-[#1a1a1a] text-gray-500 border border-[#333] px-3 py-1 text-xs hover:text-[#ff3333] hover:border-[#ff3333] transition uppercase tracking-wider font-mono" data-context="none">No Context</button>
        </div>
      </div>

      <!-- Input -->
      <div class="mb-4">
        <label class="block text-[10px] uppercase tracking-widest text-[#ff3333] mb-2 opacity-80 font-mono">Input Query:</label>
        <textarea id="input" class="w-full p-3 bg-[#121212] border border-[#333] rounded text-sm text-[#e0e0e0] focus:border-[#ff3333] focus:outline-none min-h-[80px] placeholder-gray-700 font-mono" placeholder="Query the manuscript..."></textarea>
      </div>

      <!-- Ask Button -->
      <button id="ask" class="w-full bg-[#1a1a1a] text-[#ff3333] border border-[#333] py-3 rounded font-bold hover:bg-[#ff3333] hover:text-black transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed uppercase tracking-widest font-mono">
        Execute Protocol
      </button>

      <!-- Response -->
      <div class="mt-6">
        <label class="block text-[10px] uppercase tracking-widest text-[#ff3333] mb-2 opacity-80 font-mono">System Output:</label>
        <div id="response" class="bg-[#121212] border border-[#333] rounded p-4 text-sm min-h-[120px] max-h-[400px] overflow-y-auto custom-scrollbar whitespace-pre-wrap font-mono leading-relaxed text-gray-400">
          <p class="italic opacity-30">...Waiting for input signal...</p>
        </div>
      </div>
    </div>
    
    <div class="mt-2 text-center text-[10px] text-[#333] uppercase tracking-[0.3em] font-mono">
        Terminal Access // GhostM68 // Wordstar.Nexus
    </div>
  </div>

  <!-- ========================================== -->
  <!-- NVIDIA "DEEP THOUGHT" MODAL (HIDDEN)       -->
  <!-- ========================================== -->
  <div id="nvidia-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9000; backdrop-filter:blur(5px);"></div>

  <div id="nvidia-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:600px; max-width:95%; background:#000000; border:2px solid #ff3333; padding:20px; z-index:9001; box-shadow:0 0 50px rgba(255, 0, 0, 0.2);">
    
    <!-- Header -->
    <div style="border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="color:#ff3333; margin:0; font-family:'Courier New', monospace; font-weight:bold; letter-spacing: 2px;">>> NVIDIA NEMOTRON [DEEP ANALYSIS]</h3>
        <button onclick="closeNvidiaModal()" style="background:none; border:none; color:#666; cursor:pointer; font-family:'Courier New', monospace;">[ X ]</button>
    </div>

    <!-- Key Input -->
    <div style="margin-bottom:15px;">
        <label style="color:#666; font-size:10px; display:block; margin-bottom:5px; font-family:'Courier New', monospace;">NVIDIA API KEY (SECURE STORAGE)</label>
        <input type="password" id="nvidiaKey" placeholder="nvapi-..." style="width:100%; background:#111; border:1px solid #333; color:#ff3333; padding:10px; font-family:'Courier New', monospace; outline:none; font-size:12px;">
    </div>

    <!-- Prompt -->
    <div style="margin-bottom:15px;">
        <label style="color:#666; font-size:10px; display:block; margin-bottom:5px; font-family:'Courier New', monospace;">ANALYSIS PARAMETERS</label>
        <textarea id="nvidiaPrompt" rows="4" placeholder="Enter deep analysis query (e.g., 'Analyze the thematic structure of the first 3 chapters')..." style="width:100%; background:#111; border:1px solid #333; color:#e0e0e0; padding:10px; font-family:'Courier New', monospace; outline:none; resize:vertical; font-size:12px;"></textarea>
    </div>

    <!-- Controls -->
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <select id="nvidiaModel" style="background:#111; color:#aaa; border:1px solid #333; padding:5px; flex:1; font-family:'Courier New', monospace; font-size:12px;">
            <option value="nvidia/nemotron-4-340b-instruct">Nemotron-4 340B (Heavy)</option>
        </select>
        <button id="nvidiaBtn" onclick="runNvidiaAnalysis()" style="background:#ff3333; color:#000; border:none; padding:8px 20px; font-weight:bold; cursor:pointer; font-family:'Courier New', monospace; letter-spacing:1px; transition:all 0.3s;">INITIALIZE</button>
    </div>

    <!-- Output Console -->
    <div id="nvidiaOutput" style="background:#050505; border:1px solid #333; color:#ccc; padding:15px; height:200px; overflow-y:auto; font-size:12px; white-space:pre-wrap; font-family:'Courier New', monospace; line-height: 1.5;">>> STANDBY... WAITING FOR INSTRUCTIONS.</div>
  </div>

  <!-- MAIN SCRIPT LOGIC -->
  <script>
   // ==========================================
    // 1. GLOBAL CONFIGURATION & STATE
    // ==========================================
    const NOVEL_URL = 'https://wordstar.nexus/horse.txt'; // <--- The book file
    let novelText = '';      // Stores the book in browser memory
    let aiContext = 'novel'; // Context switch state
    let isLoading = false;

    // Elements
    const modelSelect = document.getElementById('model');
    const input = document.getElementById('input');
    const askBtn = document.getElementById('ask');
    const response = document.getElementById('response');
    const contextInfo = document.getElementById('contextInfo');
    const statusBadge = document.getElementById('statusBadge');

    // ==========================================
    // 2. SYSTEM STARTUP (Downloads the book)
    // ==========================================
    async function loadNovel() {
      try {
        contextInfo.textContent = 'Linking to Wordstar.Nexus...';
        statusBadge.textContent = 'DOWNLOADING';
        statusBadge.classList.add('text-[#ff3333]', 'animate-pulse');
        
        // This is where we grab the text file
        const res = await fetch(NOVEL_URL);
        if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
        
        novelText = await res.text();
        
        console.log(`System: Loaded ${novelText.length} characters.`);
        contextInfo.textContent = 'Manuscript loaded & indexed.';
        statusBadge.textContent = 'ONLINE';
        statusBadge.classList.remove('animate-pulse');
        statusBadge.classList.add('text-[#ff3333]', 'font-bold');
        
      } catch (error) {
        console.error('Load Error:', error);
        contextInfo.innerHTML = 'Error loading text. <span class="text-red-500">Check CORS.</span>';
        statusBadge.textContent = 'OFFLINE';
      }
    }

    // ==========================================
    // 3. STANDARD CHAT LOGIC (Puter)
    // ==========================================
    function buildPuterPrompt(userMessage) {
      // For Puter, we just send the first 15k chars because it's simpler
      if (aiContext === 'novel' && novelText) {
        const preview = novelText.substring(0, 15000); 
        return `You are an AI editor analyzing a novel.\n\nCONTEXT (START OF BOOK):\n${preview}\n\n---\nQUERY: ${userMessage}`;
      }
      return userMessage;
    }

    async function callPuterAI(prompt) {
      const selectedModelText = modelSelect.options[modelSelect.selectedIndex].text;
      response.innerHTML = `<p class="text-[#ff3333] animate-pulse">>> CONTACTING ${selectedModelText}...</p>`;
      
      try {
        const result = await puter.ai.chat(prompt, {
          model: modelSelect.value,
          temperature: 0.7,
          max_tokens: 2500
        });
        response.innerHTML = `<span class="text-[#ff3333] block mb-2 border-b border-[#333] pb-1 text-xs">>> TRANSMISSION RECEIVED:</span>${result}`;
      } catch (error) {
        response.innerHTML = `<p class="text-red-500 font-bold">>> ERROR: ${error.message}</p>`;
      }
    }

    askBtn.addEventListener('click', async () => {
      const msg = input.value.trim();
      if (!msg || isLoading) return;
      
      isLoading = true;
      askBtn.disabled = true;
      askBtn.classList.add('opacity-50');
      
      const prompt = buildPuterPrompt(msg);
      await callPuterAI(prompt);
      
      isLoading = false;
      askBtn.disabled = false;
      askBtn.classList.remove('opacity-50');
    });

    // ==========================================
    // 4. NVIDIA SMART SCANNER LOGIC (Client-Side RAG)
    // ==========================================

    function openNvidiaModal() {
        document.getElementById('nvidia-overlay').style.display = 'block';
        document.getElementById('nvidia-modal').style.display = 'block';
        const k = localStorage.getItem('inkrealm_nvidia_key');
        if(k) document.getElementById('nvidiaKey').value = k;
    }

    function closeNvidiaModal() {
        document.getElementById('nvidia-overlay').style.display = 'none';
        document.getElementById('nvidia-modal').style.display = 'none';
    }

    // The "Search Light" Function
    function getRelevantContext(query, fullText) {
        if (!fullText) return { text: "", method: "NO DATA" };
        
        // Clean query terms
        const keywords = query.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/).filter(w => w.length > 3);

        if (keywords.length === 0) {
            return { text: fullText.substring(0, 5000), method: "DEFAULT (BEGINNING)" };
        }

        // Scan for best match
        const chunkSize = 2000;
        let bestChunkIndex = 0;
        let maxScore = 0;
        
        for (let i = 0; i < fullText.length; i += 1000) {
            let chunk = fullText.substring(i, i + chunkSize).toLowerCase();
            let score = 0;
            keywords.forEach(word => {
                if(chunk.includes(word)) score++;
            });
            if (score > maxScore) {
                maxScore = score;
                bestChunkIndex = i;
            }
        }

        // Extract context (3000 chars before, 5000 chars after match)
        const start = Math.max(0, bestChunkIndex - 3000);
        const end = Math.min(fullText.length, bestChunkIndex + 5000);
        
        return {
            text: fullText.substring(start, end),
            method: `SMART SCAN (Found "${keywords[0]}")`
        };
    }

    async function runNvidiaAnalysis() {
        const key = document.getElementById('nvidiaKey').value.trim();
        const prompt = document.getElementById('nvidiaPrompt').value.trim();
        const model = document.getElementById('nvidiaModel').value;
        const out = document.getElementById('nvidiaOutput');
        const btn = document.getElementById('nvidiaBtn');
        
        if(!key || !prompt) { out.textContent = ">> ERROR: MISSING KEY OR PROMPT."; return; }
        
        localStorage.setItem('inkrealm_nvidia_key', key);
        
        btn.disabled = true; 
        btn.textContent = "SCANNING...";
        btn.style.backgroundColor = "#555";
        out.textContent = ">> SCANNING LOCAL TEXT FOR RELEVANCE...";

        // 1. Find relevant part of the book
        const scanResult = getRelevantContext(prompt, novelText);
        
        out.textContent += `\n>> TARGET: ${scanResult.method}`;
        out.textContent += `\n>> UPLOADING FRAGMENT (${scanResult.text.length} chars)...`;

        try {
            const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent('https://integrate.api.nvidia.com/v1/chat/completions');
            
            const requestBody = {
                model: model, 
                messages: [
                    { "role": "system", "content": "You are the WORDSTAR RECURSIVE ANALYSIS ENGINE. Your directive is to critique, analyze, and deconstruct the manuscript fragment provided." },
                    { "role": "user", "content": `CONTEXT FRAGMENT:\n...${scanResult.text}...\n\n---\n\nQUESTION: ${prompt}` }
                ],
                temperature: 0.5, top_p: 1, max_tokens: 1024
            };

            const res = await fetch(proxyUrl, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
            
            if (!res.ok) throw new Error(`API ERROR: ${res.status}`);
            
            const data = await res.json();
            
            if (data.choices && data.choices[0]) {
                const result = data.choices[0].message.content;
                out.innerHTML = `<span style="color:#ff3333">>> ANALYSIS COMPLETE:</span>\n\n${result}`;
            } else { throw new Error("EMPTY RESPONSE."); }

        } catch(e) { 
            out.innerHTML = `<span style="color:red">>> FAILURE:</span> ${e.message}`; 
        } finally { 
            btn.disabled = false; 
            btn.textContent = "INITIALIZE"; 
            btn.style.backgroundColor = "#ff3333";
        }
    }

    // ==========================================
    // 5. STARTUP
    // ==========================================
    loadNovel();
  </script>
</body>
</html>
