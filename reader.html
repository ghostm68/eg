<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>dreamweaver reader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.puter.com/v2/"></script>
  <link href="https://fonts.cdnfonts.com/css/voodoo" rel="stylesheet">
  <style>
    /* Base Settings */
    body {
      background-color: #000;
      color: #e0e0e0;
      /* THIS STOPS THE SCROLL FROM LEAKING TO THE MAIN PAGE */
      overscroll-behavior-y: contain; 
      overflow-y: auto;
    }
    
    /* Font Assignments */
    .font-voodoo {
      font-family: 'Voodoo', sans-serif;
      letter-spacing: 2px;
    }
    .font-mono {
      font-family: 'Courier New', monospace;
    }

    /* Red Highlight for Search Terms */
    .highlight {
      background-color: #ff0000;
      color: #000;
      padding: 0px 4px;
      font-weight: bold;
    }

    /* Custom Red/Black Scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #000;
      border-left: 1px solid #333;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: #ff0000;
      border: 2px solid #000;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background-color: #cc0000;
    }

    /* Hide standard focus rings */
    *:focus {
      outline: none !important;
    }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              red: '#ff0000',
              black: '#000000',
              gray: '#111111'
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-black text-gray-200 font-mono antialiased custom-scrollbar h-screen">
  
  <!-- MAIN WRAPPER WITH PADDING BOTTOM TO ENSURE SCROLL -->
  <div class="max-w-4xl mx-auto p-4 sm:p-6 md:p-8 pb-48">
    
    <!-- HEADER CONTROLS (NOT STICKY ON MOBILE TO SAVE SPACE) -->
    <!-- We removed 'sticky' to prevent it from eating the screen on small phones -->
    <div id="controls" class="bg-black pt-2 pb-6 border-b border-white/20 z-10">
      
      <!-- Title using Voodoo Font with Tight Leading -->
      <h1 class="text-3xl md:text-5xl font-voodoo text-brand-red mb-6 text-center md:text-left leading-none">
        DREAMWEAVER READER
      </h1>

      <!-- Search Box -->
      <input
        type="text"
        id="searchBox"
        class="w-full bg-black border border-white text-white p-3 text-sm focus:border-brand-red transition-colors duration-300 mb-2 font-mono placeholder-gray-600"
        placeholder="SEARCH DATABASE..."
        aria-label="Search entries"
      />
      <div id="searchStats" class="text-xs text-brand-red font-voodoo min-h-[14px] mb-4 uppercase tracking-widest"></div>

      <!-- Navigation Buttons -->
      <div class="flex flex-wrap items-center justify-center sm:justify-start gap-2 mb-4 font-voodoo">
        <button id="prevBtn" class="bg-black border border-white text-white py-2 px-4 hover:bg-brand-red hover:text-black hover:border-brand-red transition-all duration-300">PREVIOUS</button>
        <button id="nextBtn" class="bg-black border border-white text-white py-2 px-4 hover:bg-brand-red hover:text-black hover:border-brand-red transition-all duration-300">NEXT</button>
        <button id="randomBtn" class="bg-black border border-white text-white py-2 px-4 hover:bg-brand-red hover:text-black hover:border-brand-red transition-all duration-300">RANDOM</button>
        <button id="indexBtn" class="bg-black border border-white text-white py-2 px-4 hover:bg-brand-red hover:text-black hover:border-brand-red transition-all duration-300">INDEX</button>
      </div>

      <!-- Filter Tags -->
      <div id="filterBtns" class="flex flex-wrap items-center justify-center sm:justify-start gap-2 mb-4 font-voodoo text-xs">
        <button class="filter-btn bg-brand-red border border-brand-red text-black py-1 px-3 transition-colors duration-300" data-filter="all">ALL</button>
        <button class="filter-btn bg-black border border-gray-600 text-gray-400 py-1 px-3 hover:border-brand-red hover:text-brand-red transition-colors duration-300" data-filter="lyric">LYRICS</button>
        <button class="filter-btn bg-black border border-gray-600 text-gray-400 py-1 px-3 hover:border-brand-red hover:text-brand-red transition-colors duration-300" data-filter="poem">POEMS</button>
        <button class="filter-btn bg-black border border-gray-600 text-gray-400 py-1 px-3 hover:border-brand-red hover:text-brand-red transition-colors duration-300" data-filter="film">FILMS</button>
        <button class="filter-btn bg-black border border-gray-600 text-gray-400 py-1 px-3 hover:border-brand-red hover:text-brand-red transition-colors duration-300" data-filter="book">BOOKS</button>
        <button class="filter-btn bg-black border border-gray-600 text-gray-400 py-1 px-3 hover:border-brand-red hover:text-brand-red transition-colors duration-300" data-filter="dream">DREAMS</button>
      </div>

      <!-- Date Navigation Dropdown -->
      <div id="dateNav" class="mt-4 max-h-80 overflow-y-auto border border-white p-2 transition-all duration-300 hidden custom-scrollbar bg-black"></div>
      
      <!-- AI Model Selection -->
      <div class="mt-6 border-t border-white/20 pt-4">
        <label for="puter-model-select" class="block text-xs font-voodoo text-brand-red mb-2 uppercase">
          AI MODEL SELECTION
        </label>
        <select
          id="puter-model-select"
          class="w-full p-2 bg-black border border-gray-700 rounded-none text-gray-200 focus:border-brand-red text-xs font-mono"
        ></select>
      </div>

      <!-- AI Interface -->
      <div class="mt-6 pt-6 border-t border-white/20">
        <h2 class="text-xl font-voodoo text-brand-red mb-4">AI ASSISTANT</h2>
        
        <div class="mb-4">
          <label class="block text-xs font-voodoo text-white mb-2 uppercase">CONTEXT SCOPE:</label>
          <div class="flex flex-wrap gap-2 font-voodoo">
            <button class="context-btn bg-brand-red border border-brand-red text-black py-1 px-3 text-xs" data-context="current">CURRENT</button>
            <button class="context-btn bg-black border border-gray-600 text-gray-400 py-1 px-3 text-xs hover:border-brand-red hover:text-brand-red" data-context="all">ALL</button>
            <button class="context-btn bg-black border border-gray-600 text-gray-400 py-1 px-3 text-xs hover:border-brand-red hover:text-brand-red" data-context="none">NONE</button>
          </div>
          <p class="text-xs text-gray-600 mt-2 font-mono italic" id="contextInfo">Analyzing current entry data.</p>
        </div>
        
        <div class="mb-4">
          <textarea id="aiInput" class="w-full bg-black border border-white text-gray-200 p-2 text-sm focus:border-brand-red min-h-[80px] font-mono placeholder-gray-700" placeholder="INPUT QUERY..." aria-label="AI input"></textarea>
        </div>
        <button id="askAiBtn" class="bg-black border border-white text-white font-voodoo py-2 px-6 text-sm hover:bg-brand-red hover:text-black hover:border-brand-red transition-colors duration-300 w-full sm:w-auto">EXECUTE</button>
        
        <div class="mb-4 mt-6">
          <div id="aiResponse" class="w-full bg-black border border-gray-800 text-gray-300 p-3 text-sm min-h-[120px] max-h-[500px] overflow-y-auto custom-scrollbar whitespace-pre-wrap font-mono border-l-2 border-l-brand-red">
            <p class="text-gray-600 italic">...WAITING FOR INPUT...</p>
          </div>
        </div>
      </div>

      <div id="entryInfo" class="text-gray-500 text-xs mt-4 mb-4 font-mono"></div>
    </div>

    <!-- CONTENT DISPLAY (Lots of padding bottom) -->
    <div id="loading" class="text-center py-12 text-brand-red text-xl font-voodoo animate-pulse">LOADING ARCHIVES...</div>
    <div id="content" class="text-sm leading-relaxed whitespace-pre-wrap font-mono py-8 mb-32" style="display:none;"></div>
  </div>

  <script>
    const TXT_FILE_URL = 'dreamweaver.txt';

    const TAG_PATTERNS = {
      all: /.*/,
      lyric: /\[lyric\]|\blyrics?\b/i,
      poem: /\[poem\]|\bpoems?\b/i,
      film: /\[film\]|\bfilms?\b|\bmovies?\b/i,
      book: /\[book\]|\bbooks?\b|\breading\b/i,
      dream: /\[dream\]|\bdreams?\b|\bdreamt\b/i
    };

    const AVAILABLE_PUTER_MODELS = [
      { group: 'DeepSeek', options: [
        { value: 'deepseek-chat', label: 'DEEPSEEK V3' },
        { value: 'deepseek-reasoner', label: 'DEEPSEEK R1 (REASONER)' },
      ]},
      { group: 'Google', options: [
        { value: 'google/gemma-3-4b-it:free', label: 'GEMMA 3 4B' },
        { value: 'google/gemma-2-9b-it:free', label: 'GEMMA 2 9B' },
      ]}
    ];

    const datePattern = /^(\d{1,2}\s*(?:january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)[a-z]*\s*\d{0,4})/im;

    let entries = [];
    let currentIndex = 0;
    let currentFilter = 'all';
    let searchQuery = '';
    let searchResults = [];
    let isSearching = false;
    let isDateIndexVisible = false;
    let selectedPuterModel = AVAILABLE_PUTER_MODELS[0]?.options[0]?.value || '';
    let searchTimeout = null;
    let aiContext = 'current';

    // Element Refs
    const searchBox = document.getElementById('searchBox');
    const searchStats = document.getElementById('searchStats');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const randomBtn = document.getElementById('randomBtn');
    const indexBtn = document.getElementById('indexBtn');
    const dateNav = document.getElementById('dateNav');
    const entryInfo = document.getElementById('entryInfo');
    const loadingDiv = document.getElementById('loading');
    const contentDiv = document.getElementById('content');
    const puterModelSelect = document.getElementById('puter-model-select');
    const aiInput = document.getElementById('aiInput');
    const askAiBtn = document.getElementById('askAiBtn');
    const aiResponseDiv = document.getElementById('aiResponse');
    const contextInfo = document.getElementById('contextInfo');

    function debounce(func, delay) {
      return function(...args) {
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    function escapeRegex(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function parseSearchQuery(query) {
      const terms = { and: [], or: [], not: [], exact: [] };
      const exactMatches = query.match(/"([^"]+)"/g);
      if (exactMatches) {
        exactMatches.forEach(match => {
          terms.exact.push(match.replace(/"/g, '').toLowerCase());
          query = query.replace(match, '');
        });
      }
      const words = query.toLowerCase().split(/\s+/).filter(w => w);
      let currentOp = 'and';
      words.forEach(word => {
        if (word === 'and') currentOp = 'and';
        else if (word === 'or') currentOp = 'or';
        else if (word.startsWith('-')) terms.not.push(word.substring(1));
        else if (word) terms[currentOp].push(word);
      });
      return terms;
    }

    function matchesSearch(entry, terms) {
      const searchText = (entry.content + ' ' + entry.date).toLowerCase();
      if (terms.not.some(t => searchText.includes(t))) return false;
      if (terms.exact.some(t => !searchText.includes(t))) return false;
      if (terms.and.some(t => !searchText.includes(t))) return false;
      if (terms.or.length > 0 && !terms.or.some(t => searchText.includes(t))) return false;
      return true;
    }

    function highlightText(text, query) {
      if (!query.trim()) return text;
      const terms = parseSearchQuery(query);
      const allTerms = [...terms.exact, ...terms.and, ...terms.or].filter((t, i, s) => s.indexOf(t) === i);
      let result = text;
      allTerms.sort((a, b) => b.length - a.length).forEach(term => {
        const regex = new RegExp(`(${escapeRegex(term)})`, 'gi');
        result = result.replace(regex, '<span class="highlight">$1</span>');
      });
      return result;
    }

    function getTagClass(tag) {
      return 'border-gray-600 text-gray-400 hover:border-brand-red hover:text-brand-red';
    }

    async function loadText() {
      try {
        const response = await fetch(TXT_FILE_URL);
        const text = await response.text();
        parseEntries(text);
        loadingDiv.style.display = 'none';
        contentDiv.style.display = 'block';
        if (entries.length > 0) showEntry(0);
        buildDateIndex();
      } catch (error) {
        loadingDiv.innerHTML = `<p class="text-brand-red">ERROR LOADING FILE.</p><p class="text-xs text-gray-500 mt-2">${error.message}</p>`;
      }
    }

    function parseEntries(text) {
      const lines = text.split('\n');
      let currentEntry = { id: 0, date: 'Start', content: '', tags: [] };
      let entryId = 0;

      lines.forEach(line => {
        const match = line.match(datePattern);
        if (match) {
          if (currentEntry.content.trim()) {
            detectTags(currentEntry);
            entries.push(currentEntry);
          }
          currentEntry = { id: ++entryId, date: match[0].trim(), content: line + '\n', tags: [] };
        } else {
          currentEntry.content += line + '\n';
        }
      });

      if (currentEntry.content.trim()) {
        detectTags(currentEntry);
        entries.push(currentEntry);
      }
    }

    function detectTags(entry) {
      for (const [tag, pattern] of Object.entries(TAG_PATTERNS)) {
        if (tag !== 'all' && pattern.test(entry.content)) entry.tags.push(tag);
      }
    }

    function getFilteredEntries() {
      if (currentFilter === 'all') return entries;
      return entries.filter(e => e.tags.includes(currentFilter));
    }

    function updateSearchStats() {
      if (isSearching) {
        searchStats.textContent = `${searchResults.length} MATCHES FOUND`;
      } else {
        const filtered = getFilteredEntries();
        searchStats.textContent = currentFilter !== 'all' ? `${filtered.length} ENTRIES IN '${currentFilter.toUpperCase()}'` : '';
      }
    }

    function performSearch(query) {
      searchQuery = query;
      if (!query.trim()) {
        isSearching = false;
        searchResults = [];
        updateSearchStats();
        buildDateIndex();
        const filtered = getFilteredEntries();
        if (filtered.length > 0) showEntry(filtered[0].id);
        return;
      }

      isSearching = true;
      const terms = parseSearchQuery(query);
      searchResults = getFilteredEntries().filter(e => matchesSearch(e, terms));
      updateSearchStats();
      buildDateIndex();
      if (searchResults.length > 0) showEntry(searchResults[0].id);
    }

    function showEntry(entryId) {
      if (entries.length === 0) {
        contentDiv.innerHTML = '<p class="text-gray-500 text-center">NO CONTENT.</p>';
        entryInfo.textContent = '';
        return;
      }

      const entry = entries.find(e => e.id === entryId);
      if (!entry) {
        contentDiv.innerHTML = '<p class="text-gray-500 text-center">NO MATCH FOUND.</p>';
        entryInfo.textContent = '';
        return;
      }

      currentIndex = entryId;
      const displayContent = isSearching && searchQuery.trim() ? highlightText(entry.content, searchQuery) : entry.content;
      contentDiv.innerHTML = displayContent;

      const viewableItems = isSearching ? searchResults : getFilteredEntries();
      const itemIndex = viewableItems.findIndex(e => e.id === currentIndex);
      
      entryInfo.innerHTML = `
        <span class="text-brand-red font-voodoo text-lg uppercase">${entry.date}</span>
        <div class="inline-flex ml-4">${entry.tags.map(tag => 
          `<span class="inline-block px-2 py-0.5 ml-1 text-xs border border-gray-800 text-gray-500 uppercase">${tag}</span>`
        ).join('')}</div>`;

      prevBtn.disabled = itemIndex <= 0;
      nextBtn.disabled = itemIndex >= viewableItems.length - 1;
      
      prevBtn.style.opacity = prevBtn.disabled ? '0.3' : '1';
      nextBtn.style.opacity = nextBtn.disabled ? '0.3' : '1';

      // NOTE: We do NOT scroll to top here automatically anymore to keep AI prompt in view if using it
      // but if you want to jump to text, you can keep:
      // window.scrollTo({ top: 0, behavior: 'smooth' });
      
      updateSearchStats();
    }

    function buildDateIndex() {
      dateNav.innerHTML = '';
      const items = isSearching ? searchResults : getFilteredEntries();

      if (items.length === 0) {
        dateNav.innerHTML = '<p class="text-gray-500 text-sm p-2 font-mono">NO ENTRIES FOUND.</p>';
        return;
      }

      items.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'group block p-2 cursor-pointer border-b border-gray-900 last:border-b-0 hover:bg-gray-900 transition-colors duration-200';
        div.setAttribute('data-id', entry.id);
        div.innerHTML = `
          <div class="flex items-center text-gray-400 group-hover:text-brand-red text-sm font-mono">
            ${entry.date}
          </div>
        `;
        div.addEventListener('click', () => {
          showEntry(entry.id);
          dateNav.classList.add('hidden');
          isDateIndexVisible = false;
        });
        dateNav.appendChild(div);
      });
    }

    function showRandomEntry() {
      const pool = isSearching ? searchResults : getFilteredEntries();
      if (pool.length > 0) {
        const random = pool[Math.floor(Math.random() * pool.length)];
        showEntry(random.id);
      }
    }

    function navigateEntries(direction) {
      const items = isSearching ? searchResults : getFilteredEntries();
      if (items.length === 0) return;
      const idx = items.findIndex(e => e.id === currentIndex);
      const newIdx = direction === 'next' ? Math.min(idx + 1, items.length - 1) : Math.max(idx - 1, 0);
      if (newIdx !== idx) showEntry(items[newIdx].id);
    }

    function populatePuterModels() {
      AVAILABLE_PUTER_MODELS.forEach(group => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = group.group;
        group.options.forEach(model => {
          const option = document.createElement('option');
          option.value = model.value;
          option.textContent = model.label;
          optgroup.appendChild(option);
        });
        puterModelSelect.appendChild(optgroup);
      });
      puterModelSelect.value = selectedPuterModel;
    }

    function buildAIPrompt(userMessage) {
      let systemContext = '';
      if (aiContext === 'current' && currentIndex !== -1) {
        const entry = entries.find(e => e.id === currentIndex);
        if (entry) {
          const preview = entry.content.substring(0, 3000);
          systemContext = `CONTEXT:\nDate: ${entry.date}\nTags: ${entry.tags.join(', ')}\n\nContent:\n${preview}\n\n---\n\n`;
        }
      } else if (aiContext === 'all') {
        const list = entries.map(e => `- ${e.date} [${e.tags.join(', ')}]`).join('\n');
        systemContext = `CONTEXT SUMMARY:\n${list}\n\n---\n\n`;
      }
      return systemContext + userMessage;
    }

    async function generateWithPuterAI(prompt, model, responseElement) {
      responseElement.innerHTML = `<p class="text-brand-red animate-pulse">ESTABLISHING UPLINK TO ${model}...</p>`;
      try {
        const fullPrompt = buildAIPrompt(prompt);
        const response = await puter.ai.chat(fullPrompt, { model, temperature: 0.7, max_tokens: 2000 });
        responseElement.textContent = `>> TRANSMISSION RECEIVED:\n\n${response}`;
      } catch (error) {
        responseElement.innerHTML = `<p class="text-brand-red">CONNECTION ERROR: ${error.message}</p>`;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadText();
      populatePuterModels();
    });

    searchBox.addEventListener('input', debounce(e => performSearch(e.target.value), 300));
    prevBtn.addEventListener('click', () => navigateEntries('prev'));
    nextBtn.addEventListener('click', () => navigateEntries('next'));
    randomBtn.addEventListener('click', showRandomEntry);
    indexBtn.addEventListener('click', () => {
      isDateIndexVisible = !isDateIndexVisible;
      dateNav.classList.toggle('hidden');
      if (isDateIndexVisible) buildDateIndex();
    });

    document.getElementById('filterBtns').addEventListener('click', e => {
      if (e.target.classList.contains('filter-btn')) {
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.remove('bg-brand-red', 'text-black', 'border-brand-red');
          btn.classList.add('bg-black', 'text-gray-400', 'border-gray-600');
        });
        e.target.classList.remove('bg-black', 'text-gray-400', 'border-gray-600');
        e.target.classList.add('bg-brand-red', 'text-black', 'border-brand-red');
        currentFilter = e.target.dataset.filter;
        
        if (isSearching) performSearch(searchQuery);
        else {
          const filtered = getFilteredEntries();
          if (filtered.length > 0) showEntry(filtered[0].id);
          buildDateIndex();
          if(isDateIndexVisible) buildDateIndex();
        }
      }
    });

    puterModelSelect.addEventListener('change', e => selectedPuterModel = e.target.value);

    askAiBtn.addEventListener('click', async () => {
      const msg = aiInput.value.trim();
      if (!msg) {
        aiResponseDiv.innerHTML = '<p class="text-brand-red">INPUT REQUIRED.</p>';
        return;
      }
      askAiBtn.disabled = true;
      aiInput.disabled = true;
      try {
        await generateWithPuterAI(msg, puterModelSelect.value, aiResponseDiv);
      } catch (error) {
        aiResponseDiv.innerHTML = `<p class="text-brand-red">SYSTEM ERROR: ${error.message}</p>`;
      } finally {
        askAiBtn.disabled = false;
        aiInput.disabled = false;
        aiInput.value = '';
      }
    });

    document.addEventListener('click', e => {
      if (e.target.classList.contains('context-btn')) {
        document.querySelectorAll('.context-btn').forEach(btn => {
          btn.classList.remove('bg-brand-red', 'text-black', 'border-brand-red');
          btn.classList.add('bg-black', 'text-gray-400', 'border-gray-600');
        });
        e.target.classList.remove('bg-black', 'text-gray-400', 'border-gray-600');
        e.target.classList.add('bg-brand-red', 'text-black', 'border-brand-red');
        
        aiContext = e.target.dataset.context;
        const descriptions = {
            current: 'Analyzing current entry data.',
            all: 'Analyzing full archive metadata.',
            none: 'No contextual data attached.'
        };
        contextInfo.textContent = descriptions[aiContext];
      }
    });

    document.addEventListener('keydown', e => {
      if (document.activeElement === searchBox || document.activeElement === aiInput) return;
      if (e.key === 'ArrowLeft') { e.preventDefault(); navigateEntries('prev'); }
      if (e.key === 'ArrowRight') { e.preventDefault(); navigateEntries('next'); }
      if (e.key === 'r' || e.key === 'R') { e.preventDefault(); showRandomEntry(); }
      if (e.key === '/') { e.preventDefault(); searchBox.focus(); }
    });
  </script>
</body>
</html>
