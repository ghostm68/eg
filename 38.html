<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>.38 SPECIAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --blood-deep: #8B0000;
            --blood-dark: #5C0000;
            --crimson: #DC143C;
            --iron: #2B2B2B;
            --steel: #4A4A4A;
            --ash: #D3D3D3;
            --amber: #FFB347;
            --shadow: rgba(0, 0, 0, 0.8);
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Crimson Pro',serif;background:var(--iron);color:var(--ash);line-height:1.8;overflow-x:hidden}
        .geometry{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;opacity:.15}
        .geometry-line{position:absolute;background:var(--blood-deep)}
        .geometry-line.vertical{width:1px;height:100%;top:0}
        .geometry-line.horizontal{height:1px;width:100%;left:0}
        .v1{left:15%}.v2{left:35%}.v3{left:65%}.v4{left:85%}
        .h1{top:20%}.h2{top:50%}.h3{top:80%}

        /* nav */
        .nav{position:fixed;top:2rem;right:2rem;z-index:1000;font-family:'IBM Plex Mono',monospace;font-size:.85rem}
        .nav-toggle{background:var(--blood-deep);color:var(--ash);border:1px solid var(--crimson);padding:.75rem 1.5rem;cursor:pointer;text-transform:uppercase;letter-spacing:.1em;transition:all .3s ease}
        .nav-toggle:hover{background:var(--crimson);box-shadow:0 0 20px rgba(220,20,60,.5)}
        .nav-menu{position:absolute;top:100%;right:0;background:var(--iron);border:1px solid var(--blood-deep);margin-top:.5rem;max-height:0;overflow:hidden;transition:max-height .3s ease}
        .nav-menu.open{max-height:800px}
        .nav-link{display:block;padding:.75rem 1.5rem;color:var(--ash);text-decoration:none;border-bottom:1px solid var(--steel);transition:all .2s ease}
        .nav-link:hover{background:var(--blood-deep);padding-left:2rem}

        /* hero */
        .hero{height:100vh;display:flex;align-items:center;justify-content:center;position:relative;background:linear-gradient(135deg,var(--iron) 0%,var(--blood-dark) 100%)}
        .hero-content{position:relative;z-index:1;text-align:center;max-width:1200px;padding:2rem}
        .hero-carousel{width:400px;height:400px;max-width:90%;margin:0 auto 3rem;position:relative;perspective:1000px}
        .hero-carousel-container{width:100%;height:100%;position:relative;transform-style:preserve-3d;animation:rotate 30s infinite linear}
        @keyframes rotate{from{transform:rotateY(0deg)}to{transform:rotateY(360deg)}}
        .hero-carousel-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;border:2px solid var(--crimson);box-shadow:0 0 40px rgba(220,20,60,.3);overflow:hidden}
        .hero-carousel-face img{width:100%;height:100%;object-fit:cover;filter:grayscale(40%) contrast(1.2)}
        .hero-carousel-caption{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top,rgba(0,0,0,.9),transparent);padding:1rem;font-family:'IBM Plex Mono',monospace;font-size:.7rem;color:var(--ash);text-align:center}
        .hero-carousel-face:nth-child(1){transform:rotateY(0deg) translateZ(200px)}
        .hero-carousel-face:nth-child(2){transform:rotateY(60deg) translateZ(200px)}
        .hero-carousel-face:nth-child(3){transform:rotateY(120deg) translateZ(200px)}
        .hero-carousel-face:nth-child(4){transform:rotateY(180deg) translateZ(200px)}
        .hero-carousel-face:nth-child(5){transform:rotateY(240deg) translateZ(200px)}
        .hero-carousel-face:nth-child(6){transform:rotateY(300deg) translateZ(200px)}
        .hero-carousel:hover .hero-carousel-container{animation-play-state:paused}
        @media(max-width:768px){.hero-carousel{width:300px;height:300px}.hero-carousel-face{transform:rotateY(var(--angle)) translateZ(150px)}}

        .hero-title{font-size:clamp(2.5rem,8vw,6rem);font-weight:700;line-height:1.1;margin-bottom:1rem;color:var(--crimson);text-shadow:2px 2px 0 var(--blood-dark),4px 4px 10px var(--shadow);letter-spacing:-.02em}
        .hero-subtitle{font-size:clamp(1rem,2vw,1.5rem);color:var(--ash);font-weight:400;margin-bottom:2rem;opacity:.9}
        .hero-author{font-family:'IBM Plex Mono',monospace;font-size:.9rem;color:var(--amber);text-transform:uppercase;letter-spacing:.2em}
        .scroll-indicator{position:absolute;bottom:3rem;left:50%;transform:translateX(-50%);color:var(--crimson);font-family:'IBM Plex Mono',monospace;font-size:.8rem;text-transform:uppercase;letter-spacing:.2em;animation:pulse 2s ease-in-out infinite}
        @keyframes pulse{0%,100%{opacity:.5;transform:translateX(-50%) translateY(0)}50%{opacity:1;transform:translateX(-50%) translateY(-10px)}}

        /* chapters */
        .chapter{min-height:100vh;padding:8rem 2rem;opacity:0;transform:translateY(50px);transition:opacity .8s ease,transform .8s ease}
        .chapter.visible{opacity:1;transform:translateY(0)}
        .chapter-container{max-width:1400px;margin:0 auto;display:flex;gap:4rem;align-items:flex-start}
        .prose{flex:1;font-size:clamp(1.1rem,2vw,1.3rem);line-height:1.9}
        .image-rail{position:sticky;top:8rem;width:30%;max-height:calc(100vh - 10rem);overflow-y:auto;padding-right:1rem}
        .image-rail::-webkit-scrollbar{width:6px}
        .image-rail::-webkit-scrollbar-track{background:var(--iron)}
        .image-rail::-webkit-scrollbar-thumb{background:var(--blood-deep);border-radius:3px}
        .rail-image{margin-bottom:2rem;cursor:pointer}
        .rail-image img{width:100%;display:block;filter:grayscale(40%) contrast(1.1);border:2px solid var(--steel);transition:all .3s ease}
        .rail-image:hover img{filter:grayscale(0%) contrast(1);border-color:var(--crimson);box-shadow:0 0 20px rgba(220,20,60,.4)}
        .rail-image-caption{font-family:'IBM Plex Mono',monospace;font-size:.7rem;color:var(--steel);margin-top:.5rem;text-align:center;font-style:italic}
        @media(max-width:968px){.chapter-container{flex-direction:column}.image-rail{position:static;width:100%;max-height:none;margin-top:3rem}}

        .prose p{margin-bottom:1.5rem}
        .prose p:first-of-type::first-letter{font-size:4em;line-height:.8;float:left;margin:.1em .1em 0 0;color:var(--crimson);font-weight:700}
        .prose em{color:var(--amber)}
        .prose strong{color:var(--crimson)}

        /* annotations */
        .annotation-trigger{color:var(--amber);text-decoration:underline;text-decoration-style:dotted;cursor:pointer}
        .annotation-trigger:hover{color:var(--crimson)}
        .annotation-modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:9999}
        .annotation-modal-overlay.active{display:block}
        .annotation-modal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--blood-dark);border:2px solid var(--crimson);padding:3rem;max-width:600px;width:90%;z-index:10000;box-shadow:0 0 50px rgba(220,20,60,.5)}
        .annotation-modal.active{display:block}
        .annotation-modal-close{position:absolute;top:1rem;right:1rem;background:none;border:none;color:var(--ash);font-size:2rem;cursor:pointer}
        .annotation-modal-close:hover{color:var(--crimson)}
        .annotation-modal-label{font-family:'IBM Plex Mono',monospace;font-size:.85rem;color:var(--crimson);text-transform:uppercase;letter-spacing:.2em;margin-bottom:1.5rem}
        .annotation-modal-content{font-size:1.05rem;line-height:1.7}

        /* lightbox */
        .lightbox{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);z-index:9999;justify-content:center;align-items:center;cursor:pointer}
        .lightbox.active{display:flex}
        .lightbox img{max-width:90%;max-height:90%;box-shadow:0 0 50px rgba(220,20,60,.5)}
        .lightbox-close{position:absolute;top:2rem;right:2rem;color:var(--ash);font-size:3rem;cursor:pointer}
        .lightbox-close:hover{color:var(--crimson)}

        /* footer */
        .footer{background:var(--blood-dark);padding:3rem 2rem;text-align:center;border-top:1px solid var(--crimson)}
        .footer-text{font-family:'IBM Plex Mono',monospace;font-size:.9rem;color:var(--steel)}
    </style>
</head>
<body>
<div class="geometry">
    <div class="geometry-line vertical v1"></div><div class="geometry-line vertical v2"></div>
    <div class="geometry-line vertical v3"></div><div class="geometry-line vertical v4"></div>
    <div class="geometry-line horizontal h1"></div><div class="geometry-line horizontal h2"></div>
    <div class="geometry-line horizontal h3"></div>
</div>

<nav class="nav">
    <button class="nav-toggle" onclick="document.getElementById('navMenu').classList.toggle('open')">Chapters</button>
    <div class="nav-menu" id="navMenu"></div>
</nav>

<section class="hero">
    <div class="hero-content">
        <div class="hero-carousel"><div class="hero-carousel-container" id="heroCarousel"></div></div>
        <h1 id="heroTitle"></h1>
        <p id="heroSubtitle"></p>
        <p id="heroAuthor"></p>
    </div>
    <div class="scroll-indicator">↓ Scroll to Begin</div>
</section>

<div id="chapters-container"></div>

<footer class="footer">
    <p class="footer-text">© 2024 Inky | www.inkrealm.info</p>
</footer>

<!-- lightbox -->
<div class="lightbox" id="lightbox" onclick="this.classList.remove('active')">
    <span class="lightbox-close">×</span>
    <img id="lightbox-img" src="" alt="">
</div>

<script>
/* --------------  embedded JSON  -------------- */
const contentData = {
  "title": ".38 SPECIAL",
  "subtitle": "A novel",
  "author": "by Inky",
  "heroCarousel": [
    {"src":"https://raw.githubusercontent.com/ghostm68/pantheon/main/New_York_City_Federal_Art_project_432-01.jpeg","alt":"New York Draft Riots, 1863","caption":"Draft Riots, July 1863"},
    {"src":"https://raw.githubusercontent.com/ghostm68/pantheon/main/NYC_Manhattan_1938_Franz_Grasser-01.jpeg","alt":"Manhattan 1938","caption":"Lower East Side, 1938"},
    {"src":"https://raw.githubusercontent.com/ghostm68/pantheon/main/street%20scene.jpeg","alt":"Hell's Kitchen street scene","caption":"Hell's Kitchen"},
    {"src":"https://raw.githubusercontent.com/ghostm68/pantheon/main/church%20interior.jpeg","alt":"St. Jude's Church","caption":"St. Jude's Church"},
    {"src":"https://raw.githubusercontent.com/ghostm68/pantheon/main/foyer-astoria-01.jpeg","alt":"Waldorf Astoria foyer","caption":"Waldorf Astoria"},
    {"src":"https://raw.githubusercontent.com/ghostm68/pantheon/main/pier541-01.jpeg","alt":"Pier 54, Hudson River","caption":"Pier 54"}
  ],
  "chapters": [
    {
      "id": "prologue",
      "number": "Prologue",
      "title": "The Physics of Expansion",
      "meta": "July 1863",
      "content": [
        "The <em>Star of Erin</em> did not glide into New York Harbor; it limped, groaning under the weight of three hundred souls packed into the steerage. The air down there was a solid thing—a thick, suffocating stew of unwashed bodies, bile, and the damp rot of the hull. It coated the back of Heinrich's throat like grease.",
        "When they docked, they thought they had found sanctuary. Instead, they stepped off the gangplank into a city that was eating itself alive.",
        "The {{draft-riots|Draft Riots}} were in their third day. The sky over Manhattan was bruised purple with smoke. Mobs roamed the cobblestones, hunting. They weren't soldiers; they were neighbors, butchers, dockworkers, turned savage by the heat and the conscription notices.",
        "Heinrich pulled Sarah into an alleyway off Worth Street to avoid a roving pack of men carrying torches and clubs. He had no weapon but a heavy iron tool he'd stolen from the ship's carpenter.",
        "A man stepped out from the shadows—a looter, his eyes wide and rimmed with soot. He raised a pistol, an old single-shot percussion cap.",
        "The bang was not a thunderclap; it was a flat, dry crack.",
        "The ball missed Heinrich but struck the brick wall behind him, sending a spray of red dust into the air. Heinrich didn't think. He lunged, driving the iron tool into the man's temple. It was wet work. Vicious. Necessary.",
        "Later, when the streets were quiet, Heinrich dug the bullet out of the mortar where it had lodged. It wasn't a round musket ball. It was conical. A {{minie-ball|Minié ball}}.",
        "He held it up to the moonlight for Sarah to see.",
        "\"Look,\" he whispered, his German accent thick. \"It is hollow at the base.\"",
        "When the gunpowder ignited, the gas expanded into the hollow skirt, forcing the soft lead to flare out and grip the rifling of the barrel. It spun. It traveled faster. And when it hit a man, it didn't just pass through. It flattened. It became a jagged coin the size of a half-dollar, taking bone and organ with it.",
        "\"The city is like this bullet,\" Heinrich said, pocketing the piece of lead. \"It waits until it is inside you. Then it expands.\""
      ],
      "images": [
        {"id":"ford-model","src":"https://raw.githubusercontent.com/ghostm68/pantheon/main/fordwithmodel.jpeg","alt":"1934 Ford V8 with model","caption":"The American promise: motion and escape"}
      ],
      "annotations": {
        "draft-riots": {"label":"Historical Context","content":"The New York City Draft Riots (July 13-16, 1863) were the largest civil insurrection in American history aside from the Civil War itself. Over 120 people were killed."},
        "minie-ball": {"label":"Weaponry","content":"The Minié ball revolutionized warfare. Its hollow base expanded on firing, gripping rifle grooves for greater accuracy and devastating wounds."}
      }
    },
    {
      "id": "chapter1",
      "number": "Chapter 1",
      "title": "The Invisible Man",
      "meta": "November 1938",
      "content": [
        "The rain in Manhattan didn't wash the streets; it just made the grime reflective.",
        "Marguerite sat in her office on the Lower East Side. The room was a study in shadows and cheap tobacco smoke. On her desk, the radio—a walnut-veneer {{philco|Philco}} with a glowing amber dial—hummed with the voice of a panicked news anchor, squeezed between bouts of static.",
        "\"…and in Europe, Chancellor Hitler's demands continue to…\"",
        "She switched it off. The silence was heavier than the noise.",
        "She wasn't looking at a law book. She was staring at a small, black notebook she had lifted from a dead man's pocket three hours ago. It wasn't a register of numbers; it was a list of dates and locations, written in a code that looked like prayer citations.",
        "<em>Matthew 21:12. John 2:15.</em>",
        "Bible verses about cleansing the temple. Or, in this case, moving narcotics through the rectory.",
        "The telephone on her desk—a heavy black {{bakelite|Bakelite}} fortress—trilled. It was a jarring, mechanical sound.",
        "Marguerite picked up the receiver. \"Algonquin 4-6620.\"",
        "\"Miss LeRoux,\" a voice said. Smooth. Cultured. Like velvet wrapped around a razor blade. \"You have something that belongs to the Church. We would like to discuss a donation.\"",
        "\"I don't donate to the collection plate, Father,\" she said, recognizing the cadence, if not the voice.",
        "\"I am not a priest,\" the voice replied. \"Meet me at the {{paradise-theater|Paradise Theater}}. The projection booth. Midnight. Come alone, or the Rabbi finds his synagogue darker than usual.\"",
        "The line went dead."
      ],
      "images": [
        {"id":"philco-radio","src":"https://raw.githubusercontent.com/ghostm68/pantheon/main/Imagephilco%20advertPM-01.jpeg","alt":"Philco radio advert","caption":"Philco Model 38-620"},
        {"id":"theater-exterior","src":"https://raw.githubusercontent.com/ghostm68/pantheon/main/theaterexterior-01.jpeg","alt":"Paradise Theater exterior","caption":"Paradise Theater, Bronx"},
        {"id":"projection-booth","src":"https://raw.githubusercontent.com/ghostm68/pantheon/main/projection01414-l-01.jpeg","alt":"35mm projection booth","caption":"Projection booth equipment"},
        {"id":"theater-interior","src":"https://raw.githubusercontent.com/ghostm68/pantheon/main/loewsinterior3-01.jpeg","alt":"Atmospheric theater ceiling","caption":"Painted stars ceiling"}
      ],
      "annotations": {
        "philco": {"label":"Period Object","content":"Philco radios dominated American homes in the 1930s. The amber-lit dial was a signature feature."},
        "bakelite": {"label":"Material Culture","content":"Bakelite, the first fully synthetic plastic, embodied the machine-age aesthetic."},
        "paradise-theater": {"label":"Architecture","content":"Movie palaces of the 1920s-30s featured atmospheric ceiling designs simulating night skies."}
      }
    },
    {
      "id": "chapter2",
      "number": "Chapter 2",
      "title": "The Fabric of Sin",
      "meta": null,
      "content": [
        "The Garment District didn't sleep; it just changed shifts. Even at 1:00 AM, the streets south of 40th buzzed with the sound of delivery trucks idling and the hiss of steam pressing irons from the sweatshops on the upper floors.",
        "Marguerite didn't take the elevator to Jacob's loft. She took the freight stairs, her heels clicking on the metal grate, echoing like gunshots in the stairwell.",
        "She found the door unlocked. Bad tradecraft, Jacob would say. An invitation, she thought.",
        "The loft was a cavern of shadows and suspended dust. Bolts of fabric—wool, silk, cheap rayon—stood like sentinels against the brick walls. In the center, under a single cone of yellow electric light, sat Rabbi Jacob Levinson.",
        "He wasn't praying. He was hunched over a drafting table, a jeweler's loupe screwed into his right eye, examining the pages of \"The Book\" Marguerite had left with him earlier.",
        "A bottle of rye—cheap, legal swill that conjured paint thinner—sat open next to a half-eaten corned beef sandwich.",
        "\"You're late,\" Jacob said, not looking up. \"And your tang's like the cinema. Popcorn and disappointment.\"",
        "\"I met Bonanno,\" Marguerite said, tossing her wet trench coat onto a stack of gray wool. \"He wants the book, Jacob. He gave me twenty-four hours before he sends 'The Hammer' to redecorate your synagogue.\"",
        "Jacob finally looked up. He took the loupe out of his eye. His face was angular, unshaven, his eyes dark with a fatigue that went deeper than sleep deprivation. He looked like a prophet who had seen the burning bush and realized it was just an arsonist.",
        "\"Bonanno,\" Jacob scoffed, reaching for the rye. He poured two shots into tea glasses. \"The man thinks he's Caesar because he pays off the precinct captain. But he's right to be worried about this.\"",
        "Jacob tapped the little black book.",
        "\"It's not a ledger, Marguerite. It's a roster. I decoded the first section using a Gematria cipher—simple number substitution based on Hebrew text. It's clever. To the naked eye, it looks like a prayer schedule for the Feast of San Gennaro.\"",
        "\"And to the trained eye?\" Marguerite asked, picking up the whiskey.",
        "\"It's a shipping manifest for the Port of Naples,\" Jacob said, his voice dropping. \"They aren't just moving heroin, Marguerite. They're moving gold. Bullion. Stamped with the fasces. Mussolini's gold, coming into New York to buy influence, buy unions, maybe even buy politicians like De Becker.\"",
        "He downed the drink. \"The Church isn't just looking the other way. They're the bank.\"",
        "Marguerite felt the cold reality of it settle in her stomach. This wasn't local crime. This was geopolitics bleeding into Hell's Kitchen.",
        "\"We have to burn it,\" Jacob said, standing up. He moved toward the small coal stove in the corner. \"If Bonanno knows we have this, we're dead. If the Feds find out we have this, we're dead. This isn't a lever, Marguerite. It's a grenade with the pin pulled.\"",
        "\"No.\" Marguerite grabbed his wrist. Her grip was iron. \"We don't burn it. It's the only thing keeping us alive. It's insurance.\"",
        "\"It's a death sentence!\" Jacob shouted, spinning on her.",
        "They were close now. Too close. The scent of rain on her skin mixed with the rye on his breath. The fear in the room was a physical pressure, a static charge building between them.",
        "\"We fight,\" Marguerite whispered. \"We take this to Damien. We find where they're storing the shipment.\"",
        "\"Damien?\" Jacob laughed, a bitter, sharp sound. \"The priest? He's part of the machinery, Marguerite! He wears the uniform!\"",
        "\"He's a man,\" she said. \"Just like you.\"",
        "The argument died in his throat as he looked at her. The adrenaline of the threat—Bonanno, the gold, the imminent violence—shifted into something else. It was the biological imperative of people standing on the edge of a cliff.",
        "Jacob's hand moved from her wrist to her waist. It wasn't gentle. It was a desperate claim. He pulled her against him, his mouth finding hers with a hunger that had nothing to do with romance and everything to do with obliteration.",
        "She didn't pull away. She kissed him back, biting his lip, tasting the copper of blood and the burn of whiskey. She needed to feel something other than the cold fear Bonanno had instilled in the projection booth.",
        "They didn't make it to the cot in the corner. He lifted her onto the drafting table, scattering the papers, the code breaking, the evidence of their doom hitting the floor.",
        "The sex was frantic, a collision of bodies in the half-light of the garment loft. There was no tenderness, only the friction of survival. His hands were in her hair, on her hips, anchoring himself to the only real thing left in a world going mad. She arched against him, the rough wood of the table scraping her skin, the sound of their breath drowning out the distant wail of a police siren.",
        "For a few minutes, there was no Bonanno. No De Becker. No coming war. Just the heat.",
        "Afterward, the silence returned, louder than before.",
        "Marguerite buttoned her blouse, her fingers trembling slightly. Jacob sat on the edge of the table, head in his hands. The shame of the devout man who had just succumbed to the flesh was already setting in.",
        "He reached over and turned on the radio, needing a voice to fill the void.",
        "\"…reports of smashed windows in Berlin… synagogues burning… the Chancellor declares…\"",
        "Jacob squeezed his eyes shut. \"They're doing it there, Marguerite. And Bonanno is helping them do it here.\"",
        "He slid off the table and picked up the black book from the floor. He handed it to her.",
        "\"St. Jude's,\" he said, his voice flat, dead. \"The cipher references a storage cellar under the bell tower at St. Jude's. If the gold is anywhere, it's there.\"",
        "\"Will you come with me?\" Marguerite asked.",
        "Jacob looked at the dark window, then at her. \"I'm a Rabbi, Marguerite. I can't walk into a church rectory at midnight.\"",
        "He paused.",
        "\"But I know a man who can pick a lock on a reliquary. I'll meet you there. 3:00 AM.\"",
        "Marguerite nodded. She touched his cheek—a brief, fleeting apology for using him, and for enjoying it.",
        "\"Bring a crowbar,\" she said.",
        "\"I'll bring a gun,\" Jacob replied."
      ],
      "images": [
        {"id":"apartment-interior","src":"https://raw.githubusercontent.com/ghostm68/pantheon/main/RubyRossWood.WalkersNYCApartment.1937.-01.jpeg","alt":"New York apartment interior, 1937","caption":"Manhattan living, 1937"}
      ],
      "annotations": {}
    }
  ]
};

/* --------------  render  -------------- */
function renderPage(){
  // hero
  ['heroTitle','heroSubtitle','heroAuthor'].forEach(id=>document.getElementById(id).textContent=contentData[id.replace('hero','').toLowerCase()]);
  const hc=document.getElementById('heroCarousel');
  contentData.heroCarousel.forEach(it=>{
    const f=document.createElement('div');f.className='hero-carousel-face';
    f.innerHTML=`<img src="${it.src}" alt="${it.alt}"><div class="hero-carousel-caption">${it.caption}</div>`;
    hc.appendChild(f);
  });
  // nav
  const nav=document.getElementById('navMenu');
  contentData.chapters.forEach(ch=>{
    const a=document.createElement('a');a.href=`#${ch.id}`;a.className='nav-link';a.textContent=ch.number;
    a.onclick=()=>nav.classList.remove('open');nav.appendChild(a);
  });
  // chapters
  const cont=document.getElementById('chapters-container');
  contentData.chapters.forEach(ch=>{
    const s=document.createElement('section');s.className='chapter';s.id=ch.id;
    let h=`
      <div class="chapter-container">
        <div class="chapter-header">
          <div class="chapter-number">${ch.number}</div>
          <h2 class="chapter-title">${ch.title}</h2>
          ${ch.meta?`<div class="chapter-meta">${ch.meta}</div>`:''}
        </div>
        <div class="chapter-content">
          <div class="prose">`;
    ch.content.forEach(p=>{
      p=p.replace(/{{([^|]+)\|([^}]+)}}/g,'<span class="annotation-trigger" data-ann="$1">$2</span>');
      h+=`<p>${p}</p>`;
    });
    h+=`</div>`;
    // rail
    h+=`<div class="image-rail">`;
    (ch.images||[]).forEach(img=>{
      h+=`<div class="rail-image" onclick="openLightbox(this)">
            <img src="${img.src}" alt="${img.alt}">
            <div class="rail-image-caption">${img.caption||''}</div>
          </div>`;
    });
    h+=`</div></div></div>`;
    s.innerHTML=h;
    cont.appendChild(s);
    // annotations
    s.querySelectorAll('.annotation-trigger').forEach(tr=>{
      tr.addEventListener('click',()=>{
        const key=tr.dataset.ann,ann=(ch.annotations||{})[key];
        if(!ann)return;
        document.getElementById('ann-label').textContent=ann.label;
        document.getElementById('ann-content').textContent=ann.content;
        document.getElementById('ann-overlay').classList.add('active');
        document.getElementById('ann-modal').classList.add('active');
      });
    });
  });
  // scroll reveal
  const io=new IntersectionObserver(es=>es.forEach(e=>e.isIntersecting&&e.target.classList.add('visible')),{threshold:.1});
  document.querySelectorAll('.chapter').forEach(c=>io.observe(c));
}
function openLightbox(el){
  const img=el.querySelector('img');
  document.getElementById('lightbox-img').src=img.src;
  document.getElementById('lightbox-img').alt=img.alt;
  document.getElementById('lightbox').classList.add('active');
}
document.addEventListener('keydown',e=>{if(e.key==='Escape'){document.getElementById('lightbox').classList.remove('active');document.getElementById('ann-modal').classList.remove('active');document.getElementById('ann-overlay').classList.remove('active');}});
renderPage();
</script>

<!-- annotation modal -->
<div class="annotation-modal-overlay" id="ann-overlay" onclick="this.classList.remove('active');document.getElementById('ann-modal').classList.remove('active')"></div>
<div class="annotation-modal" id="ann-modal">
  <button class="annotation-modal-close" onclick="document.getElementById('ann-modal').classList.remove('active');document.getElementById('ann-overlay').classList.remove('active')">×</button>
  <div class="annotation-modal-label" id="ann-label"></div>
  <div class="annotation-modal-content" id="ann-content"></div>
</div>
</body>
</html>
