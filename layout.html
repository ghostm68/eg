<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Novel Viewer (Improved Scroll Handling)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; width: 100%; overflow: hidden; }
    body { font-family: "Roboto", sans-serif; }
    #content-wrapper { position: relative; height: 100%; overflow-y: scroll; background-color: rgba(248, 248, 248, 0.7); }
    #content { font-size: 18px; line-height: 1.6; padding: 20px; color: #333; }
    #background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; z-index: -1; transition: background-image 1s ease, transform 0.3s ease-out; }
    #debug { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; z-index: 1000; max-height: 300px; overflow-y: auto; width: 300px; }
    .chapter { margin-bottom: 30px; }
    h2 { font-size: 24px; margin-bottom: 15px; }
  </style>
</head>
<body>
  <div id="content-wrapper">
    <div id="background"></div>
    <div id="content">Loading content...</div>
  </div>

  <script>
    let currentImageIndex = 0;
    let imageData = [];
    let chapterTops = [];

    function log(message) {
      console.log(message);
      $('#debug').append('<p>' + message + '</p>');
      $('#debug').scrollTop($('#debug')[0].scrollHeight);
    }

    $(document).ready(function() {
      log('Document ready');

      $.ajax({
        url: "https://raw.githubusercontent.com/ghostm68/eg/refs/heads/main/your-images.json",
        dataType: "json",
        success: function(data) {
          imageData = data.filter(img => img && img.url);
          log('Image data loaded: ' + imageData.length + ' valid images');
          imageData.forEach((img, index) => {
            log(`Image ${index}: ${img.url}`);
          });
          setBackgroundImage(0);
          loadContent();
        },
        error: function(jqXHR, textStatus, errorThrown) {
          log('Error loading image data: ' + textStatus + ', ' + errorThrown);
        }
      });
    });

    function loadContent() {
      log('Loading content');
      $.ajax({
        url: 'https://raw.githubusercontent.com/ghostm68/eg/refs/heads/main/horse.txt',
        dataType: 'text',
        success: function(text) {
          log('Content loaded, length: ' + text.length);
          processContent(text);
        },
        error: function(jqXHR, textStatus, errorThrown) {
          log('Error loading content: ' + textStatus + ', ' + errorThrown);
        }
      });
    }

    function processContent(text) {
      let chapters = text.split("## ").filter(chapter => chapter.trim() !== "");
      const finalChapters = [];

      for (let i = 0; i < chapters.length; i++) {
        const chapter = chapters[i];
        const lines = chapter.split("\n");
        const heading = lines[0];

        if (heading.startsWith("Chapter") || heading.startsWith("Section")) {
          finalChapters.push(`<div class="chapter" data-image="${currentImageIndex}"><h2>${heading}</h2>${lines.slice(1).join("\n")}</div>`);
          currentImageIndex = (currentImageIndex + 1) % imageData.length;
        } else if (heading.includes("_START")) {
          const id = heading.toLowerCase().replace("_start", "").replace(/_/g, "-");
          finalChapters.push(`<div id="${id}" class="chapter" data-image="${currentImageIndex}"><h2>${heading.replace("_START", "")}</h2>${lines.slice(1).join("\n")}</div>`);
          currentImageIndex = (currentImageIndex + 1) % imageData.length;
        } else {
          finalChapters.push(`<div class="chapter" data-image="${currentImageIndex}">${chapter}</div>`);
        }
      }

      $('#content').html(finalChapters.join(''));
      log('Content processed and displayed');
      
      // Calculate chapter positions
      setTimeout(() => {
        $('.chapter').each(function(index) {
          chapterTops.push($(this).offset().top);
        });
        log(`Chapter tops calculated: ${chapterTops.length} chapters`);
        
        // Initial background set
        handleScroll();
      }, 100);
    }

    function setBackgroundImage(index) {
      if (imageData.length > 0) {
        const imageUrl = imageData[index].url;
        log('Setting background image: ' + imageUrl);
        $('#background').css('background-image', `url(${imageUrl})`);
      } else {
        log('No valid image data available');
      }
    }

    function handleScroll() {
      const scrollTop = $('#content-wrapper').scrollTop();
      const windowHeight = $(window).height();
      const documentHeight = $('#content').height();
      
      // Parallax effect
      const scrollPercentage = scrollTop / (documentHeight - windowHeight);
      const parallaxShift = scrollPercentage * 200; // Increased for more noticeable effect
      $('#background').css('transform', `translateY(-${parallaxShift}px)`);
      
      // Image alternation
      let currentChapter = chapterTops.findIndex(top => top > scrollTop + 100) - 1;
      if (currentChapter < 0) currentChapter = chapterTops.length - 1;
      const imageIndex = $('.chapter').eq(currentChapter).data('image');
      setBackgroundImage(imageIndex);
      
      log(`Scroll position: ${scrollTop}, Current chapter: ${currentChapter}, Image index: ${imageIndex}`);
    }

    $('#content-wrapper').on('scroll', _.debounce(handleScroll, 100));
  </script>
</body>
</html>
